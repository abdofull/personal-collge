<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <!-- تعريف مجموعة الأحرف -->
    <meta charset="UTF-8">
    
    <!-- إعدادات العرض لتكون متجاوبة مع جميع أحجام الشاشات -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- عنوان الصفحة -->
    <title>إدارة الميزانية - نظام المالية الشخصية</title>
    <link rel="stylesheet" href="./styles/Budget.css">
    <!-- روابط لملفات CSS الخارجية -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- مكتبة SweetAlert2 لعرض التنبيهات -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- مكتبة Chart.js للرسوم البيانية -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- مكتبة Axios للاتصال بالخادم -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    
    <!-- ملف JavaScript الخاص بالتطبيق -->
    <script src="./js/main.js"></script>
    <link rel="stylesheet" href="./styles/Budget.css">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2805599213893082"
     crossorigin="anonymous"></script>

</head>
<body>

    <!-- شريط التنقل العلوي -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <!-- عنوان التطبيق مع الأيقونة -->
            <a class="navbar-brand" href="dashboard.html">
                <i class="fas fa-wallet"></i>
                إدارة الميزانية
            </a>

            <li class="nav-item">
                <a class="nav-link" id="themeToggle" href="#">
                    <i class="fas fa-moon"></i>
                </a>
            </li>
            
            <!-- زر القائمة المنسدلة للشاشات الصغيرة -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation" style='background-color:rgb(216, 149, 149)'>
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <!-- عناصر القائمة -->
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <!-- رابط لوحة التحكم -->
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">
                            <i class="fas fa-chart-line"></i> لوحة التحكم
                        </a>
                    </li>
                    
                    <!-- رابط المعاملات -->
                    <li class="nav-item">
                        <a class="nav-link" href="Transctionshow.html">
                            <i class="fas fa-exchange-alt"></i> المعاملات
                        </a>
                    </li>
                    
                    <!-- رابط الميزانية (الصفحة الحالية) -->
                    <li class="nav-item">
                        <a class="nav-link active" href="Budget.html">
                            <i class="fas fa-wallet"></i> الميزانية
                        </a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link" href="goals.html">
                            <i class="fas fa-bullseye"></i> الخطط والأهداف
                        </a>
                    </li>
                    
                    <!-- رابط التقارير -->
                    <li class="nav-item">
                        <a class="nav-link" href="report.html">
                            <i class="fas fa-chart-line"></i> التقارير
                        </a>
                    </li>
                    
                    <!-- رابط تسجيل الخروج -->
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="logout()" style="color: var(--danger-color);">
                            <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
                        </a>
                    </li>
                </ul>
                
                <!-- قسم معلومات المستخدم -->
                <div class="d-flex align-items-center">
                    <a class="nav-link" href="profile.html">
                        <div id="user-info" class="d-flex align-items-center">
                            <div class="user-avatar">م</div>
                            <div class="user-info">
                                <span class="user-name">محمد أحمد</span>
                                <span class="user-role">مدير النظام</span>
                            </div>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- المحتوى الرئيسي -->
    <div class="content">
        <!-- عنوان الصفحة -->
        <h1 class="section-title">إدارة الميزانية</h1>
        
        <!-- نظرة عامة على الميزانية -->
        <div class="budget-overview">
            <div class="stat-card blue-card">
                <i class="fas fa-wallet icon"></i>
                <div>
                    <p class="subtitle">إجمالي الميزانيات</p>
                    <h3 id="totalBudgetsCount">0</h3>
                </div>
                <p>ميزانية مسجلة</p>
            </div>
            
            <div class="stat-card purple-card">
                <i class="fas fa-money-bill-wave icon"></i>
                <div>
                    <p class="subtitle">إجمالي الدخل المخطط</p>
                    <h3 id="totalPlannedIncome">0</h3>
                </div>
                <p>دينار</p>
            </div>
            
            <div class="stat-card green-card">
                <i class="fas fa-chart-pie icon"></i>
                <div>
                    <p class="subtitle">إجمالي المصروفات المخطط</p>
                    <h3 id="totalPlannedExpenses">0</h3>
                </div>
                <p>دينار</p>
            </div>
            
            <div class="stat-card orange-card">
                <i class="fas fa-balance-scale icon"></i>
                <div>
                    <p class="subtitle">الميزانية الحالية</p>
                    <h3 id="currentBudgetStatus">0</h3>
                </div>
                <p id="budgetStatusText">ميزانية متوازنة</p>
            </div>
        </div>
        
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="chart-container">
                    <h5 class="mb-3">توزيع المصروفات المخططة</h5>
                    <canvas id="expensesChart"></canvas>
                </div>
            </div>
            <div class="col-md-4">
                <div class="chart-container">
                    <h5 class="mb-3">الدخل والمصروفات</h5>
                    <canvas id="incomeVsExpensesChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- بطاقة إنشاء ميزانية جديدة -->
        <div class="card">
            <div class="card-body">
                <h5 class="mb-4"><i class="fas fa-plus-circle me-2"></i> إنشاء ميزانية جديدة</h5>
                
                <!-- نموذج إنشاء الميزانية -->
                <form id="budgetForm" class="form-container">
                    <div class="row g-3 mb-4">
                        <!-- حقل الشهر -->
                        <div class="col-md-6">
                            <label for="month" class="form-label">الشهر</label>
                            <select class="form-control" id="month" required>
                                <option value="">اختر الشهر</option>
                                <option value="يناير">يناير</option>
                                <option value="فبراير">فبراير</option>
                                <option value="مارس">مارس</option>
                                <option value="أبريل">أبريل</option>
                                <option value="مايو">مايو</option>
                                <option value="يونيو">يونيو</option>
                                <option value="يوليو">يوليو</option>
                                <option value="أغسطس">أغسطس</option>
                                <option value="سبتمبر">سبتمبر</option>
                                <option value="أكتوبر">أكتوبر</option>
                                <option value="نوفمبر">نوفمبر</option>
                                <option value="ديسمبر">ديسمبر</option>
                            </select>
                        </div>
                        
                        <!-- حقل السنة -->
                        <div class="col-md-6">
                            <label for="year" class="form-label">السنة</label>
                            <input type="number" class="form-control" id="year" min="2000" max="2100" required>
                        </div>
                    </div>
                    
                    <!-- حقل الإيرادات المتوقعة -->
                    <div class="mb-4">
                        <label for="totalIncome" class="form-label">الإيرادات المتوقعة</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="totalIncome" min="0" step="0.01" required oninput="updateBudgetSummary()">
                            <span class="input-group-text">دينار</span>
                        </div>
                    </div>
                    
                    <!-- ملخص الميزانية -->
                    <div class="main-progress">
                        <h5><i class="fas fa-chart-line me-2"></i> ملخص الميزانية</h5>
                        <div class="progress mb-3">
                            <div class="progress-bar bg-primary" id="budgetProgressBar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div class="progress-details">
                            <span>إجمالي المخصص: <span id="totalAllocated">0</span> دينار</span>
                            <span>المتبقي: <span id="totalRemaining">0</span> دينار</span>
                            <span>نسبة الاستخدام: <span id="usagePercentage">0%</span></span>
                        </div>
                    </div>
                    
                    <!-- بنود الميزانية -->
                    <div class="mb-4">
                        <h5 class="mb-3"><i class="fas fa-list-ul me-2"></i> بنود المصروفات</h5>
                        <div id="budgetItems">
                            <!-- سيتم إضافة بنود المصروفات هنا -->
                        </div>
                        <button type="button" id="addItem" class="add-item-btn">
                            <i class="fas fa-plus me-2"></i> إضافة بند جديد
                        </button>
                    </div>
                    
                    <!-- زر الإرسال -->
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-save me-2"></i> حفظ الميزانية
                    </button>
                </form>
            </div>
        </div>
        
        <!-- بطاقة عرض الميزانيات -->
        <div class="card">
            <div class="card-body">
                <h5 class="mb-4"><i class="fas fa-list me-2"></i> سجل الميزانيات</h5>
                
                <!-- شريط البحث والتحكم -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div class="d-flex">
                        <input type="text" class="form-control form-control-sm me-2" placeholder="بحث..." style="width: 200px;" id="budgetSearch">
                        <button class="btn btn-sm btn-outline-primary" onclick="refreshBudgets()">
                            <i class="fas fa-sync-alt me-1"></i> تحديث
                        </button>
                    </div>
                </div>
                
                <!-- جدول الميزانيات -->
                <div class="table-responsive">
                    <table class="budget-table">
                        <thead>
                            <tr>
                                <th>الشهر / السنة</th>
                                <th>الإيرادات</th>
                                <th>المصروفات</th>
                                <th>الحالة</th>
                                <th>عدد البنود</th>
                                <th>تاريخ الإنشاء</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="budgetTableBody">
                            <!-- سيتم ملء هذا الجدول بالبيانات من الخادم -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- التذييل -->
    <footer class="footer text-center py-3 mt-5" style="background-color: var(--secondary-color); color: var(--light-color);">
        <div class="container">
            <p class="mb-0">© 2025 نظام إدارة المالية الشخصية. جميع الحقوق محفوظة.</p>
        </div>
    </footer>

    <!-- مكتبات JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // متغيرات النظام
        let budgets = []; // مصفوفة لتخزين الميزانيات
        let expensesChart = null; // متغير للمخطط البياني للمصروفات
        let incomeVsExpensesChart = null; // متغير للمخطط البياني للدخل مقابل المصروفات
        
        // دالة لإضافة بند ميزانية جديد بالتصميم الجديد
        function addBudgetItem() {
            const budgetItemsContainer = document.getElementById('budgetItems');
            const itemId = Date.now(); // إنشاء معرف فريد للبند
            
            // إنشاء عنصر البند الجديد
            const newItem = document.createElement('div');
            newItem.className = 'budget-item-form';
            newItem.dataset.id = itemId;
            
            // إضافة حقول الإدخال للبند الجديد
            newItem.innerHTML = `
                <button type="button" class="delete-btn" onclick="removeBudgetItem('${itemId}')">
                    <i class="fas fa-times"></i>
                </button>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">اسم البند</label>
                        <input type="text" class="form-control item-name" required placeholder="مثال: إيجار المنزل">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">المبلغ المخصص</label>
                        <div class="input-group">
                            <input type="number" class="form-control item-amount" min="0" step="0.01" required placeholder="0.00" oninput="updateBudgetSummary()">
                            <span class="input-group-text">دينار</span>
                        </div>
                    </div>
                </div>
            `;
            
            // إضافة البند الجديد إلى الحاوية
            budgetItemsContainer.appendChild(newItem);
            
            // تحديث ملخص الميزانية
            updateBudgetSummary();
        }
        
        // دالة لإزالة بند ميزانية
        function removeBudgetItem(itemId) {
            const itemElement = document.querySelector(`.budget-item-form[data-id="${itemId}"]`);
            if (itemElement) {
                // تأثير بصري قبل الإزالة
                itemElement.style.opacity = '0';
                itemElement.style.transform = 'translateX(20px)';
                
                setTimeout(() => {
                    itemElement.remove();
                    updateBudgetSummary(); // تحديث ملخص الميزانية بعد الحذف
                }, 300);
            }
        }
        
        // دالة لتحديث ملخص الميزانية
        function updateBudgetSummary() {
            const totalIncomeEl = document.getElementById('totalIncome');
            const totalAllocatedEl = document.getElementById('totalAllocated');
            const totalRemainingEl = document.getElementById('totalRemaining');
            const usagePercentageEl = document.getElementById('usagePercentage');
            const progressBar = document.getElementById('budgetProgressBar');
            
            const totalIncome = parseFloat(totalIncomeEl.value) || 0;
            
            let totalAllocated = 0;
            
            document.querySelectorAll('.item-amount').forEach(amountInput => {
                const amount = parseFloat(amountInput.value) || 0;
                totalAllocated += amount;
            });
            
            const remaining = totalIncome - totalAllocated;
            const usagePercentage = totalIncome > 0 ? (totalAllocated / totalIncome) * 100 : 0;
            
            // تحديث النصوص
            totalAllocatedEl.textContent = totalAllocated.toFixed(2);
            totalRemainingEl.textContent = remaining.toFixed(2);
            usagePercentageEl.textContent = usagePercentage.toFixed(0) + '%';
            
            // تحديث شريط التقدم
            progressBar.style.width = usagePercentage + '%';
            
            // تغيير لون شريط التقدم بناءً على النسبة
            if (usagePercentage > 95) {
                progressBar.className = 'progress-bar bg-danger';
            } else if (usagePercentage > 80) {
                progressBar.className = 'progress-bar bg-warning';
            } else {
                progressBar.className = 'progress-bar bg-primary';
            }
        }
        
        
        
        // دالة لجلب الميزانيات من الخادم
        async function fetchBudgets() {
            const userId = localStorage.getItem('userId');
            if (!userId) {
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ',
                    text: 'يجب تسجيل الدخول أولاً',
                    customClass: {
                        popup: 'rtl-popup'
                    }
                }).then(() => {
                    window.location.href = 'index.html';
                });
                return;
            }

            try {
                // عرض تحميل أثناء جلب البيانات
                Swal.fire({
                    title: 'جاري تحميل البيانات...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    },
                    customClass: {
                        popup: 'rtl-popup'
                    }
                });

                const response = await axios.get(`${url}api/budgets?userId=${userId}`);
                
                // التأكد من صيغة البيانات الصحيحة
                budgets = Array.isArray(response.data) ? response.data : 
                         response.data.budgets ? response.data.budgets : 
                         response.data.data ? response.data.data : [];
                
                // إخفاء تحميل بعد جلب البيانات
                Swal.close();
                
                // عرض الميزانيات في الجدول
                displayBudgets();
                
                // تحديث الإحصائيات والمخططات البيانية
                updateStatistics();
                createCharts();
                
            } catch (error) {
                console.error('حدث خطأ أثناء جلب الميزانيات:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ',
                    text: 'فشل جلب الميزانيات. يرجى المحاولة لاحقًا.',
                    customClass: {
                        popup: 'rtl-popup'
                    }
                });
                
                // تهيئة budgets كمصفوفة فارغة في حالة الخطأ
                budgets = [];
                displayBudgets();
            }
        }

        // دالة لتحديث الإحصائيات
        function updateStatistics() {
            let totalPlannedIncome = 0;
            let totalPlannedExpenses = 0;
            
            budgets.forEach(budget => {
                totalPlannedIncome += budget.totalIncome || 0;
                totalPlannedExpenses += budget.totalExpenses || 0;
            });
            
            // تحديث الإحصائيات في الواجهة
            document.getElementById('totalBudgetsCount').textContent = budgets.length;
            document.getElementById('totalPlannedIncome').textContent = totalPlannedIncome.toFixed(2);
            document.getElementById('totalPlannedExpenses').textContent = totalPlannedExpenses.toFixed(2);
            
            const currentBudgetStatus = totalPlannedIncome - totalPlannedExpenses;
            document.getElementById('currentBudgetStatus').textContent = Math.abs(currentBudgetStatus).toFixed(2);
            
            // تعيين نص حالة الميزانية
            const statusEl = document.getElementById('budgetStatusText');
            if (currentBudgetStatus > 0) {
                statusEl.textContent = 'فائض في الميزانية';
                statusEl.className = 'text-success';
            } else if (currentBudgetStatus < 0) {
                statusEl.textContent = 'عجز في الميزانية';
                statusEl.className = 'text-danger';
            } else {
                statusEl.textContent = 'ميزانية متوازنة';
                statusEl.className = '';
            }
        }

        // دالة لإنشاء المخططات البيانية
        function createCharts() {
            // الحصول على سياق الرسم للمخططات
            const expensesCtx = document.getElementById('expensesChart').getContext('2d');
            const incomeVsExpensesCtx = document.getElementById('incomeVsExpensesChart').getContext('2d');
            
            // بيانات مجمعة للمخططات
            let labels = [];
            let allocatedData = [];
            let incomeData = [];
            let expensesData = [];
            
            // البنود الأكثر شيوعًا للمصروفات
            const itemCategories = {};
            
            // تجميع البيانات من الميزانيات
            budgets.forEach(budget => {
                // حفظ بيانات للميزانية الحالية
                labels.push(`${budget.month} ${budget.year}`);
                incomeData.push(budget.totalIncome || 0);
                expensesData.push(budget.totalExpenses || 0);
                
                // تجميع بيانات البنود
                if (budget.items && Array.isArray(budget.items)) {
                    budget.items.forEach(item => {
                        if (item.itemName in itemCategories) {
                            itemCategories[item.itemName] += item.allocatedAmount || 0;
                        } else {
                            itemCategories[item.itemName] = item.allocatedAmount || 0;
                        }
                    });
                }
            });
            
            // إعداد بيانات مخطط المصروفات
            const categoryLabels = Object.keys(itemCategories);
            const categoryData = Object.values(itemCategories);
            
            // ألوان عشوائية للمخطط الدائري
            const categoryColors = generateRandomColors(categoryLabels.length);
            
            // إنشاء مخطط المصروفات (دائري)
            if (expensesChart) expensesChart.destroy();
            expensesChart = new Chart(expensesCtx, {
                type: 'doughnut',
                data: {
                    labels: categoryLabels,
                    datasets: [{
                        data: categoryData,
                        backgroundColor: categoryColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: getTextColor() // دالة لتحديد لون النص بناءً على وضع العرض
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total ? ((value / total) * 100).toFixed(0) + '%' : '0%';
                                    return `${label}: ${value.toFixed(2)} (${percentage})`;
                                }
                            }
                        }
                    }
                }
            });
            
            // إنشاء مخطط الدخل مقابل المصروفات (عمودي)
            if (incomeVsExpensesChart) incomeVsExpensesChart.destroy();
            incomeVsExpensesChart = new Chart(incomeVsExpensesCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'الدخل',
                            data: incomeData,
                            backgroundColor: 'rgba(93, 92, 222, 0.7)',
                            borderColor: 'rgba(93, 92, 222, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'المصروفات',
                            data: expensesData,
                            backgroundColor: 'rgba(255, 99, 132, 0.7)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            ticks: {
                                color: getTextColor()
                            },
                            grid: {
                                color: getGridColor()
                            }
                        },
                        x: {
                            ticks: {
                                color: getTextColor()
                            },
                            grid: {
                                color: getGridColor()
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: getTextColor()
                            }
                        }
                    }
                }
            });
        }
        
        // دالة لعرض الميزانيات في الجدول المحسن
        function displayBudgets() {
            const tableBody = document.getElementById('budgetTableBody');
            tableBody.innerHTML = '';
            
            // التأكد من أن budgets هي مصفوفة قبل استخدام forEach
            if (!Array.isArray(budgets)) {
                console.error('المتغير budgets ليس مصفوفة:', budgets);
                budgets = [];
            }
            
            // إذا لم تكن هناك ميزانيات
            if (budgets.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="7" class="text-center py-4">لا توجد ميزانيات مسجلة</td>
                `;
                tableBody.appendChild(row);
                return;
            }
            
            // عرض كل ميزانية في الجدول
            budgets.forEach(budget => {
                // التأكد من وجود الخصائص الأساسية
                const month = budget.month || 'غير محدد';
                const year = budget.year || 'غير محدد';
                const totalIncome = budget.totalIncome ? budget.totalIncome.toFixed(2) : '0.00';
                const totalExpenses = budget.totalExpenses ? budget.totalExpenses.toFixed(2) : '0.00';
                const itemsCount = budget.items ? budget.items.length : 0;
                const createdAt = budget.createdAt ? new Date(budget.createdAt).toLocaleDateString('ar-EG') : 'غير معروف';
                
                // حساب الفرق بين الدخل والمصروفات
                const difference = (budget.totalIncome || 0) - (budget.totalExpenses || 0);
                let statusBadge;
                
                if (difference > 0) {
                    statusBadge = `<span class="badge bg-success">فائض: ${difference.toFixed(2)} دينار</span>`;
                } else if (difference < 0) {
                    statusBadge = `<span class="badge bg-danger">عجز: ${Math.abs(difference).toFixed(2)} دينار</span>`;
                } else {
                    statusBadge = `<span class="badge bg-info">متوازنة</span>`;
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><span class="fw-bold">${month}</span> / ${year}</td>
                    <td>${totalIncome} <small>دينار</small></td>
                    <td>${totalExpenses} <small>دينار</small></td>
                    <td>${statusBadge}</td>
                    <td><span class="budget-badge bg-light text-dark">${itemsCount}</span></td>
                    <td>${createdAt}</td>
                    <td>
                        <button onclick="viewBudget('${budget._id}')" class="budget-action-btn view-btn">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button onclick="confirmDeleteBudget('${budget._id}')" class="budget-action-btn delete-btn">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // دالة لعرض تفاصيل الميزانية بطريقة محسنة
        async function viewBudget(budgetId) {
            try {
                const budget = budgets.find(b => b._id === budgetId);
                if (!budget) return;
                
                // تكوين بيانات المخطط الدائري
                const labels = budget.items.map(item => item.itemName);
                const allocations = budget.items.map(item => item.allocatedAmount);
                const spent = budget.items.map(item => item.spentAmount || 0);
                
                // ألوان للمخطط الدائري
                const chartColors = generateRandomColors(labels.length);
                
                // إنشاء محتوى بطاقات تفاصيل البنود
                let itemsContent = '';
                budget.items.forEach(item => {
                    const spentAmount = item.spentAmount || 0;
                    const remaining = item.allocatedAmount - spentAmount;
                    const usagePercent = (spentAmount / item.allocatedAmount * 100) || 0;
                    
                    let statusClass = 'good';
                    let statusText = 'في الحدود';
                    let badgeClass = 'bg-success';
                    
                    if (usagePercent > 80 && usagePercent < 100) {
                        statusClass = 'warning';
                        statusText = 'قارب على الانتهاء';
                        badgeClass = 'bg-warning text-dark';
                    } else if (usagePercent >= 100) {
                        statusClass = 'danger';
                        statusText = 'تجاوز الميزانية';
                        badgeClass = 'bg-danger';
                    }
                    
                    itemsContent += `
                        <div class="budget-view-item ${statusClass}">
                            <div class="item-header">
                                <div class="item-name">${item.itemName}</div>
                                <span class="item-status ${badgeClass}">${statusText}</span>
                            </div>
                            <div class="progress mb-2">
                                <div class="progress-bar ${badgeClass}" style="width: ${Math.min(usagePercent, 100)}%"></div>
                            </div>
                            <div class="item-details d-flex justify-content-between">
                                <div>المخصص: <span class="fw-bold">${item.allocatedAmount.toFixed(2)} دينار</span></div>
                                <div>المصروف الفعلي: <span class="fw-bold">${spentAmount.toFixed(2)} دينار</span></div>
                                <div>المتبقي: <span class="fw-bold ${remaining < 0 ? 'text-danger' : ''}">${remaining.toFixed(2)} دينار</span></div>
                            </div>
                        </div>
                    `;
                });
                
                // إنشاء محتوى كامل للتفاصيل
                const content = `
                    <div class="container-fluid budget-details-custom">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <h5 class="text-gradient">تفاصيل الميزانية</h5>
                                    <p><i class="fas fa-calendar me-2"></i> ${budget.month} - ${budget.year}</p>
                                    <div class="d-flex justify-content-between mb-2">
                                        <div>الإيرادات المتوقعة:</div>
                                        <div><span class="fw-bold">${budget.totalIncome.toFixed(2)}</span> دينار</div>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <div>إجمالي المصروفات المخططة:</div>
                                        <div><span class="fw-bold">${budget.totalExpenses.toFixed(2)}</span> دينار</div>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <div>الفرق:</div>
                                        <div class="${budget.totalIncome - budget.totalExpenses >= 0 ? 'text-success' : 'text-danger'}">
                                            <span class="fw-bold">${(budget.totalIncome - budget.totalExpenses).toFixed(2)}</span> دينار
                                        </div>
                                    </div>
                                </div>
                                <div style="height: 200px;">
                                    <canvas id="budgetDetailsChart"></canvas>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="main-progress mb-4">
                                    <h5><i class="fas fa-chart-line me-2" style='color:#CD7F32'></i> ملخص الصرف</h5>
                                    <div class="progress mb-2">
                                        <div class="progress-bar ${budget.totalExpenses > budget.totalIncome ? 'bg-danger' : 'bg-primary'}" 
                                            style="width: ${Math.min((budget.totalExpenses / budget.totalIncome) * 100, 100)}%"></div>
                                    </div>
                                    <div class="progress-details">
                                        <span style='color:#CD7F32'>إجمالي المخصص: <span>${budget.totalExpenses.toFixed(2)}</span> دينار</span>
                                        <span style='color:#CD7F32'>نسبة من الدخل: <span>${(budget.totalExpenses / budget.totalIncome * 100).toFixed(0)}%</span></span>
                                    </div>
                                </div>
                                <div style="height: 200px;">
                                    <canvas id="budgetAllocationsChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <h5 class="mb-3"><i class="fas fa-list-ul me-2"></i> بنود الميزانية</h5>
                                ${itemsContent}
                            </div>
                        </div>
                    </div>
                `;
                
                // عرض التفاصيل في نافذة SweetAlert
                Swal.fire({
                    title: 'تفاصيل الميزانية',
                    html: content,
                    width: '900px',
                    showCloseButton: true,
                    showConfirmButton: false,
                    customClass: {
                        popup: 'rtl-popup'
                    },
                    didOpen: () => {
                        // إنشاء المخطط الدائري للتخصيصات
                        const allocationsCtx = document.getElementById('budgetAllocationsChart').getContext('2d');
                        new Chart(allocationsCtx, {
                            type: 'doughnut',
                            data: {
                                labels: labels,
                                datasets: [{
                                    data: allocations,
                                    backgroundColor: chartColors,
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'bottom',
                                        labels: {
                                            color: getTextColor()
                                        }
                                    },
                                    title: {
                                        display: true,
                                        text: 'توزيع الميزانية',
                                        color: getTextColor()
                                    }
                                }
                            }
                        });
                        
                        // إنشاء مخطط شريطي للمخطط والمنفق
                        const detailsCtx = document.getElementById('budgetDetailsChart').getContext('2d');
                        new Chart(detailsCtx, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [
                                    {
                                        label: 'المخصص',
                                        data: allocations,
                                        backgroundColor: 'rgba(93, 92, 222, 0.7)',
                                        borderColor: 'rgba(93, 92, 222, 1)',
                                        borderWidth: 1
                                    },
                                    {
                                        label: 'المصروف الفعلي',
                                        data: spent,
                                        backgroundColor: 'rgba(255, 99, 132, 0.7)',
                                        borderColor: 'rgba(255, 99, 132, 1)',
                                        borderWidth: 1
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        ticks: {
                                            color: getTextColor()
                                        },
                                        grid: {
                                            color: getGridColor()
                                        }
                                    },
                                    x: {
                                        ticks: {
                                            color: getTextColor()
                                        },
                                        grid: {
                                            color: getGridColor()
                                        }
                                    }
                                },
                                plugins: {
                                    legend: {
                                        labels: {
                                            color: getTextColor()
                                        }
                                    },
                                    title: {
                                        display: true,
                                        text: 'المخصص مقابل المصروف الفعلي',
                                        color: getTextColor()
                                    }
                                }
                            }
                        });
                    }
                });
            } catch (error) {
                console.error('حدث خطأ أثناء عرض تفاصيل الميزانية:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ',
                    text: 'فشل عرض تفاصيل الميزانية. يرجى المحاولة لاحقًا.',
                    customClass: {
                        popup: 'rtl-popup'
                    }
                });
            }
        }
        
        // دالة لتأكيد حذف الميزانية
        async function confirmDeleteBudget(budgetId) {
            const result = await Swal.fire({
                title: 'هل أنت متأكد؟',
                text: 'لن تتمكن من استعادة هذه الميزانية بعد الحذف!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'نعم، احذفها',
                cancelButtonText: 'إلغاء',
                customClass: {
                    popup: 'rtl-popup'
                }
            });
            
            if (result.isConfirmed) {
                await deleteBudget(budgetId);
            }
        }
        
        // دالة لحذف الميزانية
        async function deleteBudget(budgetId) {
            try {
                // عرض تحميل أثناء حذف الميزانية
                Swal.fire({
                    title: 'جاري حذف الميزانية...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    },
                    customClass: {
                        popup: 'rtl-popup'
                    }
                });
                
                const response = await axios.delete(`${url}api/budgets/${budgetId}`);
                Swal.fire({
                    icon: 'success',
                    title: 'نجاح',
                    text: 'تم حذف الميزانية بنجاح!',
                    customClass: {
                        popup: 'rtl-popup'
                    }
                }).then(() => {
                    fetchBudgets(); // إعادة تحميل الميزانيات بعد الحذف
                });
            } catch (error) {
                console.error('حدث خطأ أثناء حذف الميزانية:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ',
                    text: 'فشل حذف الميزانية. يرجى المحاولة لاحقًا.',
                    customClass: {
                        popup: 'rtl-popup'
                    }
                });
            }
        }
        
        // دالة لتحديث قائمة الميزانيات
        function refreshBudgets() {
            fetchBudgets();
        }
        
        // دالة لإرسال نموذج إنشاء ميزانية جديدة
        async function handleBudgetSubmit(event) {
            event.preventDefault();
            
            // جمع بيانات النموذج
            const month = document.getElementById('month').value;
            const year = document.getElementById('year').value;
            const totalIncome = parseFloat(document.getElementById('totalIncome').value);
            
            // جمع بنود الميزانية
            const items = [];
            const itemElements = document.querySelectorAll('.budget-item-form');
            
            itemElements.forEach(item => {
                const name = item.querySelector('.item-name').value;
                const amount = parseFloat(item.querySelector('.item-amount').value);
                
                if (name && !isNaN(amount)) {
                    items.push({
                        itemName: name,
                        allocatedAmount: amount,
                        spentAmount: 0
                    });
                }
            });
            
            // حساب إجمالي المصروفات
            const totalExpenses = items.reduce((sum, item) => sum + item.allocatedAmount, 0);
            
            // التحقق من صحة البيانات
            if (!month || !year || isNaN(totalIncome) || items.length === 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ',
                    text: 'يرجى ملء جميع الحقول المطلوبة وإضافة بنود للميزانية',
                    customClass: {
                        popup: 'rtl-popup'
                    }
                });
                return;
            }
            
            // التحقق من أن الإيرادات كافية للمصروفات
            if (totalIncome < totalExpenses) {
                const result = await Swal.fire({
                    icon: 'warning',
                    title: 'تحذير',
                    text: 'إجمالي المصروفات أكبر من الإيرادات المتوقعة! هل تريد الاستمرار؟',
                    showCancelButton: true,
                    confirmButtonText: 'نعم، استمر',
                    cancelButtonText: 'إلغاء',
                    customClass: {
                        popup: 'rtl-popup'
                    }
                });
                
                if (!result.isConfirmed) {
                    return;
                }
            }
            
            try {
                const userId = localStorage.getItem('userId');
                
                // عرض تحميل أثناء الإرسال
                Swal.fire({
                    title: 'جاري حفظ الميزانية...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    },
                    customClass: {
                        popup: 'rtl-popup'
                    }
                });
                
                // إرسال البيانات إلى الخادم
                const response = await axios.post(`${url}api/budgets`, {
                    userId: userId,
                    month: month,
                    year: year,
                    totalIncome: totalIncome,
                    totalExpenses: totalExpenses,
                    items: items
                });
                
                // إخفاء تحميل بعد الإرسال
                Swal.close();
                
                // عرض رسالة نجاح مع تأثيرات
                Swal.fire({
                    icon: 'success',
                    title: 'تم بنجاح!',
                    text: 'تم حفظ الميزانية بنجاح!',
                    showConfirmButton: false,
                    timer: 2000,
                    customClass: {
                        popup: 'rtl-popup'
                    }
                }).then(() => {
                    // إعادة تعيين النموذج وتحديث الجدول
                    document.getElementById('budgetForm').reset();
                    document.getElementById('budgetItems').innerHTML = '';
                    updateBudgetSummary(); // تحديث ملخص الميزانية
                    fetchBudgets(); // إعادة تحميل الميزانيات
                });
            } catch (error) {
                console.error('حدث خطأ أثناء حفظ الميزانية:', error);
                
                let errorMessage = 'فشل حفظ الميزانية. يرجى المحاولة لاحقًا.';
                
                // محاولة استخراج رسالة الخطأ من استجابة الخادم
                if (error.response && error.response.data && error.response.data.message) {
                    errorMessage = error.response.data.message;
                }
                
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ',
                    text: errorMessage,
                    customClass: {
                        popup: 'rtl-popup'
                    }
                });
            }
        }
        
        // دالة لإنشاء ألوان عشوائية للمخططات البيانية
        function generateRandomColors(count) {
            const colors = [];
            const baseColors = [
                'rgba(93, 92, 222, 0.7)',
                'rgba(255, 99, 132, 0.7)',
                'rgba(54, 162, 235, 0.7)',
                'rgba(255, 206, 86, 0.7)',
                'rgba(75, 192, 192, 0.7)',
                'rgba(153, 102, 255, 0.7)',
                'rgba(255, 159, 64, 0.7)',
                'rgba(45, 200, 117, 0.7)'
            ];
            
            // استخدام الألوان الأساسية أولاً
            for (let i = 0; i < count; i++) {
                if (i < baseColors.length) {
                    colors.push(baseColors[i]);
                } else {
                    // إنشاء لون عشوائي إذا نفدت الألوان الأساسية
                    const r = Math.floor(Math.random() * 200) + 55;
                    const g = Math.floor(Math.random() * 200) + 55;
                    const b = Math.floor(Math.random() * 200) + 55;
                    colors.push(`rgba(${r}, ${g}, ${b}, 0.7)`);
                }
            }
            
            return colors;
        }
        
        // دالة لتحديد لون النص بناء على وضع العرض (ليلي/نهاري)
        function getTextColor() {
            return document.body.classList.contains('light-mode') ? '#333' : '#eaeaea';
        }
        
        // دالة لتحديد لون الشبكة بناء على وضع العرض
        function getGridColor() {
            return document.body.classList.contains('light-mode') ? 'rgba(0, 0, 0, 0.1)' : 'rgba(255, 255, 255, 0.1)';
        }
        
        // دالة للتبديل بين الأوضاع الليلي والنهاري
        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            
            // تحديث المخططات لتتناسب مع الوضع الجديد
            createCharts();
        }
        
        // تهيئة الصفحة عند التحميل
        document.addEventListener('DOMContentLoaded', function() {
            // تعيين السنة الحالية كقيمة افتراضية
            document.getElementById('year').value = new Date().getFullYear();
            
            // إضافة مستمع حدث لزر إضافة بند جديد
            document.getElementById('addItem').addEventListener('click', function() {
                addBudgetItem();
                // إضافة تأثير تحريك للتمرير إلى نهاية القائمة
                setTimeout(() => {
                    window.scrollTo({
                        top: document.body.scrollHeight,
                        behavior: 'smooth'
                    });
                }, 100);
            });
    
            // إضافة مستمع حدث للبحث في جدول الميزانيات
            document.getElementById('budgetSearch').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const rows = document.querySelectorAll('#budgetTableBody tr');
                
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            });
            
            // // إضافة مستمع حدث لزر تبديل الوضع
            // document.getElementById('themeToggle').addEventListener('click', function(e) {
            //     e.preventDefault();
            //     toggleTheme();
            // });
            
            // إضافة مستمع حدث لنموذج الميزانية
            document.getElementById('budgetForm').addEventListener('submit', handleBudgetSubmit);
            
            // جلب بيانات المستخدم والميزانيات
            fetchUserData();
            fetchBudgets();
            
            // إضافة أول بند افتراضي
            addBudgetItem();
        });
    </script>
</body>
</html>