<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <!-- تعريف مجموعة الأحرف والإعدادات الأساسية -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- عنوان الصفحة -->
    <title>إدارة المعاملات - نظام المالية الشخصية</title>
    
    <!-- روابط المكتبات والأنماط الخارجية -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- مكتبات جافاسكريبت أساسية -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="./js/main.js"></script>
    <link rel="stylesheet" href="./styles/main.css">

    <link rel="stylesheet" href="./styles/Transctionshow.css">

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2805599213893082"
     crossorigin="anonymous"></script>

</head>
<body>
    <!-- شريط التنقل العلوي -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <!-- عنوان التطبيق مع الأيقونة -->
            <a class="navbar-brand" href="dashboard.html">
              <i class="fas fa-exchange-alt"></i>         
                إدارة المعاملات
            </a>

            <li class="nav-item">
                <a class="nav-link" id="themeToggle" href="#">
                    <i class="fas fa-moon"></i>
                </a>
            </li>
            
            <!-- زر القائمة المنسدلة للشاشات الصغيرة -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation" style='background-color:rgb(216, 149, 149)'>
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <!-- عناصر القائمة -->
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <!-- رابط لوحة التحكم -->
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">
                            <i class="fas fa-chart-line"></i> لوحة التحكم
                        </a>
                    </li>
                    
                    <!-- رابط المعاملات -->
                    <li class="nav-item">
                        <a class="nav-link active" href="Transctionshow.html">
                            <i class="fas fa-exchange-alt"></i> المعاملات
                        </a>
                    </li>
                    
                    <!-- رابط الميزانية (الصفحة الحالية) -->
                    <li class="nav-item">
                        <a class="nav-link" href="Budget.html">
                            <i class="fas fa-wallet"></i> الميزانية
                        </a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link" href="goals.html">
                            <i class="fas fa-bullseye"></i> الخطط والأهداف
                        </a>
                    </li>
                    
                    <!-- رابط التقارير -->
                    <li class="nav-item">
                        <a class="nav-link" href="report.html">
                            <i class="fas fa-chart-line"></i> التقارير
                        </a>
                    </li>

                    
                    <!-- رابط تسجيل الخروج -->
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="logout()" style="color: var(--danger-color);">
                            <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
                        </a>
                    </li>
                </ul>
                
                <!-- قسم معلومات المستخدم -->
                <div class="d-flex align-items-center">
                    <a class="nav-link" href="profile.html">
                        <div id="user-info" class="d-flex align-items-center">
                            <div class="user-avatar">م</div>
                            <div class="user-info">
                                <span class="user-name">محمد أحمد</span>
                                <span class="user-role">مدير النظام</span>
                            </div>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- المحتوى الرئيسي للصفحة -->
    <div class="content">
        <!-- عنوان الصفحة وزر إضافة معاملة -->
        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
            <h1 class="section-title mb-3 mb-md-0">إدارة المعاملات</h1>
            <div>
                <button class="btn btn-primary" onclick="window.location.href='add-transaction.html'">
                    <i class="fas fa-plus me-2"></i> إضافة معاملة جديدة
                </button>
            </div>
        </div>

        <!-- بطاقة المعاملات -->
        <div class="card">
            <!-- عنوان البطاقة وأدوات التصفية -->
            <div class="filter-container mb-4">
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
                    <h5 class="card-title mb-0">سجل المعاملات</h5>
                    <div class="d-flex flex-column flex-md-row gap-2 w-100 w-md-auto">
                        <!-- قائمة تصفية النوع -->
                        <div class="filter-item">
                            <label for="filterType" class="filter-label d-block">نوع المعاملة</label>
                            <select class="form-select" id="filterType">
                                <option value="all">جميع الأنواع</option>
                                <option value="income">دخل</option>
                                <option value="expense">مصروف</option>
                            </select>
                        </div>
                        
                        <!-- قائمة تصفية التاريخ -->
                        <div class="filter-item">
                            <label for="filterDate" class="filter-label d-block">الفترة الزمنية</label>
                            <select class="form-select" id="filterDate">
                                <option value="all">جميع الفترات</option>
                                <option value="today">اليوم</option>
                                <option value="week">هذا الأسبوع</option>
                                <option value="month">هذا الشهر</option>
                                <option value="year">هذه السنة</option>
                            </select>
                        </div>
                        
                        <!-- حقل البحث -->
                        <div class="filter-item">
                            <label for="transactionSearch" class="filter-label d-block">بحث</label>
                            <div class="d-flex">
                                <input type="text" class="form-control" id="transactionSearch" placeholder="اكتب للبحث...">
                                <button class="btn btn-outline-primary ms-2" onclick="refreshTransactions()">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- نتائج عدد المعاملات ومجموع الدخل والمصروفات -->
            <div class="summary-stats mb-4">
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="p-3 rounded" style="background-color: rgba(93, 92, 222, 0.1); border-right: 4px solid var(--primary-color);">
                            <div class="d-flex align-items-center">
                                <div class="me-3 p-2 rounded-circle" style="background-color: rgba(93, 92, 222, 0.2);">
                                    <i class="fas fa-list" style="color: var(--primary-color);"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0">إجمالي المعاملات</h6>
                                    <h4 class="mb-0" id="totalTransactions">0</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="p-3 rounded" style="background-color: rgba(40, 167, 69, 0.1); border-right: 4px solid var(--success-color);">
                            <div class="d-flex align-items-center">
                                <div class="me-3 p-2 rounded-circle" style="background-color: rgba(40, 167, 69, 0.2);">
                                    <i class="fas fa-arrow-circle-down" style="color: var(--success-color);"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0">إجمالي الدخل</h6>
                                    <h4 class="mb-0" id="totalIncome">0.00 دينار</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="p-3 rounded" style="background-color: rgba(220, 53, 69, 0.1); border-right: 4px solid var(--danger-color);">
                            <div class="d-flex align-items-center">
                                <div class="me-3 p-2 rounded-circle" style="background-color: rgba(220, 53, 69, 0.2);">
                                    <i class="fas fa-arrow-circle-up" style="color: var(--danger-color);"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0">إجمالي المصروفات</h6>
                                    <h4 class="mb-0" id="totalExpenses">0.00 دينار</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- حاوية الجدول -->
            <div class="table-container">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>الفئة</th>
                                <th>المبلغ</th>
                                <th>النوع</th>
                                <th>التاريخ</th>
                                <th>الوصف</th>
                                <th>الميزانية</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsTable">
                            <!-- سيتم ملء هذا الجدول بالبيانات من الخادم -->
                            <tr id="loading-row">
                                <td colspan="7" class="text-center py-4">
                                    <div class="d-flex flex-column align-items-center">
                                        <div class="spinner-border text-primary mb-2" role="status">
                                            <span class="visually-hidden">جاري التحميل...</span>
                                        </div>
                                        <span>جاري تحميل المعاملات...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- أزرار التنقل بين الصفحات -->
            <div class="d-flex justify-content-between align-items-center mt-4 pagination-controls">
                <div>
                    <span id="currentPage">الصفحة 1</span>
                </div>
                <div>
                    <button class="btn btn-sm btn-outline-primary me-2" id="prevPage" disabled>
                        <i class="fas fa-chevron-right me-1"></i> السابق
                    </button>
                    <button class="btn btn-sm btn-outline-primary" id="nextPage" disabled>
                        التالي <i class="fas fa-chevron-left ms-1"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- تذييل الصفحة -->
    <footer class="footer text-center py-3">
        <div class="container">
            <p class="mb-0">© 2025 نظام إدارة المالية الشخصية. جميع الحقوق محفوظة.</p>
        </div>
    </footer>

    <!-- مكتبات جافاسكريبت -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        /*============================
          المتغيرات العامة
        ============================*/
        // متغيرات التصفح والتصفية
        let currentPage = 1;
        const transactionsPerPage = 10;
        let allTransactions = [];
        let filteredTransactions = [];
        
        // عنوان API الخادم - في الإنتاج يجب تحديد هذا في ملف منفصل

        
        /*============================
          دوال مساعدة
        ============================*/
        /**
         * التحقق من وجود المستخدم وجلب معلوماته
         */
        // async function fetchUserData() {
        //     const userId = localStorage.getItem('userId');
        //     const token = localStorage.getItem('token');
            
        //     if (!userId || !token) {
        //         redirectToLogin();
        //         return;
        //     }
            
        //     try {
        //         const response = await axios.get(`${url}api/users/${userId}`, {
        //             headers: {
        //                 'Authorization': `Bearer ${token}`
        //             }
        //         });
                
        //         if (response.data && response.data.user) {
        //             updateUserInfo(response.data.user);
        //         }
        //     } catch (error) {
        //         console.error('خطأ في جلب بيانات المستخدم:', error);
        //         if (error.response && (error.response.status === 401 || error.response.status === 403)) {
        //             showNotification('error', 'انتهت صلاحية الجلسة', 'يرجى تسجيل الدخول مرة أخرى');
        //             setTimeout(redirectToLogin, 2000);
        //         }
        //     }
        // }
        
        /**
         * تحديث معلومات المستخدم في واجهة المستخدم
         * @param {Object} user - بيانات المستخدم
         */
        // function updateUserInfo(user) {
        //     if (!user) return;
            
        //     const userInfoElement = document.getElementById('user-info');
        //     if (!userInfoElement) return;
            
        //     const avatarElement = userInfoElement.querySelector('.user-avatar');
        //     const nameElement = userInfoElement.querySelector('.user-name');
        //     const roleElement = userInfoElement.querySelector('.user-role');
            
        //     if (avatarElement && user.name) {
        //         const initials = user.name.split(' ')
        //             .map(part => part.charAt(0))
        //             .slice(0, 2)
        //             .join('');
        //         avatarElement.textContent = initials;
        //     }
            
        //     if (nameElement && user.name) {
        //         nameElement.textContent = user.name;
        //     }
            
        //     if (roleElement && user.role) {
        //         const roleName = user.role === 'admin' ? 'مدير النظام' : 'مستخدم';
        //         roleElement.textContent = roleName;
        //     }
        // }
        
        /**
         * إعادة توجيه المستخدم إلى صفحة تسجيل الدخول
         */
        function redirectToLogin() {
            localStorage.removeItem('userId');
            localStorage.removeItem('token');
            window.location.href = 'index.html';
        }
        
        /**
         * عرض إشعار للمستخدم باستخدام SweetAlert
         * @param {string} icon - نوع الإشعار (success, error, warning, info)
         * @param {string} title - عنوان الإشعار
         * @param {string} text - نص الإشعار
         */
        function showNotification(icon, title, text) {
            Swal.fire({
                icon: icon,
                title: title,
                text: text,
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true,
                customClass: {
                    popup: 'rtl-popup'
                }
            });
        }
        
        /**
         * تنسيق المبلغ بتنسيق العملة
         * @param {number} amount - المبلغ المراد تنسيقه
         * @returns {string} المبلغ منسقاً
         */
        function formatCurrency(amount) {
            return parseFloat(amount).toFixed(2) + ' دينار';
        }
        
        /**
         * تنسيق التاريخ بتنسيق محلي
         * @param {string} dateStr - التاريخ بتنسيق ISO
         * @returns {string} التاريخ منسقاً
         */
        function formatDate(dateStr) {
            try {
                return new Date(dateStr).toLocaleDateString('ar-EG', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            } catch (e) {
                return dateStr || '—';
            }
        }
        

        
        /**
         * التحقق من المظهر المفضل للمستخدم واستعادة إعدادات المظهر المحفوظة
         */
        function checkPreferredTheme() {
            const savedTheme = localStorage.getItem('theme');
            
            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
                document.querySelector('#themeToggle i').className = 'fas fa-sun';
            } else if (savedTheme === 'dark') {
                document.body.classList.remove('light-mode');
                document.querySelector('#themeToggle i').className = 'fas fa-moon';
            } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.remove('light-mode');
                document.querySelector('#themeToggle i').className = 'fas fa-moon';
            } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) {
                document.body.classList.add('light-mode');
                document.querySelector('#themeToggle i').className = 'fas fa-sun';
            }
            
            // إضافة مستمع لتغيير المظهر المفضل
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (!localStorage.getItem('theme')) {
                    if (event.matches) {
                        document.body.classList.remove('light-mode');
                        document.querySelector('#themeToggle i').className = 'fas fa-moon';
                    } else {
                        document.body.classList.add('light-mode');
                        document.querySelector('#themeToggle i').className = 'fas fa-sun';
                    }
                }
            });
        }
        
        /*============================
          دوال معالجة المعاملات
        ============================*/
        /**
         * جلب المعاملات من الخادم
         */
        async function fetchTransactions() {
            const userId = localStorage.getItem('userId');
            const token = localStorage.getItem('token');
            
            if (!userId || !token) {
                redirectToLogin();
                return;
            }

            try {
                showLoading(true);

                // جلب البيانات من الخادم
                const response = await axios.get(`${url}api/transactions?userId=${userId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                console.log(response)
                
                // تخزين البيانات
                allTransactions = Array.isArray(response.data) ? response.data : 
                                (response.data.transactions || []);
                
                // تطبيق الفلترة وعرض النتائج
                applyFilters();
                updateTransactionStats();
                showLoading(false);
                
                // عرض إشعار نجاح
                showNotification('success', 'تم بنجاح', 'تم تحميل المعاملات بنجاح');
            } catch (error) {
                console.error('خطأ في جلب المعاملات:', error);
                showLoading(false);
                
                // عرض رسالة خطأ
                let errorMessage = 'حدث خطأ أثناء جلب المعاملات. يرجى المحاولة مرة أخرى.';
                
                if (error.response) {
                    if (error.response.status === 401 || error.response.status === 403) {
                        showNotification('error', 'خطأ في المصادقة', 'يرجى تسجيل الدخول مرة أخرى');
                        setTimeout(redirectToLogin, 2000);
                        return;
                    } else if (error.response.data && error.response.data.message) {
                        errorMessage = error.response.data.message;
                    }
                }
                
                showEmptyState('خطأ في تحميل البيانات', errorMessage, 'error');
            }
        }
        
        /**
         * تطبيق الفلاتر على المعاملات
         */
        function applyFilters() {
            const searchTerm = document.getElementById('transactionSearch').value.toLowerCase().trim();
            const filterType = document.getElementById('filterType').value;
            const filterDate = document.getElementById('filterDate').value;
            
            // فلترة المعاملات حسب المعايير المختارة
            filteredTransactions = allTransactions.filter(transaction => {
                // فلترة حسب النص المدخل
                const matchesSearch = !searchTerm || 
                    transaction.category?.toLowerCase().includes(searchTerm) ||
                    transaction.description?.toLowerCase().includes(searchTerm) ||
                    transaction.amount?.toString().includes(searchTerm) ||
                    transaction.budgetItemName?.toLowerCase().includes(searchTerm);
                
                // فلترة حسب نوع المعاملة
                const matchesType = filterType === 'all' || transaction.type === filterType;
                
                // فلترة حسب الفترة الزمنية
                let matchesDate = true;
                if (filterDate !== 'all') {
                    const txDate = new Date(transaction.date);
                    const now = new Date();
                    
                    if (filterDate === 'today') {
                        // اليوم فقط
                        matchesDate = txDate.toDateString() === now.toDateString();
                    } else if (filterDate === 'week') {
                        // هذا الأسبوع
                        const firstDay = new Date(now.setDate(now.getDate() - now.getDay()));
                        const lastDay = new Date(new Date(firstDay).setDate(firstDay.getDate() + 6));
                        matchesDate = txDate >= firstDay && txDate <= lastDay;
                    } else if (filterDate === 'month') {
                        // هذا الشهر
                        matchesDate = txDate.getMonth() === now.getMonth() && 
                                    txDate.getFullYear() === now.getFullYear();
                    } else if (filterDate === 'year') {
                        // هذه السنة
                        matchesDate = txDate.getFullYear() === now.getFullYear();
                    }
                }
                
                return matchesSearch && matchesType && matchesDate;
            });
            
            // ترتيب المعاملات من الأحدث للأقدم
            filteredTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // إعادة تعيين الصفحة الحالية إلى 1 عند تطبيق الفلتر
            currentPage = 1;
            
            // تحديث البيانات المعروضة
            updatePagination();
            displayTransactions(currentPage);
            updateTransactionStats();
        }
        
        /**
         * تحديث إحصائيات المعاملات المعروضة
         */
        function updateTransactionStats() {
            const totalElement = document.getElementById('totalTransactions');
            const incomeElement = document.getElementById('totalIncome');
            const expensesElement = document.getElementById('totalExpenses');
            
            if (!totalElement || !incomeElement || !expensesElement) return;
            
            // عدد المعاملات
            totalElement.textContent = filteredTransactions.length;
            
            // حساب المجاميع
            const totals = filteredTransactions.reduce((acc, transaction) => {
                if (transaction.type === 'income') {
                    acc.income += transaction.amount || 0;
                } else if (transaction.type === 'expense') {
                    acc.expense += transaction.amount || 0;
                }
                return acc;
            }, { income: 0, expense: 0 });
            
            // عرض المجاميع بتنسيق مناسب
            incomeElement.textContent = formatCurrency(totals.income);
            expensesElement.textContent = formatCurrency(totals.expense);
        }
        
        /**
         * عرض المعاملات في الجدول
         * @param {number} page - رقم الصفحة المراد عرضها
         */
        function displayTransactions(page) {
            const tableBody = document.getElementById('transactionsTable');
            if (!tableBody) return;
            
            // تنظيف الجدول
            tableBody.innerHTML = '';
            
            // حساب المعاملات التي سيتم عرضها في الصفحة الحالية
            const startIndex = (page - 1) * transactionsPerPage;
            const endIndex = Math.min(startIndex + transactionsPerPage, filteredTransactions.length);
            const paginatedTransactions = filteredTransactions.slice(startIndex, endIndex);
            
            // إذا لم توجد معاملات، عرض رسالة
            if (paginatedTransactions.length === 0) {
                showEmptyState('لا توجد معاملات', 'لم يتم العثور على معاملات تطابق معايير البحث.');
                return;
            }
            
            // إنشاء صفوف الجدول للمعاملات
            paginatedTransactions.forEach(transaction => {
                const row = document.createElement('tr');
                
                // تحضير معلومات الميزانية إذا كانت موجودة
                let budgetInfo = '—';
                if (transaction.budgetId && transaction.budgetItemName) {
                    budgetInfo = `<span class="budget-badge">${escapeHTML(transaction.budgetItemName)}</span>`;
                }
                
                // تعيين أنماط مختلفة حسب نوع المعاملة
                const typeStyle = transaction.type === 'income' ? 
                    { badge: 'bg-success', icon: 'fa-arrow-circle-down' } : 
                    { badge: 'bg-danger', icon: 'fa-arrow-circle-up' };
                
                // إنشاء محتوى الصف
                row.innerHTML = `
                    <td>
                        <div class="d-flex align-items-center">
                            <i class="fas fa-tag me-2" style="color: var(--primary-color);"></i>
                            ${escapeHTML(transaction.category) || '—'}
                        </div>
                    </td>
                    <td>
                        <span class="fw-semibold">${formatCurrency(transaction.amount)}</span>
                    </td>
                    <td>
                        <span class="badge ${typeStyle.badge}">
                            <i class="fas ${typeStyle.icon} me-1"></i>
                            ${transaction.type === 'income' ? 'دخل' : 'مصروف'}
                        </span>
                    </td>
                    <td>${formatDate(transaction.date)}</td>
                    <td class="text-truncate" style="max-width: 200px;">${escapeHTML(transaction.description) || '—'}</td>
                    <td>${budgetInfo}</td>
                    <td>
                        <div class="action-buttons d-flex gap-1">
                            <button onclick="viewTransaction('${transaction._id}')" class="btn btn-sm btn-outline-primary" title="عرض المعاملة">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="editTransaction('${transaction._id}')" class="btn btn-sm btn-outline-primary" title="تعديل المعاملة">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="confirmDeleteTransaction('${transaction._id}')" class="btn btn-sm btn-danger" title="حذف المعاملة">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        /**
         * تأمين النص لمنع هجمات XSS
         * @param {string} text - النص المراد تأمينه
         * @returns {string} النص المؤمن
         */
        function escapeHTML(text) {
            if (!text) return '';
            return String(text)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }
        
        /**
         * إظهار حالة التحميل
         * @param {boolean} isLoading - حالة التحميل
         */
        function showLoading(isLoading) {
            const tableBody = document.getElementById('transactionsTable');
            if (!tableBody) return;
            
            if (isLoading) {
                tableBody.innerHTML = `
                    <tr id="loading-row">
                        <td colspan="7" class="text-center py-4">
                            <div class="d-flex flex-column align-items-center">
                                <div class="spinner-border text-primary mb-2" role="status">
                                    <span class="visually-hidden">جاري التحميل...</span>
                                </div>
                                <span>جاري تحميل المعاملات...</span>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }
        
        /**
         * إظهار حالة فارغة عند عدم وجود معاملات
         * @param {string} title - عنوان الحالة
         * @param {string} message - رسالة توضيحية
         * @param {string} type - نوع الحالة (error, warning, empty)
         */
        function showEmptyState(title, message, type = 'empty') {
            const tableBody = document.getElementById('transactionsTable');
            if (!tableBody) return;
            
            // اختيار أيقونة مناسبة حسب النوع
            let icon = 'fa-info-circle text-info';
            if (type === 'error') {
                icon = 'fa-exclamation-circle text-danger';
            } else if (type === 'warning') {
                icon = 'fa-exclamation-triangle text-warning';
            } else if (type === 'empty') {
                icon = 'fa-inbox text-muted';
            }
            
            tableBody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-5">
                        <div class="empty-state">
                            <i class="fas ${icon} fa-3x mb-3"></i>
                            <h5>${title}</h5>
                            <p class="text-muted">${message}</p>
                            ${type !== 'error' ? '<button class="btn btn-sm btn-primary mt-3" onclick="refreshTransactions()">تحديث البيانات</button>' : ''}
                        </div>
                    </td>
                </tr>
            `;
        }
        
        /**
         * تحديث أزرار التنقل بين الصفحات
         */
        function updatePagination() {
            const totalPages = Math.ceil(filteredTransactions.length / transactionsPerPage) || 1;
            
            document.getElementById('currentPage').textContent = 
                `الصفحة ${currentPage} من ${totalPages}`;
            
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage === totalPages;
        }
        
        /**
         * الانتقال إلى الصفحة السابقة
         */
        function goToPrevPage() {
            if (currentPage > 1) {
                currentPage--;
                displayTransactions(currentPage);
                updatePagination();
                
                // التمرير لأعلى الجدول
                document.querySelector('.table-container').scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        /**
         * الانتقال إلى الصفحة التالية
         */
        function goToNextPage() {
            const totalPages = Math.ceil(filteredTransactions.length / transactionsPerPage) || 1;
            
            if (currentPage < totalPages) {
                currentPage++;
                displayTransactions(currentPage);
                updatePagination();
                
                // التمرير لأعلى الجدول
                document.querySelector('.table-container').scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        /**
         * تحديث قائمة المعاملات
         */
        function refreshTransactions() {
            fetchTransactions();
        }
        
        /*============================
          دوال إدارة المعاملات
        ============================*/
        /**
         * عرض تفاصيل المعاملة
         * @param {string} transactionId - معرف المعاملة
         */
        function viewTransaction(transactionId) {
            window.location.href = `transaction-details.html?id=${transactionId}`;
        }
        
        /**
         * تعديل معاملة
         * @param {string} transactionId - معرف المعاملة
         */
        async function editTransaction(transactionId) {
            try {
                // جلب بيانات المعاملة الحالية
                const token = localStorage.getItem('token');
                const response = await axios.get(`${url}api/transactions/single/${transactionId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const transaction = response.data.transaction || response.data;
                
                // إنشاء نموذج التعديل باستخدام SweetAlert
                const { value: formValues } = await Swal.fire({
                    title: 'تعديل المعاملة',
                    html: `
                        <div class="mb-3 text-start">
                            <label class="form-label d-block">نوع المعاملة</label>
                            <div class="d-flex gap-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="editType" id="editIncome" 
                                        value="income" ${transaction.type === 'income' ? 'checked' : ''}>
                                    <label class="form-check-label" for="editIncome">دخل</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="editType" id="editExpense" 
                                        value="expense" ${transaction.type === 'expense' ? 'checked' : ''}>
                                    <label class="form-check-label" for="editExpense">مصروف</label>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3 text-start">
                            <label for="editCategory" class="form-label">الفئة</label>
                            <input id="editCategory" class="form-control" value="${transaction.category || ''}" placeholder="أدخل الفئة">
                        </div>
                        <div class="mb-3 text-start">
                            <label for="editAmount" class="form-label">المبلغ</label>
                            <input type="number" id="editAmount" class="form-control" value="${transaction.amount || 0}" placeholder="أدخل المبلغ" min="0" step="0.01">
                        </div>
                        <div class="mb-3 text-start">
                            <label for="editDate" class="form-label">التاريخ</label>
                            <input type="date" id="editDate" class="form-control" 
                                value="${transaction.date ? new Date(transaction.date).toISOString().split('T')[0] : new Date().toISOString().split('T')[0]}">
                        </div>
                        <div class="mb-3 text-start">
                            <label for="editDescription" class="form-label">الوصف (اختياري)</label>
                            <textarea id="editDescription" class="form-control" placeholder="أدخل وصفاً للمعاملة">${transaction.description || ''}</textarea>
                        </div>
                    `,
                    focusConfirm: false,
                    showCancelButton: true,
                    confirmButtonText: 'حفظ التعديلات',
                    cancelButtonText: 'إلغاء',
                    buttonsStyling: true,
                    customClass: {
                        confirmButton: 'btn btn-primary',
                        cancelButton: 'btn btn-danger',
                        popup: 'rtl-popup'
                    },
                    preConfirm: () => {
                        // التحقق من صحة المدخلات
                        const category = document.getElementById('editCategory').value.trim();
                        const amount = parseFloat(document.getElementById('editAmount').value);
                        
                        if (!category) {
                            Swal.showValidationMessage('يجب إدخال الفئة');
                            return false;
                        }
                        
                        if (isNaN(amount) || amount <= 0) {
                            Swal.showValidationMessage('يجب إدخال مبلغ صحيح أكبر من الصفر');
                            return false;
                        }
                        
                        // إرجاع البيانات المدخلة
                        return {
                            type: document.querySelector('input[name="editType"]:checked').value,
                            category: category,
                            amount: amount,
                            date: document.getElementById('editDate').value,
                            description: document.getElementById('editDescription').value.trim() || null
                        };
                    }
                });

                if (formValues) {
                    // إظهار حالة التحميل
                    Swal.fire({
                        title: 'جاري حفظ التعديلات...',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        },
                        customClass: {
                            popup: 'rtl-popup'
                        }
                    });
                    
                    // إرسال التعديلات إلى الخادم
                    await axios.put(`${url}api/transactions/${transactionId}`, formValues, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    // عرض رسالة نجاح وتحديث البيانات
                    Swal.fire({
                        icon: 'success',
                        title: 'تم التعديل بنجاح',
                        text: 'تم تحديث بيانات المعاملة بنجاح',
                        customClass: {
                            popup: 'rtl-popup'
                        }
                    }).then(() => {
                        refreshTransactions();
                    });
                }
            } catch (error) {
                console.error('خطأ في تعديل المعاملة:', error);
                
                // عرض رسالة خطأ
                let errorMessage = 'حدث خطأ أثناء تعديل المعاملة. يرجى المحاولة مرة أخرى.';
                
                if (error.response && error.response.data && error.response.data.message) {
                    errorMessage = error.response.data.message;
                }
                
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ',
                    text: errorMessage,
                    customClass: {
                        popup: 'rtl-popup'
                    }
                });
            }
        }
        
        /**
         * تأكيد حذف معاملة
         * @param {string} transactionId - معرف المعاملة
         */
        async function confirmDeleteTransaction(transactionId) {
            const result = await Swal.fire({
                title: 'هل أنت متأكد؟',
                text: 'لن تتمكن من استعادة هذه المعاملة بعد الحذف!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'نعم، احذفها',
                cancelButtonText: 'إلغاء',
                customClass: {
                    confirmButton: 'btn btn-danger mx-2',
                    cancelButton: 'btn btn-secondary mx-2',
                    popup: 'rtl-popup'
                },
                buttonsStyling: false,
                reverseButtons: true
            });
            
            if (result.isConfirmed) {
                await deleteTransaction(transactionId);
            }
        }
        
        /**
         * حذف معاملة
         * @param {string} transactionId - معرف المعاملة
         */
        async function deleteTransaction(transactionId) {
            try {
                // إظهار حالة التحميل
                Swal.fire({
                    title: 'جاري حذف المعاملة...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    },
                    customClass: {
                        popup: 'rtl-popup'
                    }
                });
                
                // إرسال طلب الحذف
                const token = localStorage.getItem('token');
                await axios.delete(`${url}api/transactions/${transactionId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                // عرض رسالة نجاح وتحديث البيانات
                Swal.fire({
                    icon: 'success',
                    title: 'تم الحذف',
                    text: 'تم حذف المعاملة بنجاح',
                    customClass: {
                        popup: 'rtl-popup'
                    }
                }).then(() => {
                    refreshTransactions();
                });
            } catch (error) {
                console.error('خطأ في حذف المعاملة:', error);
                
                // عرض رسالة خطأ
                let errorMessage = 'حدث خطأ أثناء حذف المعاملة. يرجى المحاولة مرة أخرى.';
                
                if (error.response && error.response.data && error.response.data.message) {
                    errorMessage = error.response.data.message;
                }
                
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ',
                    text: errorMessage,
                    customClass: {
                        popup: 'rtl-popup'
                    }
                });
            }
        }
        
        

        /*============================
          تهيئة الصفحة عند التحميل
        ============================*/
        document.addEventListener('DOMContentLoaded', function() {
            // تهيئة الموضوع المفضل
            checkPreferredTheme();
            
            
            // جلب بيانات المستخدم والمعاملات
            fetchUserData();
            fetchTransactions();
            
            // إضافة مستمعات الأحداث
            document.getElementById('transactionSearch').addEventListener('input', function() {
                applyFilters();
            });
            
            document.getElementById('filterType').addEventListener('change', function() {
                applyFilters();
            });
            
            document.getElementById('filterDate').addEventListener('change', function() {
                applyFilters();
            });
            
            document.getElementById('prevPage').addEventListener('click', goToPrevPage);
            document.getElementById('nextPage').addEventListener('click', goToNextPage);
        });
    </script>
</body>
</html>