<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <!-- معلومات الصفحة الأساسية -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https:; img-src 'self' data: https:; font-src 'self' https: data:;"> -->
    
    <title>التقارير والتحليلات - المحاسب الشخصي</title>
    
    <!-- المكتبات والأنماط -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./styles/main.css">
    
    <!-- السكريبتات -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="./js/main.js"></script>
    
    
    <style>
        /* استيراد الخطوط */
        @font-face {
            font-family: 'Amiri';
            src: url('https://cdn.jsdelivr.net/npm/amiri-font@1.0.0/amiri-regular.ttf') format('truetype');
        }
        
        /* متغيرات CSS */
        :root {
            --primary-color: #5D5CDE;
            --primary-dark: #4847B3;
            --primary-light: #8A89FF;
            --secondary-color: #2BD2FF;
            --accent-color: #22c55e;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --info-color: #3b82f6;
            
            --bg-dark: #1c1f2b;
            --card-dark: #2a2f40;
            --text-dark: #eaeaea;
            --text-muted-dark: #aaaaaa;
            
            --bg-light: #f8f9fa;
            --card-light: #ffffff;
            --text-light: #333333;
            --text-muted-light: #6c757d;
            
            --shadow-dark: 0 8px 20px rgba(0, 0, 0, 0.3);
            --shadow-light: 0 8px 20px rgba(0, 0, 0, 0.1);
            
            --transition-speed: 0.3s;
        }
        
        /* أنماط عامة */
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-dark);
            margin: 0;
            padding: 0;
            color: var(--text-dark);
            transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
        }
        
        /* شريط التنقل */
        .navbar {
            background-color: var(--card-dark);
            padding: 1rem;
            box-shadow: var(--shadow-dark);
            transition: all var(--transition-speed) ease;
        }
        
        .navbar-brand {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
            transition: color var(--transition-speed) ease;
        }
        
        .navbar-nav .nav-link {
            color: var(--text-dark);
            font-size: 1rem;
            margin-right: 1rem;
            padding: 0.5rem 0.8rem;
            border-radius: 8px;
            transition: all var(--transition-speed) ease;
        }
        
        .navbar-nav .nav-link:hover {
            color: var(--primary-color);
            background-color: rgba(93, 92, 222, 0.1);
            transform: translateY(-2px);
        }
        
        /* حاوية المحتوى */
        .content {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* البطاقات */
        .card {
            border: none;
            border-radius: 16px;
            padding: 1.5rem;
            background: var(--card-dark);
            box-shadow: var(--shadow-dark);
            transition: all var(--transition-speed) ease;
            color: var(--text-dark);
            margin-bottom: 1.5rem;
            position: relative;
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(93, 92, 222, 0.15);
        }
        
        .card .icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: var(--primary-color);
            transition: all var(--transition-speed) ease;
        }
        
        .card-title {
            font-weight: 700;
            margin-bottom: 1rem;
            font-size: 1.3rem;
            color: var(--text-dark);
        }
        
        .card-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
        }
        
        .card-subtitle {
            font-size: 0.9rem;
            color: var(--text-muted-dark);
        }
        
        /* خلفية زخرفية للبطاقات */
        .card-decoration {
            position: absolute;
            bottom: -20px;
            right: -20px;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background-color: rgba(93, 92, 222, 0.15);
            z-index: 0;
        }
        
        /* حاويات الرسوم البيانية */
        .chart-container {
            margin-top: 2rem;
            padding: 2rem;
            background: var(--card-dark);
            border-radius: 16px;
            box-shadow: var(--shadow-dark);
            color: var(--text-dark);
            transition: all var(--transition-speed) ease;
            position: relative;
        }
        
        .chart-container:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(93, 92, 222, 0.15);
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .chart-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin: 0;
        }
        
        .chart-filters {
            display: flex;
            gap: 10px;
        }
        
        .chart-filter {
            padding: 0.3rem 0.8rem;
            border-radius: 30px;
            background-color: rgba(93, 92, 222, 0.1);
            color: var(--text-dark);
            border: none;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .chart-filter.active, .chart-filter:hover {
            background-color: var(--primary-color);
            color: white;
        }
        
        /* الجداول */
        .table-container {
            margin-top: 2rem;
            background: var(--card-dark);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow-dark);
            transition: all var(--transition-speed) ease;
        }
        
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .table-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin: 0;
        }
        
        .table {
            margin-bottom: 0;
            color: var(--text-dark);
        }
        
        .table thead {
            background: linear-gradient(90deg, var(--primary-color), var(--primary-dark));
            color: white;
        }
        
        .table th, .table td {
            text-align: center;
            padding: 1rem;
            font-size: 0.95rem;
            vertical-align: middle;
            border-color: rgba(255, 255, 255, 0.1);
        }
        
        .table tbody tr {
            transition: background-color var(--transition-speed) ease;
        }
        
        .table tbody tr:hover {
            background-color: rgba(93, 92, 222, 0.05);
        }
        
        .table .income {
            color: var(--accent-color);
            font-weight: 600;
        }
        
        .table .expense {
            color: var(--danger-color);
            font-weight: 600;
        }
        
        /* قسم التوقعات والتحليل الذكي */
        .ai-prediction-card {
            background-image: linear-gradient(135deg, var(--card-dark), rgba(42, 47, 64, 0.9));
            position: relative;
        }
        
        .ai-indicator {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background-color: rgba(93, 92, 222, 0.2);
            color: var(--primary-light);
            padding: 0.3rem 0.7rem;
            border-radius: 30px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .ai-indicator i {
            font-size: 0.9rem;
        }
        
        .prediction-chart-container {
            height: 300px;
            margin-top: 1rem;
        }
        
        .ai-insights {
            background-color: rgba(93, 92, 222, 0.1);
            border-radius: 12px;
            padding: 1.2rem;
            margin-top: 1.5rem;
            border-right: 4px solid var(--primary-color);
        }
        
        .ai-insights-title {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 0.8rem;
            color: var(--primary-light);
        }
        
        .ai-insights ul {
            margin-bottom: 0;
            padding-right: 1.2rem;
        }
        
        .ai-insights li {
            margin-bottom: 0.5rem;
            line-height: 1.6;
        }
        
        /* أزرار التصدير */
        .export-buttons {
            margin-top: 1rem;
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }
        
        .btn-export {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 8px;
            background-color: var(--primary-color);
            color: #fff;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-export:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        .btn-export:active {
            transform: translateY(0);
        }
        
        /* المؤشرات */
        .badge {
            padding: 0.4rem 0.8rem;
            border-radius: 30px;
            font-weight: 500;
        }
        
        .badge-positive {
            background-color: rgba(34, 197, 94, 0.2);
            color: var(--accent-color);
        }
        
        .badge-negative {
            background-color: rgba(239, 68, 68, 0.2);
            color: var(--danger-color);
        }
        
        .badge-neutral {
            background-color: rgba(59, 130, 246, 0.2);
            color: var(--info-color);
        }
        
        /* شريط التقدم */
        .progress {
            height: 8px;
            border-radius: 4px;
            background-color: rgba(255, 255, 255, 0.1);
            margin-top: 8px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        
        .progress-bar {
            border-radius: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
        }
        
        /* التذييل */
        .footer {
            text-align: center;
            margin-top: 2rem;
            padding: 1.5rem;
            background: var(--card-dark);
            color: var(--text-dark);
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            transition: all var(--transition-speed) ease;
        }
        
        /* القوائم العمودية (للخلاصة) */
        .stat-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stat-item:last-child {
            border-bottom: none;
        }
        
        .stat-label {
            color: var(--text-muted-dark);
        }
        
        .stat-value {
            font-weight: 600;
        }
        
        /* مؤشر الصحة المالية */
        .financial-health {
            position: relative;
            width: 100%;
            height: 10px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            margin-top: 20px;
            margin-bottom: 10px;
            overflow: hidden;
        }
        
        .financial-health-bar {
            height: 100%;
            border-radius: 5px;
            transition: width var(--transition-speed) ease;
        }
        
        .financial-health-label {
            text-align: center;
            font-size: 0.9rem;
            margin-top: 5px;
            color: var(--text-muted-dark);
        }
        
        /* زر تبديل السمة */
        #themeToggle {
            position: relative;
            padding-left: 40px;
        }
        
        #themeToggle i {
            position: absolute;
            right: 10px;
            top: 50%;
            font-size: 1.3rem;
            margin-right: 5px;
            transform: translateY(-50%);
            transition: all var(--transition-speed) ease;
        }
        
        /* أنماط السكيلتون للتحميل */
        .skeleton {
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.05) 25%, rgba(255, 255, 255, 0.1) 50%, rgba(255, 255, 255, 0.05) 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 8px;
        }
        
        @keyframes skeleton-loading {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }
        
        .skeleton-text {
            height: 16px;
            margin-bottom: 8px;
            width: 100%;
        }
        
        .skeleton-title {
            height: 24px;
            margin-bottom: 16px;
            width: 50%;
        }
        
        /* أنماط الوضع النهاري */
        body.light-mode {
            background-color: var(--bg-light);
            color: var(--text-light);
        }
        
        .light-mode .navbar {
            background-color: var(--card-light);
            box-shadow: var(--shadow-light);
        }
        
        .light-mode .navbar-nav .nav-link {
            color: var(--text-light);
        }
        
        .light-mode .navbar-nav .nav-link:hover {
            color: var(--primary-color);
        }
        
        .light-mode .card {
            background: var(--card-light);
            color: var(--text-light);
            box-shadow: var(--shadow-light);
        }
        
        .light-mode .chart-container,
        .light-mode .table-container {
            background: var(--card-light);
            box-shadow: var(--shadow-light);
            color: var(--text-light);
        }
        
        .light-mode .table {
            color: var(--text-light);
        }
        
        .light-mode .table tbody tr:hover {
            background-color: rgba(93, 92, 222, 0.05);
        }
        
        .light-mode .footer {
            background: var(--card-light);
            color: var(--text-light);
        }
        
        .light-mode .stat-item {
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .light-mode .stat-label {
            color: var(--text-muted-light);
        }
        
        .light-mode .financial-health {
            background-color: rgba(0, 0, 0, 0.1);
        }
        
        .light-mode .financial-health-label {
            color: var(--text-muted-light);
        }
        
        .light-mode #themeToggle i {
            transform: translateY(-50%) rotate(180deg);
            color: var(--primary-color);
        }
        
        .light-mode .card-subtitle {
            color: var(--text-muted-light);
        }
        
        .light-mode .ai-prediction-card {
            background-image: linear-gradient(135deg, var(--card-light), rgba(255, 255, 255, 0.9));
        }
        
        .light-mode .ai-insights {
            background-color: rgba(93, 92, 222, 0.05);
        }
        
        .light-mode .skeleton {
            background: linear-gradient(90deg, rgba(0, 0, 0, 0.05) 25%, rgba(0, 0, 0, 0.1) 50%, rgba(0, 0, 0, 0.05) 75%);
        }
        
        /* تصميم متجاوب للشاشات الصغيرة */
        @media (max-width: 992px) {
            .stats-row {
                flex-direction: column;
            }
            
            .chart-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .chart-filters {
                flex-wrap: wrap;
            }
        }
        
        @media (max-width: 768px) {
            .navbar-nav .nav-link {
                margin-right: 0;
                margin-bottom: 5px;
            }
            
            .content {
                padding: 1rem;
            }
            
            .card, .chart-container, .table-container {
                padding: 1rem;
            }
            
            .table-header {
                padding: 1rem;
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .export-buttons {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .table-responsive {
                font-size: 0.8rem;
            }
            
            .table th, .table td {
                padding: 0.75rem 0.5rem;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>

    <!-- شريط التنقل العلوي -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <!-- عنوان التطبيق مع الأيقونة -->
            <a class="navbar-brand" href="dashboard.html">
                <i class="fas fa-file-alt"></i>
                إدارة التقارير
            </a>

            <li class="nav-item" style="margin-right: 15px;">
                <a class="nav-link" id="themeToggle" href="#">
                    <i class="fas fa-moon"></i>
                </a>
            </li>
            
            <!-- زر القائمة المنسدلة للشاشات الصغيرة -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation" style='background-color:rgb(216, 149, 149)'>
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <!-- عناصر القائمة -->
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <!-- رابط لوحة التحكم -->
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">
                            <i class="fas fa-chart-line"></i> لوحة التحكم
                        </a>
                    </li>
                    
                    <!-- رابط المعاملات -->
                    <li class="nav-item">
                        <a class="nav-link" href="Transctionshow.html">
                            <i class="fas fa-exchange-alt"></i> المعاملات
                        </a>
                    </li>
                    
                    <!-- رابط الميزانية (الصفحة الحالية) -->
                    <li class="nav-item">
                        <a class="nav-link" href="Budget.html">
                            <i class="fas fa-wallet"></i> الميزانية
                        </a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link" href="goals.html">
                            <i class="fas fa-bullseye"></i> الخطط والأهداف
                        </a>
                    </li>
                    
                    <!-- رابط التقارير -->
                    <li class="nav-item">
                        <a class="nav-link active" href="report.html">
                            <i class="fas fa-chart-line"></i> التقارير
                        </a>
                    </li>

                    
                    <!-- رابط تسجيل الخروج -->
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="logout()" style="color: var(--danger-color);">
                            <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
                        </a>
                    </li>
                </ul>
                
                <!-- قسم معلومات المستخدم -->
                <div class="d-flex align-items-center">
                    <a class="nav-link" href="profile.html">
                        <div id="user-info" class="d-flex align-items-center">
                            <div class="user-avatar">م</div>
                            <div class="user-info">
                                <span class="user-name">محمد أحمد</span>
                                <span class="user-role">مدير النظام</span>
                            </div>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- المحتوى الرئيسي -->
    <div class="content">
        <!-- عنوان الصفحة وأزرار التصدير -->
        <div class="d-flex justify-content-between align-items-center flex-wrap mb-4">
            <h1>التقارير والتحليلات المالية</h1>
            
            <div class="export-buttons">
                <button class="btn-export" onclick="exportToPDF()">
                    <i class="fas fa-file-pdf"></i> تصدير إلى PDF
                </button>
                <button class="btn-export" onclick="exportToExcel()">
                    <i class="fas fa-file-excel"></i> تصدير إلى Excel
                </button>
            </div>
        </div>
        
        <!-- بطاقات الإحصائيات العامة -->
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4 mb-4 stats-row">
            <div class="col">
                <div class="card text-center h-100" id="totalIncomeCard">
                    <div class="card-decoration"></div>
                    <i class="fas fa-money-bill-wave icon"></i>
                    <h5 class="card-title">إجمالي الدخل</h5>
                    <div id="totalIncome" class="card-value">0 دينار</div>
                    <div id="incomeChange" class="card-subtitle">
                        <span id="incomeChangeValue" class="badge badge-positive">0%</span>
                        مقارنة بالشهر السابق
                    </div>
                </div>
            </div>
            
            <div class="col">
                <div class="card text-center h-100" id="totalExpensesCard">
                    <div class="card-decoration"></div>
                    <i class="fas fa-shopping-cart icon"></i>
                    <h5 class="card-title">إجمالي المصروفات</h5>
                    <div id="totalExpenses" class="card-value">0 دينار</div>
                    <div id="expensesChange" class="card-subtitle">
                        <span id="expensesChangeValue" class="badge badge-negative">0%</span>
                        مقارنة بالشهر السابق
                    </div>
                </div>
            </div>
            
            <div class="col">
                <div class="card text-center h-100" id="savingsCard">
                    <div class="card-decoration"></div>
                    <i class="fas fa-piggy-bank icon"></i>
                    <h5 class="card-title">الادخار</h5>
                    <div id="totalSavings" class="card-value">0 دينار</div>
                    <div id="savingsChange" class="card-subtitle">
                        <span id="savingsChangeValue" class="badge badge-positive">0%</span>
                        من إجمالي الدخل
                    </div>
                </div>
            </div>
            
            <div class="col">
                <div class="card text-center h-100" id="financialHealthCard">
                    <div class="card-decoration"></div>
                    <i class="fas fa-heart icon"></i>
                    <h5 class="card-title">الصحة المالية</h5>
                    <div id="financialHealthScore" class="card-value">0%</div>
                    <div class="financial-health">
                        <div id="financialHealthBar" class="financial-health-bar" style="width: 0%; background: linear-gradient(90deg, #ef4444, #f59e0b, #22c55e);"></div>
                    </div>
                    <div class="financial-health-label" id="financialHealthLabel">قم بإدخال بيانات أكثر لتقييم صحتك المالية</div>
                </div>
            </div>
        </div>
        
        <!-- قسم التحليل الذكي (AI) -->
        <div class="card ai-prediction-card mb-4">
            <div class="ai-indicator">
                <i class="fas fa-robot"></i> مدعوم بالذكاء الاصطناعي
            </div>
            
            <h4 class="mb-4">تحليل وتوقعات</h4>
            
            <div class="row">
                <div class="col-lg-8">
                    <div id="predictionChartContainer" class="prediction-chart-container">
                        <canvas id="predictionChart"></canvas>
                    </div>
                </div>
                
                <div class="col-lg-4">
                    <div class="ai-insights">
                        <div class="ai-insights-title">
                            <i class="fas fa-lightbulb"></i> التحليلات والتوصيات
                        </div>
                        <ul id="aiInsightsList">
                            <li class="skeleton skeleton-text"></li>
                            <li class="skeleton skeleton-text"></li>
                            <li class="skeleton skeleton-text"></li>
                            <li class="skeleton skeleton-text"></li>
                        </ul>
                    </div>
                    
                    <div class="mt-4">
                        <h6 class="mb-3">التوزيع المثالي للنفقات</h6>
                        <div class="d-flex justify-content-between align-items-center">
                            <small>الضروريات (50%)</small>
                            <small id="necessitiesPercentage">0%</small>
                        </div>
                        <div class="progress">
                            <div id="necessitiesProgress" class="progress-bar" style="width: 0%"></div>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center">
                            <small>الرغبات (30%)</small>
                            <small id="wantsPercentage">0%</small>
                        </div>
                        <div class="progress">
                            <div id="wantsProgress" class="progress-bar" style="width: 0%"></div>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center">
                            <small>الادخار (20%)</small>
                            <small id="savingsPercentage">0%</small>
                        </div>
                        <div class="progress">
                            <div id="savingsProgress" class="progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- حاوية الرسم البياني الخطي -->
        <div class="chart-container mb-4">
            <div class="chart-header">
                <h4 class="chart-title">تحليل المصروفات والدخل</h4>
                <div class="chart-filters" id="timeFrameFilters">
                    <button class="chart-filter active" data-period="week">أسبوع</button>
                    <button class="chart-filter" data-period="month">شهر</button>
                    <button class="chart-filter" data-period="quarter">ربع سنة</button>
                    <button class="chart-filter" data-period="year">سنة</button>
                </div>
            </div>
            <canvas id="lineChart"></canvas>
        </div>
        
        <!-- حاوية الرسم البياني الدائري -->
        <div class="row">
            <div class="col-lg-6">
                <div class="chart-container h-100">
                    <h4 class="mb-3">توزيع المصروفات حسب الفئة</h4>
                    <canvas id="expensesPieChart"></canvas>
                </div>
            </div>
            
            <div class="col-lg-6">
                <div class="chart-container h-100">
                    <h4 class="mb-3">توزيع الدخل حسب المصدر</h4>
                    <canvas id="incomePieChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- حاوية جدول التفاصيل المالية -->
        <div class="table-container mt-4">
            <div class="table-header">
                <h4 class="table-title">التفاصيل المالية</h4>
                <div class="d-flex align-items-center gap-2">
                    <div class="input-group">
                        <input type="text" id="searchTransactions" class="form-control" placeholder="بحث في المعاملات..." style="background-color: var(--card-dark); color: var(--text-dark); border: 1px solid rgba(255, 255, 255, 0.1);">
                        <button class="btn" style="background-color: var(--primary-color); color: white;">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="table table-hover" id="reportsTable">
                    <thead>
                        <tr>
                            <th>التاريخ</th>
                            <th>الفئة</th>
                            <th>الوصف</th>
                            <th>المبلغ</th>
                            <th>النوع</th>
                        </tr>
                    </thead>
                    <tbody id="reportsTableBody">
                        <!-- البيانات سيتم ملؤها عبر JavaScript -->
                        <tr>
                            <td colspan="5" class="text-center">جاري تحميل البيانات...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- ترقيم الصفحات -->
            <div class="d-flex justify-content-center my-3">
                <nav>
                    <ul class="pagination" id="transactionPagination">
                        <!-- سيتم إضافة أزرار الترقيم بواسطة JavaScript -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- التذييل -->
    <footer class="footer">
        <p>© 2023 المحاسب الشخصي. جميع الحقوق محفوظة.</p>
    </footer>

    <!-- المكتبات والسكريبتات -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // ========================== المتغيرات العامة ==========================
        // حجم الصفحة للترقيم
        const PAGE_SIZE = 10;
        let currentPage = 1;
        let filteredTransactions = [];
        let allTransactions = [];
        
        // بيانات الرسوم البيانية
        let charts = {};
        let selectedPeriod = 'month';
        
        // ========================== وظائف المساعدة ==========================
        
        // تنسيق المبالغ المالية
        function formatCurrency(amount) {
            return amount.toFixed(2) + ' دينار';
        }
        
        // تحويل التاريخ إلى تنسيق محلي
        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return new Date(dateString).toLocaleDateString('ar-EG', options);
        }
        
        // حساب التغيير النسبي بين قيمتين
        function calculatePercentageChange(oldValue, newValue) {
            if (oldValue === 0) return newValue > 0 ? 100 : 0;
            return ((newValue - oldValue) / Math.abs(oldValue) * 100).toFixed(1);
        }
        
        // إنشاء مصفوفة من التواريخ بين تاريخين
        function getDateRange(startDate, endDate, interval = 'day') {
            const dates = [];
            let currentDate = new Date(startDate);
            
            while (currentDate <= endDate) {
                dates.push(new Date(currentDate));
                
                // زيادة التاريخ حسب الفترة المحددة
                if (interval === 'day') {
                    currentDate.setDate(currentDate.getDate() + 1);
                } else if (interval === 'week') {
                    currentDate.setDate(currentDate.getDate() + 7);
                } else if (interval === 'month') {
                    currentDate.setMonth(currentDate.getMonth() + 1);
                }
            }
            
            return dates;
        }
        
        // الحصول على تاريخ البداية حسب الفترة الزمنية المحددة
        function getStartDateByPeriod(period) {
            const now = new Date();
            switch (period) {
                case 'week':
                    const lastWeek = new Date(now);
                    lastWeek.setDate(now.getDate() - 7);
                    return lastWeek;
                case 'month':
                    const lastMonth = new Date(now);
                    lastMonth.setMonth(now.getMonth() - 1);
                    return lastMonth;
                case 'quarter':
                    const lastQuarter = new Date(now);
                    lastQuarter.setMonth(now.getMonth() - 3);
                    return lastQuarter;
                case 'year':
                    const lastYear = new Date(now);
                    lastYear.setFullYear(now.getFullYear() - 1);
                    return lastYear;
                default:
                    return new Date(now.setMonth(now.getMonth() - 1));
            }
        }
        
        // ========================== وظائف جلب وعرض البيانات ==========================
        
        // جلب بيانات المعاملات من الخادم
        async function fetchTransactions() {
            const userId = localStorage.getItem('userId');
            if (!userId) {
                showErrorMessage('يجب تسجيل الدخول أولاً');
                setTimeout(() => window.location.href = 'index.html', 2000);
                return [];
            }
            
            try {
                // إظهار حالة التحميل
                setLoadingState(true);
                
                const response = await axios.get(`http://localhost:9050/api/transactions?userId=${userId}`);
                const transactions = response.data;
                
                // إخفاء حالة التحميل
                setLoadingState(false);
                
                return transactions;
            } catch (error) {
                console.error('حدث خطأ أثناء جلب البيانات:', error);
                showErrorMessage('فشل جلب البيانات. يرجى المحاولة لاحقًا.');
                return [];
            }
        }
        
        // إظهار أو إخفاء حالة التحميل
        function setLoadingState(isLoading) {
            const loadingRow = `<tr><td colspan="5" class="text-center">جاري تحميل البيانات...</td></tr>`;
            const emptyRow = `<tr><td colspan="5" class="text-center">لا توجد معاملات لعرضها</td></tr>`;
            
            if (isLoading) {
                document.getElementById('reportsTableBody').innerHTML = loadingRow;
            } else if (filteredTransactions.length === 0) {
                document.getElementById('reportsTableBody').innerHTML = emptyRow;
            }
        }
        
        // عرض رسالة خطأ للمستخدم
        function showErrorMessage(message) {
            Swal.fire({
                icon: 'error',
                title: 'خطأ',
                text: message,
                confirmButtonText: 'حسناً'
            });
        }
        
        // تحميل وعرض البيانات
        async function loadAndDisplayData() {
            // جلب المعاملات
            allTransactions = await fetchTransactions();
            filteredTransactions = [...allTransactions];
            
            if (allTransactions.length > 0) {
                // عرض الإحصائيات العامة
                displayGeneralStats(allTransactions);
                
                // عرض البيانات في الجدول
                displayTransactionsTable(allTransactions);
                
                // إنشاء الرسوم البيانية
                createCharts(allTransactions);
                
                // إنشاء توقعات الذكاء الاصطناعي
                generateAIPredictions(allTransactions);
            }
        }
        
        // عرض البيانات في الجدول مع دعم الترقيم
        function displayTransactionsTable(transactions, page = 1) {
            const reportsTableBody = document.getElementById('reportsTableBody');
            reportsTableBody.innerHTML = '';
            
            if (transactions.length === 0) {
                reportsTableBody.innerHTML = `<tr><td colspan="5" class="text-center">لا توجد معاملات لعرضها</td></tr>`;
                document.getElementById('transactionPagination').innerHTML = '';
                return;
            }
            
            // حساب بيانات الصفحة الحالية
            const startIndex = (page - 1) * PAGE_SIZE;
            const endIndex = Math.min(startIndex + PAGE_SIZE, transactions.length);
            const currentPageData = transactions.slice(startIndex, endIndex);
            
            // إضافة الصفوف إلى الجدول
            currentPageData.forEach(transaction => {
                const typeClass = transaction.type === 'income' ? 'income' : 'expense';
                const typeText = transaction.type === 'income' ? 'دخل' : 'مصروفات';
                
                const row = `
                    <tr>
                        <td>${formatDate(transaction.date)}</td>
                        <td>${transaction.category}</td>
                        <td>${transaction.description || '-'}</td>
                        <td class="${typeClass}">${formatCurrency(transaction.amount)}</td>
                        <td>
                            <span class="badge ${transaction.type === 'income' ? 'badge-positive' : 'badge-negative'}">
                                ${typeText}
                            </span>
                        </td>
                    </tr>
                `;
                reportsTableBody.innerHTML += row;
            });
            
            // إنشاء عناصر ترقيم الصفحات
            createPagination(transactions.length, page);
        }
        
        // إنشاء ترقيم الصفحات
        function createPagination(totalItems, currentPage) {
            const totalPages = Math.ceil(totalItems / PAGE_SIZE);
            const paginationElement = document.getElementById('transactionPagination');
            paginationElement.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            // زر الصفحة السابقة
            const prevButton = `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${currentPage - 1}" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
            `;
            paginationElement.innerHTML += prevButton;
            
            // أزرار الصفحات
            for (let i = 1; i <= totalPages; i++) {
                // عرض أول صفحتين، الصفحة الحالية، وآخر صفحتين
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    const pageButton = `
                        <li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" data-page="${i}">${i}</a>
                        </li>
                    `;
                    paginationElement.innerHTML += pageButton;
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    // إضافة نقاط للصفحات المحذوفة
                    paginationElement.innerHTML += `
                        <li class="page-item disabled">
                            <a class="page-link" href="#">...</a>
                        </li>
                    `;
                }
            }
            
            // زر الصفحة التالية
            const nextButton = `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${currentPage + 1}" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            `;
            paginationElement.innerHTML += nextButton;
            
            // إضافة مستمعي الأحداث لأزرار الترقيم
            document.querySelectorAll('#transactionPagination .page-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const pageNumber = parseInt(this.getAttribute('data-page'));
                    if (!isNaN(pageNumber)) {
                        displayTransactionsTable(filteredTransactions, pageNumber);
                    }
                });
            });
        }
        
        // عرض الإحصائيات العامة
        function displayGeneralStats(transactions) {
            // الحصول على تاريخ بداية ونهاية الشهر الحالي والسابق
            const now = new Date();
            const currentMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            const lastMonthStart = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            const lastMonthEnd = new Date(now.getFullYear(), now.getMonth(), 0);
            
            // تصفية المعاملات حسب الفترة الزمنية
            const currentMonthTransactions = transactions.filter(t => new Date(t.date) >= currentMonthStart);
            const lastMonthTransactions = transactions.filter(t => {
                const date = new Date(t.date);
                return date >= lastMonthStart && date <= lastMonthEnd;
            });
            
            // حساب إجمالي الدخل والمصروفات للشهر الحالي
            const currentIncome = currentMonthTransactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
                
            const currentExpenses = currentMonthTransactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
                
            const currentSavings = currentIncome - currentExpenses;
            
            // حساب إجمالي الدخل والمصروفات للشهر السابق
            const lastIncome = lastMonthTransactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
                
            const lastExpenses = lastMonthTransactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
                
            const lastSavings = lastIncome - lastExpenses;
            
            // حساب التغيير النسبي
            const incomeChange = calculatePercentageChange(lastIncome, currentIncome);
            const expensesChange = calculatePercentageChange(lastExpenses, currentExpenses);
            const savingsPercentage = currentIncome > 0 ? ((currentSavings / currentIncome) * 100).toFixed(1) : 0;
            
            // تحديث النص في البطاقات
            document.getElementById('totalIncome').textContent = formatCurrency(currentIncome);
            document.getElementById('totalExpenses').textContent = formatCurrency(currentExpenses);
            document.getElementById('totalSavings').textContent = formatCurrency(currentSavings);
            
            // تحديث نسب التغيير
            const incomeChangeElement = document.getElementById('incomeChangeValue');
            incomeChangeElement.textContent = `${incomeChange}%`;
            incomeChangeElement.className = parseFloat(incomeChange) >= 0 ? 'badge badge-positive' : 'badge badge-negative';
            
            const expensesChangeElement = document.getElementById('expensesChangeValue');
            expensesChangeElement.textContent = `${expensesChange}%`;
            expensesChangeElement.className = parseFloat(expensesChange) <= 0 ? 'badge badge-positive' : 'badge badge-negative';
            
            const savingsChangeElement = document.getElementById('savingsChangeValue');
            savingsChangeElement.textContent = `${savingsPercentage}%`;
            savingsChangeElement.className = parseFloat(savingsPercentage) >= 20 ? 'badge badge-positive' : 'badge badge-negative';
            
            // حساب وعرض مؤشر الصحة المالية
            calculateFinancialHealth(currentIncome, currentExpenses, savingsPercentage);
        }
        
        // حساب مؤشر الصحة المالية
        function calculateFinancialHealth(income, expenses, savingsPercentage) {
            // حساب نسبة الادخار
            const savingsRate = parseFloat(savingsPercentage);
            
            // حساب نسبة المصروفات للدخل
            const expenseToIncomeRatio = income > 0 ? (expenses / income) * 100 : 100;
            
            // حساب درجة الصحة المالية
            let healthScore = 0;
            
            // عوامل التقييم:
            // 1. نسبة الادخار (الوزن: 40%)
            // 2. نسبة المصروفات للدخل (الوزن: 40%)
            // 3. وجود معاملات كافية للتقييم (الوزن: 20%)
            
            // تقييم نسبة الادخار (أقصى 40 نقطة)
            if (savingsRate >= 20) {
                healthScore += 40; // ممتاز: توفير 20% أو أكثر
            } else if (savingsRate >= 10) {
                healthScore += 30; // جيد جدا: توفير 10-19%
            } else if (savingsRate > 0) {
                healthScore += 20; // متوسط: توفير 1-9%
            } else if (savingsRate === 0) {
                healthScore += 10; // ضعيف: لا توفير
            } else {
                healthScore += 0; // سيء: في المديونية
            }
            
            // تقييم نسبة المصروفات للدخل (أقصى 40 نقطة)
            if (expenseToIncomeRatio <= 50) {
                healthScore += 40; // ممتاز: أقل من 50%
            } else if (expenseToIncomeRatio <= 70) {
                healthScore += 30; // جيد: 50-70%
            } else if (expenseToIncomeRatio <= 90) {
                healthScore += 20; // متوسط: 70-90%
            } else if (expenseToIncomeRatio <= 100) {
                healthScore += 10; // ضعيف: 90-100%
            } else {
                healthScore += 0; // سيء: أكثر من 100%
            }
            
            // تقييم كمية البيانات المتاحة (أقصى 20 نقطة)
            if (allTransactions.length >= 20) {
                healthScore += 20; // بيانات كافية
            } else if (allTransactions.length >= 10) {
                healthScore += 10; // بيانات متوسطة
            } else {
                healthScore += 5; // بيانات قليلة
            }
            
            // تحديث العرض
            const healthScoreElement = document.getElementById('financialHealthScore');
            const healthBarElement = document.getElementById('financialHealthBar');
            const healthLabelElement = document.getElementById('financialHealthLabel');
            
            healthScoreElement.textContent = `${healthScore}%`;
            healthBarElement.style.width = `${healthScore}%`;
            
            // تحديد حالة الصحة المالية بناءً على النتيجة
            let healthStatus = '';
            if (healthScore >= 80) {
                healthStatus = 'ممتازة';
            } else if (healthScore >= 60) {
                healthStatus = 'جيدة';
            } else if (healthScore >= 40) {
                healthStatus = 'متوسطة';
            } else if (healthScore >= 20) {
                healthStatus = 'ضعيفة';
            } else {
                healthStatus = 'تحتاج إلى اهتمام';
            }
            
            healthLabelElement.textContent = `صحتك المالية: ${healthStatus}`;
        }
        
        // ========================== وظائف الرسوم البيانية ==========================
        
        // إنشاء وتحديث الرسوم البيانية
        function createCharts(transactions) {
            // تنظيف الرسوم البيانية القديمة
            Object.values(charts).forEach(chart => {
                if (chart instanceof Chart) {
                    chart.destroy();
                }
            });
            
            // إنشاء الرسوم البيانية الجديدة
            createLineChart(transactions);
            createPieCharts(transactions);
            createPredictionChart(transactions);
        }
        
        // إنشاء الرسم البياني الخطي
        function createLineChart(transactions) {
            const ctx = document.getElementById('lineChart').getContext('2d');
            
            // تحديد الفترة الزمنية
            const endDate = new Date();
            const startDate = getStartDateByPeriod(selectedPeriod);
            
            // تحديد فاصل زمني مناسب للفترة
            let interval = 'day';
            if (selectedPeriod === 'year') {
                interval = 'month';
            } else if (selectedPeriod === 'quarter') {
                interval = 'week';
            }
            
            // إنشاء مصفوفة من التواريخ
            const dateRange = getDateRange(startDate, endDate, interval);
            
            // تحضير البيانات للرسم البياني
            const incomeData = new Array(dateRange.length).fill(0);
            const expensesData = new Array(dateRange.length).fill(0);
            
            // تجميع بيانات المعاملات حسب التاريخ
            transactions.forEach(transaction => {
                const transactionDate = new Date(transaction.date);
                
                // التحقق من أن المعاملة ضمن النطاق الزمني المحدد
                if (transactionDate >= startDate && transactionDate <= endDate) {
                    // البحث عن أقرب تاريخ في المصفوفة
                    const index = dateRange.findIndex(date => {
                        if (interval === 'day') {
                            return date.toDateString() === transactionDate.toDateString();
                        } else if (interval === 'week') {
                            // مقارنة الأسبوع
                            const weekDiff = Math.floor((date - startDate) / (7 * 24 * 60 * 60 * 1000));
                            const transWeekDiff = Math.floor((transactionDate - startDate) / (7 * 24 * 60 * 60 * 1000));
                            return weekDiff === transWeekDiff;
                        } else if (interval === 'month') {
                            // مقارنة الشهر والسنة
                            return date.getMonth() === transactionDate.getMonth() && 
                                   date.getFullYear() === transactionDate.getFullYear();
                        }
                    });
                    
                    if (index !== -1) {
                        if (transaction.type === 'income') {
                            incomeData[index] += transaction.amount;
                        } else {
                            expensesData[index] += transaction.amount;
                        }
                    }
                }
            });
            
            // تحويل التواريخ إلى تنسيق أكثر قراءة
            const labels = dateRange.map(date => {
                if (interval === 'day') {
                    return formatDate(date);
                } else if (interval === 'week') {
                    const weekEnd = new Date(date);
                    weekEnd.setDate(date.getDate() + 6);
                    return `${formatDate(date)} - ${formatDate(weekEnd)}`;
                } else if (interval === 'month') {
                    const options = { year: 'numeric', month: 'long' };
                    return date.toLocaleDateString('ar-SA', options);
                }
            });
            
            // إنشاء الرسم البياني
            charts.lineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'الدخل',
                            data: incomeData,
                            borderColor: '#22c55e',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'المصروفات',
                            data: expensesData,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-dark'),
                                font: {
                                    family: 'Tajawal'
                                }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            titleFont: {
                                family: 'Tajawal'
                            },
                            bodyFont: {
                                family: 'Tajawal'
                            },
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-dark'),
                                font: {
                                    family: 'Tajawal'
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-dark'),
                                font: {
                                    family: 'Tajawal'
                                },
                                callback: function(value) {
                                    return value + ' دينار';
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }
        
        // إنشاء الرسوم البيانية الدائرية
        function createPieCharts(transactions) {
            // تصفية المعاملات حسب النوع
            const expenses = transactions.filter(t => t.type === 'expense');
            const income = transactions.filter(t => t.type === 'income');
            
            // تجميع المصروفات حسب الفئة
            const expensesCategories = {};
            expenses.forEach(expense => {
                if (expense.category in expensesCategories) {
                    expensesCategories[expense.category] += expense.amount;
                } else {
                    expensesCategories[expense.category] = expense.amount;
                }
            });
            
            // تجميع الدخل حسب الفئة
            const incomeCategories = {};
            income.forEach(inc => {
                if (inc.category in incomeCategories) {
                    incomeCategories[inc.category] += inc.amount;
                } else {
                    incomeCategories[inc.category] = inc.amount;
                }
            });
            
            // ترتيب الفئات تنازلياً حسب المبلغ
            const sortedExpensesCategories = Object.entries(expensesCategories)
                .sort((a, b) => b[1] - a[1]);
            
            const sortedIncomeCategories = Object.entries(incomeCategories)
                .sort((a, b) => b[1] - a[1]);
            
            // إنشاء مصفوفات الألوان
            const expensesColors = generateColors(Object.keys(expensesCategories).length, '#ef4444', '#f59e0b');
            const incomeColors = generateColors(Object.keys(incomeCategories).length, '#22c55e', '#3b82f6');
            
            // إنشاء رسم بياني دائري للمصروفات
            const expCtx = document.getElementById('expensesPieChart').getContext('2d');
            charts.expensesPieChart = new Chart(expCtx, {
                type: 'doughnut',
                data: {
                    labels: sortedExpensesCategories.map(cat => cat[0]),
                    datasets: [{
                        data: sortedExpensesCategories.map(cat => cat[1]),
                        backgroundColor: expensesColors,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-dark'),
                                font: {
                                    family: 'Tajawal'
                                }
                            }
                        },
                        tooltip: {
                            titleFont: {
                                family: 'Tajawal'
                            },
                            bodyFont: {
                                family: 'Tajawal'
                            },
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${context.label}: ${formatCurrency(value)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            // إنشاء رسم بياني دائري للدخل
            const incCtx = document.getElementById('incomePieChart').getContext('2d');
            charts.incomePieChart = new Chart(incCtx, {
                type: 'doughnut',
                data: {
                    labels: sortedIncomeCategories.map(cat => cat[0]),
                    datasets: [{
                        data: sortedIncomeCategories.map(cat => cat[1]),
                        backgroundColor: incomeColors,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-dark'),
                                font: {
                                    family: 'Tajawal'
                                }
                            }
                        },
                        tooltip: {
                            titleFont: {
                                family: 'Tajawal'
                            },
                            bodyFont: {
                                family: 'Tajawal'
                            },
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${context.label}: ${formatCurrency(value)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // إنشاء ألوان متدرجة للرسوم البيانية
        function generateColors(count, startColor, endColor) {
            const colors = [];
            
            // تحويل الألوان إلى قيم RGB
            const start = hexToRgb(startColor);
            const end = hexToRgb(endColor);
            
            // إنشاء تدرج من الألوان
            for (let i = 0; i < count; i++) {
                const ratio = i / Math.max(count - 1, 1);
                const r = Math.round(start.r + ratio * (end.r - start.r));
                const g = Math.round(start.g + ratio * (end.g - start.g));
                const b = Math.round(start.b + ratio * (end.b - start.b));
                
                colors.push(`rgba(${r}, ${g}, ${b}, 0.8)`);
            }
            
            return colors;
        }
        
        // تحويل لون من تنسيق HEX إلى RGB
        function hexToRgb(hex) {
            const shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
            hex = hex.replace(shorthandRegex, (m, r, g, b) => r + r + g + g + b + b);
            
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }
        
        // ========================== وظائف التنبؤ والتحليل باستخدام الذكاء الاصطناعي ==========================
        
        // إنشاء توقعات وتحليلات مبنية على بيانات المستخدم
        function generateAIPredictions(transactions) {
            if (transactions.length === 0) {
                // إذا لم تكن هناك معاملات، عرض رسالة مناسبة
                document.getElementById('aiInsightsList').innerHTML = `
                    <li>أضف بعض المعاملات للحصول على تحليلات وتوقعات مالية ذكية.</li>
                `;
                return;
            }
            
            // تصفية المعاملات إلى دخل ومصروفات
            const expenses = transactions.filter(t => t.type === 'expense');
            const income = transactions.filter(t => t.type === 'income');
            
            // تحليل أنماط الإنفاق
            analyzeSpendingPatterns(expenses);
            
            // تحليل اتجاهات الدخل
            analyzeIncomePatterns(income);
            
            // تحليل وعرض توزيع النفقات حسب قاعدة 50/30/20
            analyze5030Rule(transactions);
            
            // إنشاء رسم بياني للتوقعات
            createPredictionChart(transactions);
        }
        
        // تحليل أنماط الإنفاق
        function analyzeSpendingPatterns(expenses) {
            if (expenses.length === 0) return;
            
            // تجميع المصروفات حسب الفئة
            const categoryTotals = {};
            expenses.forEach(exp => {
                if (exp.category in categoryTotals) {
                    categoryTotals[exp.category] += exp.amount;
                } else {
                    categoryTotals[exp.category] = exp.amount;
                }
            });
            
            // الفئة ذات أعلى إنفاق
            const highestCategory = Object.entries(categoryTotals)
                .sort((a, b) => b[1] - a[1])[0];
            
            // تجميع المصروفات حسب اليوم
            const expensesByDay = {};
            expenses.forEach(exp => {
                const day = new Date(exp.date).getDay();
                if (day in expensesByDay) {
                    expensesByDay[day] += exp.amount;
                } else {
                    expensesByDay[day] = exp.amount;
                }
            });
            
            // اليوم ذو أعلى إنفاق
            const highestDay = Object.entries(expensesByDay)
                .sort((a, b) => b[1] - a[1])[0];
            
            const weekdays = ['الأحد', 'الإثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
            
            // تحليل بيانات الإنفاق مؤخراً
            expenses.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // الحصول على إجمالي المصروفات
            const totalExpenses = expenses.reduce((sum, exp) => sum + exp.amount, 0);
            
            // حساب متوسط الإنفاق الشهري
            const monthlyAverage = totalExpenses / (Math.ceil(expenses.length / 30) || 1);
            
            // إنشاء نصائح وتحليلات
            let insights = [];
            
            // إضافة تحليل الفئة الأعلى إنفاقاً
            if (highestCategory) {
                const percentage = ((highestCategory[1] / totalExpenses) * 100).toFixed(1);
                insights.push(`أكبر فئة للإنفاق هي "${highestCategory[0]}" بنسبة ${percentage}% من إجمالي مصروفاتك.`);
            }
            
            // إضافة تحليل اليوم الأعلى إنفاقاً
            if (highestDay) {
                insights.push(`تميل للإنفاق بشكل أكبر في يوم ${weekdays[highestDay[0]]}.`);
            }
            
            // تحليل نمط الإنفاق
            const recentExpenses = expenses.slice(0, Math.min(5, expenses.length));
            const recentTotal = recentExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            const avgRecentExpense = recentTotal / recentExpenses.length;
            
            if (avgRecentExpense > monthlyAverage / 20) {
                insights.push(`مصروفاتك الأخيرة أعلى من المتوسط، قد ترغب في مراجعة نمط إنفاقك الحالي.`);
            } else if (recentExpenses.length > 0) {
                insights.push(`أنت تحافظ على نمط إنفاق متوازن مؤخراً.`);
            }
            
            // تحليل فرص التوفير
            if (Object.keys(categoryTotals).length > 0) {
                // البحث عن الفئات التي يمكن تخفيض الإنفاق فيها
                const savingOpportunities = Object.entries(categoryTotals)
                    .filter(([category]) => !['إيجار', 'فواتير', 'أقساط'].includes(category))
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 2);
                
                if (savingOpportunities.length > 0) {
                    const opportunity = savingOpportunities[0];
                    insights.push(`يمكنك توفير المزيد عن طريق تقليل الإنفاق على "${opportunity[0]}".`);
                }
            }
            
            // تحديث قائمة التحليلات
            updateAIInsights(insights);
        }
        
        // تحليل أنماط الدخل
        function analyzeIncomePatterns(income) {
            if (income.length < 2) return;
            
            // فرز المعاملات حسب التاريخ
            income.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // حساب معدل نمو الدخل
            const firstIncome = income[0].amount;
            const lastIncome = income[income.length - 1].amount;
            const monthsDiff = (new Date(income[income.length - 1].date).getTime() - new Date(income[0].date).getTime()) / (30 * 24 * 60 * 60 * 1000);
            
            if (monthsDiff >= 1) {
                const growthRate = ((lastIncome - firstIncome) / firstIncome) * 100;
                
                let insight = '';
                if (growthRate > 5) {
                    insight = `دخلك ينمو بمعدل جيد (${growthRate.toFixed(1)}%) خلال الفترة السابقة.`;
                } else if (growthRate > 0) {
                    insight = `دخلك ينمو ببطء (${growthRate.toFixed(1)}%)، قد ترغب في البحث عن فرص لزيادة دخلك.`;
                } else {
                    insight = `لاحظنا انخفاضاً في دخلك بنسبة (${Math.abs(growthRate).toFixed(1)}%)، ننصح بمراجعة مصادر دخلك.`;
                }
                
                // إضافة هذا التحليل إلى القائمة
                const currentInsights = document.getElementById('aiInsightsList').innerHTML;
                document.getElementById('aiInsightsList').innerHTML = currentInsights + `<li>${insight}</li>`;
            }
        }
        
        // تحليل توزيع النفقات حسب قاعدة 50/30/20
        function analyze5030Rule(transactions) {
            // تصفية المعاملات للشهر الحالي
            const now = new Date();
            const currentMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            const currentMonthTransactions = transactions.filter(t => new Date(t.date) >= currentMonthStart);
            
            // حساب إجمالي الدخل
            const totalIncome = currentMonthTransactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
                
            if (totalIncome === 0) return;
            
            // تصنيف الفئات
            const necessitiesCategories = ['إيجار', 'فواتير', 'طعام', 'مواصلات', 'صحة', 'أقساط', 'تعليم'];
            const wantsCategories = ['ترفيه', 'مطاعم', 'تسوق', 'هدايا', 'سفر', 'رياضة'];
            const savingsCategories = ['ادخار', 'استثمار', 'تقاعد'];
            
            // حساب المصروفات لكل نوع
            let necessities = 0;
            let wants = 0;
            let savings = 0;
            
            currentMonthTransactions.forEach(transaction => {
                if (transaction.type === 'expense') {
                    if (necessitiesCategories.includes(transaction.category)) {
                        necessities += transaction.amount;
                    } else if (wantsCategories.includes(transaction.category)) {
                        wants += transaction.amount;
                    }
                } else if (transaction.type === 'income' && savingsCategories.includes(transaction.category)) {
                    savings += transaction.amount;
                }
            });
            
            // حساب النسب
            const necessitiesPercentage = (necessities / totalIncome * 100).toFixed(1);
            const wantsPercentage = (wants / totalIncome * 100).toFixed(1);
            const savingsPercentage = (savings / totalIncome * 100).toFixed(1);
            
            // تحديث شرائط التقدم
            document.getElementById('necessitiesPercentage').textContent = `${necessitiesPercentage}%`;
            document.getElementById('wantsPercentage').textContent = `${wantsPercentage}%`;
            document.getElementById('savingsPercentage').textContent = `${savingsPercentage}%`;
            
            document.getElementById('necessitiesProgress').style.width = `${Math.min(necessitiesPercentage, 100)}%`;
            document.getElementById('wantsProgress').style.width = `${Math.min(wantsPercentage, 100)}%`;
            document.getElementById('savingsProgress').style.width = `${Math.min(savingsPercentage, 100)}%`;
            
            // إضافة تحليل لقاعدة 50/30/20
            let ruleInsight = '';
            
            if (necessitiesPercentage > 50) {
                ruleInsight = `تنفق ${necessitiesPercentage}% على الضروريات، وهو أعلى من النسبة المثالية (50%). حاول تقليل بعض النفقات الثابتة.`;
            } else if (wantsPercentage > 30) {
                ruleInsight = `تنفق ${wantsPercentage}% على الرغبات، وهو أعلى من النسبة المثالية (30%). يمكنك تخفيض هذه النفقات لزيادة مدخراتك.`;
            } else if (savingsPercentage < 20) {
                ruleInsight = `توفر ${savingsPercentage}% من دخلك، وهو أقل من النسبة المثالية (20%). حاول زيادة مدخراتك للوصول للهدف.`;
            } else {
                ruleInsight = `توزيع نفقاتك ومدخراتك متوازن جداً! أنت تتبع قاعدة 50/30/20 بنجاح.`;
            }
            
            // إضافة هذا التحليل إلى القائمة
            const currentInsights = document.getElementById('aiInsightsList').innerHTML;
            document.getElementById('aiInsightsList').innerHTML = currentInsights + `<li>${ruleInsight}</li>`;
        }
        
        // تحديث قائمة التحليلات والتوصيات
        function updateAIInsights(insights) {
            const insightsList = document.getElementById('aiInsightsList');
            
            if (!insights || insights.length === 0) {
                insightsList.innerHTML = `<li>أضف المزيد من المعاملات للحصول على تحليلات أكثر دقة.</li>`;
                return;
            }
            
            insightsList.innerHTML = '';
            insights.forEach(insight => {
                insightsList.innerHTML += `<li>${insight}</li>`;
            });
        }
        
        // إنشاء رسم بياني للتوقعات
        function createPredictionChart(transactions) {
            if (transactions.length < 10) return;
            
            const ctx = document.getElementById('predictionChart').getContext('2d');
            
            // الحصول على البيانات التاريخية
            const now = new Date();
            const sixMonthsAgo = new Date(now);
            sixMonthsAgo.setMonth(now.getMonth() - 6);
            
            // تجميع البيانات حسب الشهر
            const monthlyData = {};
            const monthlyExpenses = {};
            const monthlyIncome = {};
            
            // تهيئة مصفوفات البيانات
            for (let i = 0; i < 9; i++) {
                const date = new Date(sixMonthsAgo);
                date.setMonth(sixMonthsAgo.getMonth() + i);
                const key = `${date.getFullYear()}-${date.getMonth() + 1}`;
                
                monthlyData[key] = 0;
                monthlyExpenses[key] = 0;
                monthlyIncome[key] = 0;
            }
            
            // ملء البيانات التاريخية
            transactions.forEach(transaction => {
                const date = new Date(transaction.date);
                if (date >= sixMonthsAgo) {
                    const key = `${date.getFullYear()}-${date.getMonth() + 1}`;
                    
                    if (transaction.type === 'income') {
                        monthlyIncome[key] = (monthlyIncome[key] || 0) + transaction.amount;
                    } else {
                        monthlyExpenses[key] = (monthlyExpenses[key] || 0) + transaction.amount;
                    }
                    
                    // الرصيد الشهري (الدخل - المصروفات)
                    monthlyData[key] = (monthlyIncome[key] || 0) - (monthlyExpenses[key] || 0);
                }
            });
            
            // تحويل البيانات إلى مصفوفات
            const months = Object.keys(monthlyData).sort();
            const balanceData = months.map(month => monthlyData[month]);
            const expenseData = months.map(month => monthlyExpenses[month]);
            const incomeData = months.map(month => monthlyIncome[month]);
            
            // حساب متوسط النمو الشهري للتنبؤ
            let growthRates = [];
            for (let i = 1; i < balanceData.length; i++) {
                if (balanceData[i - 1] !== 0) {
                    const growthRate = (balanceData[i] - balanceData[i - 1]) / Math.abs(balanceData[i - 1]);
                    if (!isNaN(growthRate) && isFinite(growthRate)) {
                        growthRates.push(growthRate);
                    }
                }
            }
            
            // حساب متوسط معدل النمو
            const avgGrowthRate = growthRates.length > 0 ? 
                growthRates.reduce((sum, rate) => sum + rate, 0) / growthRates.length : 0;
            
            // تنبؤ بقيم الأشهر الثلاثة القادمة
            const historicalMonths = months.length;
            const lastBalance = balanceData[balanceData.length - 1] || 0;
            const lastIncome = incomeData[incomeData.length - 1] || 0;
            const lastExpense = expenseData[expenseData.length - 1] || 0;
            
            const predictedBalance = [
                lastBalance * (1 + avgGrowthRate),
                lastBalance * (1 + avgGrowthRate) * (1 + avgGrowthRate),
                lastBalance * (1 + avgGrowthRate) * (1 + avgGrowthRate) * (1 + avgGrowthRate)
            ];
            
            const predictedIncome = [
                lastIncome * (1 + avgGrowthRate * 0.5),
                lastIncome * (1 + avgGrowthRate * 0.5) * (1 + avgGrowthRate * 0.5),
                lastIncome * (1 + avgGrowthRate * 0.5) * (1 + avgGrowthRate * 0.5) * (1 + avgGrowthRate * 0.5)
            ];
            
            const predictedExpense = [
                lastExpense * (1 + avgGrowthRate * 0.3),
                lastExpense * (1 + avgGrowthRate * 0.3) * (1 + avgGrowthRate * 0.3),
                lastExpense * (1 + avgGrowthRate * 0.3) * (1 + avgGrowthRate * 0.3) * (1 + avgGrowthRate * 0.3)
            ];
            
            // إنشاء تسميات للأشهر القادمة
            const futureMonths = [];
            for (let i = 1; i <= 3; i++) {
                const futureDate = new Date(now);
                futureDate.setMonth(now.getMonth() + i);
                futureMonths.push(`${futureDate.getFullYear()}-${futureDate.getMonth() + 1}`);
            }
            
            // تحضير الرسم البياني مع البيانات التاريخية والتنبؤية
            const allMonths = [...months, ...futureMonths];
            const displayMonths = allMonths.map(month => {
                const [year, monthNum] = month.split('-');
                const date = new Date(parseInt(year), parseInt(monthNum) - 1);
                return date.toLocaleDateString('ar-SA', { month: 'short', year: 'numeric' });
            });
            
            const allIncomeData = [...incomeData, ...predictedIncome];
            const allExpenseData = [...expenseData, ...predictedExpense];
            const allBalanceData = [...balanceData, ...predictedBalance];
            
            // إنشاء الرسم البياني
            charts.predictionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: displayMonths,
                    datasets: [
                        {
                            label: 'الدخل',
                            data: allIncomeData,
                            borderColor: '#22c55e',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4,
                            pointStyle: function(context) {
                                return context.dataIndex >= historicalMonths ? 'circle' : 'circle';
                            },
                            pointRadius: function(context) {
                                return context.dataIndex >= historicalMonths ? 4 : 3;
                            },
                            pointBackgroundColor: function(context) {
                                return context.dataIndex >= historicalMonths ? 'rgba(34, 197, 94, 0.9)' : 'rgba(34, 197, 94, 0.7)';
                            }
                        },
                        {
                            label: 'المصروفات',
                            data: allExpenseData,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4,
                            pointStyle: function(context) {
                                return context.dataIndex >= historicalMonths ? 'circle' : 'circle';
                            },
                            pointRadius: function(context) {
                                return context.dataIndex >= historicalMonths ? 4 : 3;
                            },
                            pointBackgroundColor: function(context) {
                                return context.dataIndex >= historicalMonths ? 'rgba(239, 68, 68, 0.9)' : 'rgba(239, 68, 68, 0.7)';
                            }
                        },
                        {
                            label: 'الرصيد',
                            data: allBalanceData,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            borderDash: function(context) {
                                return context.dataIndex >= historicalMonths ? [5, 5] : [];
                            },
                            fill: false,
                            tension: 0.4,
                            pointStyle: function(context) {
                                return context.dataIndex >= historicalMonths ? 'rectRot' : 'circle';
                            },
                            pointRadius: function(context) {
                                return context.dataIndex >= historicalMonths ? 5 : 3;
                            },
                            pointBackgroundColor: function(context) {
                                return context.dataIndex >= historicalMonths ? 'rgba(59, 130, 246, 0.9)' : 'rgba(59, 130, 246, 0.7)';
                            }
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-dark'),
                                font: {
                                    family: 'Tajawal'
                                }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            titleFont: {
                                family: 'Tajawal'
                            },
                            bodyFont: {
                                family: 'Tajawal'
                            },
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    let label = context.dataset.label + ': ' + formatCurrency(value);
                                    
                                    if (context.dataIndex >= historicalMonths) {
                                        label += ' (توقع)';
                                    }
                                    
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-dark'),
                                font: {
                                    family: 'Tajawal'
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            beginAtZero: false,
                            ticks: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-dark'),
                                font: {
                                    family: 'Tajawal'
                                },
                                callback: function(value) {
                                    return value + ' دينار';
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    },
                    animation: {
                        duration: 2000
                    }
                }
            });
            
            // إضافة تحليل للتوقعات
            const lastBalanceChange = predictedBalance[2] - lastBalance;
            const trend = lastBalanceChange > 0 ? 'تحسن' : 'انخفاض';
            
            // إضافة هذا التحليل إلى القائمة
            const currentInsights = document.getElementById('aiInsightsList').innerHTML;
            document.getElementById('aiInsightsList').innerHTML = currentInsights + 
                `<li>نتوقع ${trend} في رصيدك المالي بقيمة ${formatCurrency(Math.abs(lastBalanceChange))} خلال الأشهر الثلاثة القادمة.</li>`;
        }
        
        // ========================== وظائف التصدير ==========================
        
        // تصدير إلى PDF
        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // إضافة الخط العربي
            doc.addFont('https://cdn.jsdelivr.net/npm/amiri-font@1.0.0/amiri-regular.ttf', 'Amiri', 'normal');
            doc.setFont('Amiri'); // تعيين الخط العربي
            
            // عنوان التقرير
            doc.setFontSize(22);
            doc.text("التقارير المالية", 150, 15, { align: 'right' });
            
            // تاريخ التقرير
            doc.setFontSize(12);
            doc.text(`تاريخ التقرير: ${new Date().toLocaleDateString('ar-SA')}`, 150, 25, { align: 'right' });
            
            // إضافة الجدول
            doc.autoTable({
                html: '#reportsTable',
                startY: 35, // بداية الجدول بعد العنوان
                theme: 'grid',
                headStyles: { 
                    fillColor: [93, 92, 222], // لون خلفية رأس الجدول
                    font: 'Amiri', // استخدام الخط العربي
                    fontStyle: 'bold'
                },
                styles: { 
                    font: 'Amiri', // استخدام الخط العربي
                    halign: 'right' // محاذاة النص لليمين
                },
                margin: { right: 15 }
            });
            
            // حفظ الملف
            doc.save('التقارير_المالية.pdf');
        }
        
        // تصدير إلى Excel
        function exportToExcel() {
            const table = document.getElementById('reportsTable');
            const workbook = XLSX.utils.table_to_book(table, { sheet: "التقارير المالية" });
            XLSX.writeFile(workbook, 'التقارير_المالية.xlsx');
        }
        
        // ========================== مستمعات الأحداث ==========================
        
        // إضافة مستمع البحث في الجدول
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchTransactions');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    
                    if (searchTerm.trim() === '') {
                        // إذا كان حقل البحث فارغاً، عرض جميع المعاملات
                        filteredTransactions = [...allTransactions];
                    } else {
                        // تصفية المعاملات وفقاً لمصطلح البحث
                        filteredTransactions = allTransactions.filter(transaction => {
                            return (
                                transaction.category.toLowerCase().includes(searchTerm) ||
                                (transaction.description && transaction.description.toLowerCase().includes(searchTerm)) ||
                                transaction.amount.toString().includes(searchTerm) ||
                                (transaction.type === 'income' && 'دخل'.includes(searchTerm)) ||
                                (transaction.type === 'expense' && 'مصروفات'.includes(searchTerm)) ||
                                new Date(transaction.date).toLocaleDateString().includes(searchTerm)
                            );
                        });
                    }
                    
                    // تحديث الجدول بالنتائج المصفاة
                    displayTransactionsTable(filteredTransactions, 1);
                });
            }
            
            // إضافة مستمعي أحداث لفلاتر الرسم البياني
            const timeFrameFilters = document.querySelectorAll('#timeFrameFilters .chart-filter');
            timeFrameFilters.forEach(filter => {
                filter.addEventListener('click', function() {
                    // إزالة الحالة النشطة من جميع الفلاتر
                    timeFrameFilters.forEach(f => f.classList.remove('active'));
                    
                    // إضافة الحالة النشطة للفلتر المحدد
                    this.classList.add('active');
                    
                    // تحديث الفترة الزمنية المحددة
                    selectedPeriod = this.getAttribute('data-period');
                    
                    // تحديث الرسم البياني
                    createLineChart(allTransactions);
                });
            });
        });
        
        // جلب البيانات عند تحميل الصفحة
        window.onload = function() {
            // جلب وعرض البيانات
            loadAndDisplayData();
            
            // جلب بيانات المستخدم
            fetchUserData();
            
            // تطبيق لون الخلفية
            applyBackgroundColor();
            
            // تهيئة الوضع الليلي/النهاري
            initializeTheme();
        };
        
        // تحديث سمة الرسوم البيانية
        function updateChartsTheme(theme) {
            // تحديث لون النص في الرسوم البيانية
            const textColor = theme === 'light' ? '#333333' : '#eaeaea';
            const gridColor = theme === 'light' ? 'rgba(0, 0, 0, 0.1)' : 'rgba(255, 255, 255, 0.1)';
            
            // تحديث كل رسم بياني
            Object.values(charts).forEach(chart => {
                if (chart && chart.options && chart.options.scales) {
                    // تحديث لون النص والشبكة في المحاور
                    if (chart.options.scales.x) {
                        chart.options.scales.x.ticks.color = textColor;
                        chart.options.scales.x.grid.color = gridColor;
                    }
                    
                    if (chart.options.scales.y) {
                        chart.options.scales.y.ticks.color = textColor;
                        chart.options.scales.y.grid.color = gridColor;
                    }
                    
                    // تحديث لون النص في وسائل الإيضاح
                    if (chart.options.plugins && chart.options.plugins.legend) {
                        chart.options.plugins.legend.labels.color = textColor;
                    }
                    
                    // تطبيق التحديثات
                    chart.update();
                }
            });
        }
    </script>
</body>
</html>