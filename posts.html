<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>المنتدى - نظام المالية الشخصية</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="public/js/main.js"></script>
    <link rel="stylesheet" href="public/styles/main.css">
    <link rel="stylesheet" href="public/styles/posts.css">


</head>
<body>

    <!-- شريط التنقل المحسن -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-chart-line"></i>
                نظام المالية الشخصية
            </a>
            <li class="nav-item">
                <a class="nav-link" id="themeToggle" href="#">
                    <i class="fas fa-moon" style="font-size: 1.3rem;"></i>
                </a>
            </li>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation" style='background-color:rgb(216, 149, 149)'>
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="fas fa-home"></i> الرئيسية
                        </a>
                    </li>
                    <!-- <li class="nav-item">
                        <a class="nav-link" href="Transctionshow.html">
                            <i class="fas fa-exchange-alt"></i> المعاملات
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="Budget.html">
                            <i class="fas fa-wallet"></i> الميزانية
                        </a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link" href="goals.html">
                            <i class="fas fa-bullseye"></i> الخطط والأهداف
                        </a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link" href="report.html">
                            <i class="fas fa-chart-line"></i> التقارير
                        </a>
                    </li> -->
                    


                    <!-- <li class="nav-item">
                        <a class="nav-link" href="#" onclick="logout()" style="color: var(--danger-color);">
                            <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
                        </a>
                    </li> -->

                    <li class="nav-item">
                        <a class="nav-link" href="HelpSupport.html">
                            <i class="fas fa-question-circle"></i> الدعم
                        </a>
                    </li>
                </ul>
                
                <!-- <div class="d-flex align-items-center">
                    <a class="nav-link" href="profile.html">
                        <div id="user-info" class="d-flex align-items-center">
                            <div class="user-avatar"></div>
                            <div class="user-info">
                                <span class="user-name"> </span>
                            </div>
                        </div>
                    </a>
                </div> -->
            </div>
        </div>
    </nav>

    <!-- قسم الإشعارات -->
    <div class="notification-container" id="notificationContainer">
        <!-- الإشعارات ستظهر هنا ديناميكيًا -->
    </div>
    <!-- زر الرجوع للأعلى -->
     <button id="scrollToTopBtn" title="الذهاب إلى الأعلى" style="
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 99;
    border: none;
    outline: none;
    background-color: var(--primary-color);
    color: white;
    cursor: pointer;
    padding: 15px;
    border-radius: 50%;
    font-size: 18px;
    transition: all 0.3s ease;
    opacity: 0;
    visibility: hidden;
">
<i class="fas fa-plus"></i>
</button>
    <!-- المحتوى الرئيسي للمنتدى -->
    <div class="content">
        <div class="forum-container">
            <h1 class="section-title animate__animated animate__fadeIn">
                <i class="fas fa-comments ms-2"></i> منتدى المحاسب الشخصي
            </h1>

            <!-- رسالة تسجيل الدخول للزوار -->
            <div class="login-message" id="loginMessage" style="display:none;">
                <p><i class="fas fa-info-circle ms-2"></i> يجب تسجيل الدخول للمشاركة في المنتدى، بإمكانك فقط قراءة المحتوى كزائر.</p>
                <a href="login.html" class="btn btn-primary btn-sm">تسجيل الدخول</a>
            </div>

            <!-- قسم إنشاء منشور جديد (للمستخدمين المسجلين فقط) -->
            <div class="create-post-container" id="createPostContainer">
                <div class="create-post-form">
                    <h4 class="mb-4"><i class="fas fa-pen ms-2"></i> إنشاء منشور جديد</h4>
                    <form id="postForm">
                        <div class="form-group">
                            <label for="postTitle" class="form-label">عنوان المنشور (اختياري)</label>
                            <input type="text" id="postTitle" class="form-control" placeholder="أدخل عنوان المنشور">
                        </div>
                        <div class="form-group">
                            <label for="postContent" class="form-label">محتوى المنشور <span class="text-danger">*</span></label>
                            <textarea id="postContent" class="form-control" placeholder="شارك أفكارك وتجاربك المالية هنا..." required></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">صورة (اختياري)</label>
                            <div class="file-input-container">
                                <i class="fas fa-upload"></i>
                                <p>اسحب الصورة أو انقر هنا للتحميل</p>
                                <span class="file-name" id="fileName">لم يتم اختيار ملف</span>
                                <input type="file" class="file-input" id="postImage" accept="image/*">
                            </div>
                            <div class="preview-image-container" id="previewContainer" style="display: none;">
                                <img src="" alt="معاينة" class="preview-image" id="previewImage">
                                <button type="button" class="remove-image-btn" id="removeImage">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="text-center">
                            <button type="submit" class="btn btn-primary" id="submitPost">
                                <i class="fas fa-paper-plane ms-2"></i> نشر
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- فلاتر البحث وترتيب المنشورات -->
            <div class="forum-filters">
                <div class="filter-group">
                    <label for="sortPosts">ترتيب:</label>
                    <select id="sortPosts" class="form-select form-select-sm">
                        <option value="newest">الأحدث</option>
                        <option value="oldest">الأقدم</option>
                        <option value="popular">الأكثر تفاعلاً</option>
                    </select>
                </div>
                <div class="filter-group">
                    <input type="text" id="searchPosts" class="form-control form-control-sm" placeholder="بحث في المنشورات...">
                    <button class="btn btn-sm btn-primary" id="searchButton">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>

            <!-- قائمة المنشورات -->
            <div id="postsContainer">
                <!-- ستتم إضافة المنشورات هنا ديناميكيا -->
                <div class="loading-spinner">
                    <div class="spinner"></div>
                </div>
            </div>

            <!-- التنقل بين الصفحات -->
            <div class="pagination-container" id="paginationContainer">
                <!-- ستتم إضافة التنقل بين الصفحات هنا ديناميكيا -->
            </div>
        </div>
    </div>

    <!-- التذييل المحسن -->
    <footer class="footer animate__animated animate__fadeIn">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <h6>عن النظام</h6>
                    <p class="text-muted">نظام إدارة المالية الشخصية يساعدك على تتبع دخلك ومصروفاتك بسهولة وكفاءة.</p>
                </div>
                <div class="col-md-4 text-center">
                    <h6>روابط سريعة</h6>
                    <ul class="list-unstyled">
                        <li><a href="#" class="text-muted">الأسئلة الشائعة</a></li>
                        <li><a href="#" class="text-muted">الدعم الفني</a></li>
                        <li><a href="#" class="text-muted">الشروط والأحكام</a></li>
                    </ul>
                </div>
                <div class="col-md-4 text-end">
                    <h6>اتصل بنا</h6>
                    <ul class="list-unstyled">
                        <li><i class="fas fa-envelope me-2"></i> info@example.com</li>
                        <li><i class="fas fa-phone me-2"></i> +962 7 0000 0000</li>
                    </ul>
                </div>
            </div>
            <hr class="mt-3 mb-3" style="border-color: rgba(255,255,255,0.1);">
            <p class="mb-0">© 2023 نظام إدارة المالية الشخصية. جميع الحقوق محفوظة.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        /* متغيرات عامة */
        let currentPage = 1;
        const postsPerPage = 10;
        let totalPosts = 0;
        let isLoggedIn = false;
        let currentUser = null;
        const baseUrl = 'http://localhost:9050'; // عنوان الخادم الأساسي - قم بتغييره حسب الإعدادات لديك
        let posts = [];

        /* دالة التحقق من حالة تسجيل الدخول */
async function checkLoginStatus() {
    const token = localStorage.getItem('token');
    const userId = localStorage.getItem('userId');

    if (token && userId) {
        // المستخدم مسجل دخوله
        isLoggedIn = true;
        // يمكنك هنا جلب بيانات المستخدم من localStorage أو تركها افتراضية
        currentUser = {
            id: userId,
            username: localStorage.getItem('username') || 'مستخدم',
            profileImage: localStorage.getItem('profileImage') || null,
            role: localStorage.getItem('role') || 'مستخدم'
        };
        updateUserInterface(true);
        return true;
    } else {
        // المستخدم غير مسجل دخوله
        isLoggedIn = false;
        currentUser = null;
        updateUserInterface(false);
        return false;
    }
}        
        
        /* دالة تحديث واجهة المستخدم بناءً على حالة تسجيل الدخول */
        function updateUserInterface(isLoggedIn) {
            const createPostContainer = document.getElementById('createPostContainer');
            const loginMessage = document.getElementById('loginMessage');
            
            if (isLoggedIn) {
                createPostContainer.style.display = 'block';
                loginMessage.style.display = 'none';
            } else {
                createPostContainer.style.display = 'none';
                loginMessage.style.display = 'flex';
            }
}        
        
        
        /* دالة تحديث بيانات المستخدم في شريط التنقل */
        // function updateNavbarUserInfo(user) {
        //     if (!user) return;
            
        //     const userNameElement = document.querySelector('.user-name');
        //     const userAvatarElement = document.querySelector('.user-avatar');
            
        //     if (userNameElement) {
        //         userNameElement.textContent = user.username || 'مستخدم';
        //     }
            
        //     if (userAvatarElement) {
        //         // إذا كان المستخدم لديه صورة رمزية، نعرضها
        //         if (user.avatar) {
        //             userAvatarElement.innerHTML = `<img src="${user.profileImage}" alt="${user.username}" />`;
        //         } else {
        //             // وإلا نعرض الحرف الأول من اسم المستخدم
        //             const firstLetter = (user.username || 'م').charAt(0);
        //             userAvatarElement.textContent = firstLetter;
        //         }
        //     }
        // }


    

        /* دالة جلب المنشورات من الخادم */
        async function fetchPosts(page = 1, sort = 'newest', search = '') {
            try {
                // عرض حالة التحميل
                document.getElementById('postsContainer').innerHTML = `
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                    </div>
                `;
                
                // بناء رابط API مع المعلمات المطلوبة
                let url = `${baseUrl}/api/posts?page=${page}&limit=${postsPerPage}`;
                
                // إضافة معلمات الترتيب
                if (sort === 'oldest') {
                    url += '&sort=createdAt';
                } else if (sort === 'newest') {
                    url += '&sort=-createdAt';
                } else if (sort === 'popular') {
                    url += '&sort=-reactions';
                }
                
                // إضافة معلمات البحث إذا وجدت
                if (search) {
                    url += `&search=${encodeURIComponent(search)}`;
                }
                
                const response = await axios.get(url);
                
                if (response.data) {
                    posts = response.data.data || [];
                    totalPosts = response.data.total || 0;
                    currentPage = page;
                    
                    // عرض المنشورات
                    displayPosts(posts);
                    
                    // تحديث التنقل بين الصفحات
                    updatePagination(currentPage, totalPosts, postsPerPage);
                }
            } catch (error) {
                console.error('خطأ في جلب المنشورات:', error);
                document.getElementById('postsContainer').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        حدث خطأ أثناء جلب المنشورات. يرجى المحاولة مرة أخرى لاحقاً.
                    </div>
                `;
            }
        }

        /* دالة عرض المنشورات */
        function displayPosts(posts) {
            const postsContainer = document.getElementById('postsContainer');
            
            // إذا لم تكن هناك منشورات
            if (!posts || posts.length === 0) {
                postsContainer.innerHTML = `
                    <div class="no-posts-message">
                        <i class="fas fa-comments"></i>
                        <h4>لا توجد منشورات حالياً</h4>
                        <p>كن أول من يشارك في المنتدى! شارك أفكارك وتجاربك المالية مع المجتمع.</p>
                        ${isLoggedIn ? '<button class="btn btn-primary mt-3" onclick="focusOnPostForm()"><i class="fas fa-pen ms-2"></i> إنشاء منشور جديد</button>' : ''}
                    </div>
                `;
                return;
            }
            
            // إنشاء HTML لكل منشور
            let postsHTML = '';
            
            posts.forEach(post => {
                // تنسيق التاريخ
                const postDate = new Date(post.createdAt);
                const formattedDate = postDate.toLocaleDateString('ar-EG', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // إعداد صورة المنشور إذا وجدت
                let imageHTML = '';
                if (post.image) {
                    const imagePath = post.image.startsWith('http') ? post.image : `${baseUrl}/${post.image}`;
                    imageHTML = `<img src="${imagePath}" alt="" class="post-image">`;
                }
                
                // إعداد الصورة الرمزية للمستخدم
                let avatarHTML = '';
                if (post.user && post.user.profileImage) {
                    const avatarPath = post.user.profileImage.startsWith('http') ? post.user.profileImage: `${baseUrl}/${post.user.profileImage}`;
                    avatarHTML = `<img src="${avatarPath}" alt="${post.user.username}">`;
                } else {
                    // إذا لم تكن هناك صورة رمزية، نعرض الحرف الأول من اسم المستخدم
                    const firstLetter = post.user && post.user.username ? post.user.username.charAt(0) : 'م';
                    avatarHTML = firstLetter;
                }
                
                // إعداد عدد التعليقات
                const commentsCount = post.comments ? post.comments.length : 0;
                
                // إنشاء قائمة التعليقات إذا وجدت
                let commentsHTML = '';
                if (post.comments && post.comments.length > 0) {
                    commentsHTML = '<div class="mt-3">';
                    post.comments.forEach(comment => {
                        const commentDate = new Date(comment.date);
                        const formattedCommentDate = commentDate.toLocaleDateString('ar-EG', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        
                        commentsHTML += `
                            <div class="comment">
                                <div class="comment-header">
                                    <span class="comment-user">${comment.user}</span>
                                    <span class="comment-date">${formattedCommentDate}</span>
                                </div>
                                <div class="comment-content">
                                    ${comment.content}
                                </div>
                            </div>
                        `;
                    });
                    commentsHTML += '</div>';
                }
                
                // نموذج إضافة تعليق للمستخدمين المسجلين فقط
                const addCommentForm = isLoggedIn ? `
                    <div class="add-comment-form">
                        <input type="text" placeholder="أضف تعليقك هنا..." class="comment-input" data-post-id="${post._id}">
                        <button type="button" class="btn btn-primary btn-sm add-comment-btn" data-post-id="${post._id}">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                ` : `
                    <div class="login-to-comment mt-3">
                        <small><a href="login.html">تسجيل الدخول</a> لإضافة تعليق</small>
                    </div>
                `;
                
                // بناء HTML للمنشور
                postsHTML += `
                    <div class="post-card" id="post-${post._id}">
                        <div class="post-header">
                            <div class="post-avatar">
                                ${avatarHTML}
                            </div>
                            <div class="post-user-info">
                                <div class="post-username">${post.user ? post.user.username : 'مستخدم'}</div>
                                <div class="post-date">${formattedDate}</div>
                            </div>
                        </div>
                        <div class="post-content">
                            ${post.title ? `<h2 class="post-title">${post.title}</h2>` : ''}
                            <div class="post-text">${post.content}</div>
                            ${imageHTML}
                        </div>
                        <div class="post-footer">
                            <div class="post-reactions">
                                <span class="reactions-count">${post.reactions || 0}</span> إعجاب
                            </div>
                            <div class="post-actions">
                                <button class="post-action-btn like-btn ${isLoggedIn ? '' : 'disabled'}" data-post-id="${post._id}" ${!isLoggedIn ? 'disabled' : ''}>
                                    <i class="fas fa-thumbs-up"></i> إعجاب
                                </button>
                                <button class="post-action-btn comment-btn" data-post-id="${post._id}">
                                    <i class="fas fa-comment"></i> التعليقات (${commentsCount})
                                </button>
                            </div>
                        </div>
                        <div class="comments-container" id="comments-${post._id}">
                            ${commentsHTML}
                            ${addCommentForm}
                        </div>
                    </div>
                `;
            });
            
            postsContainer.innerHTML = postsHTML;
            
            // إضافة مستمعي الأحداث للأزرار
            addEventListenersToPostActions();
            
            // تطبيق تأثيرات الظهور
            animatePostsAppearance();
        }

        /* دالة تحديث التنقل بين الصفحات */
        function updatePagination(currentPage, totalItems, itemsPerPage) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const paginationContainer = document.getElementById('paginationContainer');
            
            if (totalPages <= 1) {
                paginationContainer.style.display = 'none';
                return;
            }
            
            paginationContainer.style.display = 'flex';
            
            let paginationHTML = '<ul class="pagination">';
            
            // زر السابق
            paginationHTML += `
                <li class="pagination-item">
                    <a href="#" class="pagination-link ${currentPage === 1 ? 'disabled' : ''}" data-page="${currentPage - 1}" ${currentPage === 1 ? 'aria-disabled="true"' : ''}>
                        <i class="fas fa-chevron-right"></i> السابق
                    </a>
                </li>
            `;
            
            // أرقام الصفحات
            const maxPagesToShow = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
            let endPage = startPage + maxPagesToShow - 1;
            
            if (endPage > totalPages) {
                endPage = totalPages;
                startPage = Math.max(1, endPage - maxPagesToShow + 1);
            }
            
            if (startPage > 1) {
                paginationHTML += `
                    <li class="pagination-item">
                        <a href="#" class="pagination-link" data-page="1">1</a>
                    </li>
                    ${startPage > 2 ? '<li class="pagination-item"><span class="pagination-link disabled">...</span></li>' : ''}
                `;
            }
            
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <li class="pagination-item">
                        <a href="#" class="pagination-link ${i === currentPage ? 'active' : ''}" data-page="${i}">${i}</a>
                    </li>
                `;
            }
            
            if (endPage < totalPages) {
                paginationHTML += `
                    ${endPage < totalPages - 1 ? '<li class="pagination-item"><span class="pagination-link disabled">...</span></li>' : ''}
                    <li class="pagination-item">
                        <a href="#" class="pagination-link" data-page="${totalPages}">${totalPages}</a>
                    </li>
                `;
            }
            
            // زر التالي
            paginationHTML += `
                <li class="pagination-item">
                    <a href="#" class="pagination-link ${currentPage === totalPages ? 'disabled' : ''}" data-page="${currentPage + 1}" ${currentPage === totalPages ? 'aria-disabled="true"' : ''}>
                        التالي <i class="fas fa-chevron-left"></i>
                    </a>
                </li>
            `;
            
            paginationHTML += '</ul>';
            paginationContainer.innerHTML = paginationHTML;
            
            // إضافة مستمعي الأحداث لأزرار التنقل
            document.querySelectorAll('.pagination-link:not(.disabled)').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = parseInt(this.getAttribute('data-page'));
                    
                    if (page && page !== currentPage) {
                        const sortSelect = document.getElementById('sortPosts');
                        const searchInput = document.getElementById('searchPosts');
                        
                        fetchPosts(
                            page,
                            sortSelect ? sortSelect.value : 'newest',
                            searchInput ? searchInput.value : ''
                        );
                    }
                });
            });
        }

        /* دالة إضافة مستمعي الأحداث لعناصر المنشور التفاعلية */
        function addEventListenersToPostActions() {
            // أزرار الإعجاب
            document.querySelectorAll('.like-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    if (!isLoggedIn) {
                        showLoginAlert();
                        return;
                    }
                    
                    const postId = this.getAttribute('data-post-id');
                    await addReaction(postId, this);
                });
            });
            
            // أزرار التعليقات
            document.querySelectorAll('.comment-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const postId = this.getAttribute('data-post-id');
                    const commentsContainer = document.getElementById(`comments-${postId}`);
                    
                    if (commentsContainer) {
                        commentsContainer.classList.toggle('show');
                        
                        // التركيز على مدخل التعليق إذا كان المستخدم مسجلاً
                        if (isLoggedIn && commentsContainer.classList.contains('show')) {
                            const commentInput = commentsContainer.querySelector('.comment-input');
                            if (commentInput) {
                                commentInput.focus();
                            }
                        }
                    }
                });
            });
            
            // أزرار إضافة تعليق
            document.querySelectorAll('.add-comment-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    if (!isLoggedIn) {
                        showLoginAlert();
                        return;
                    }
                    
                    const postId = this.getAttribute('data-post-id');
                    const commentInput = document.querySelector(`.comment-input[data-post-id="${postId}"]`);
                    
                    if (commentInput && commentInput.value.trim()) {
                        await addComment(postId, commentInput.value.trim());
                        commentInput.value = '';
                    }
                });
            });
            
            // مدخلات التعليق (لإضافة التعليق عند الضغط على Enter)
            document.querySelectorAll('.comment-input').forEach(input => {
                input.addEventListener('keypress', async function(e) {
                    if (e.key === 'Enter' && this.value.trim()) {
                        e.preventDefault();
                        const postId = this.getAttribute('data-post-id');
                        await addComment(postId, this.value.trim());
                        this.value = '';
                    }
                });
            });
        }

        /* دالة إضافة تعليق */
        async function addComment(postId, content) {
            if (!isLoggedIn || !currentUser) {
                showLoginAlert();
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                
                const response = await axios.post(
                    `${baseUrl}/api/posts/${postId}/comments`,
                    { user: currentUser.username, content },
                    {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    }
                );
                
                if (response.data) {
                    // إعادة تحميل المنشورات بعد إضافة التعليق
                    const sortSelect = document.getElementById('sortPosts');
                    const searchInput = document.getElementById('searchPosts');
                    await fetchPosts(
                        currentPage,
                        sortSelect ? sortSelect.value : 'newest',
                        searchInput ? searchInput.value : ''
                    );
                    
                    // فتح قسم التعليقات للمنشور المحدث
                    setTimeout(() => {
                        const commentsContainer = document.getElementById(`comments-${postId}`);
                        if (commentsContainer) {
                            commentsContainer.classList.add('show');
                        }
                    }, 300);
                }
            } catch (error) {
                console.error('خطأ في إضافة التعليق:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ!',
                    text: 'حدث خطأ أثناء إضافة التعليق. يرجى المحاولة مرة أخرى.',
                    confirmButtonText: 'حسناً'
                });
            }
        }

        /* دالة إضافة رد فعل (إعجاب) */
        async function addReaction(postId, button) {
            if (!isLoggedIn) {
                showLoginAlert();
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                
                const response = await axios.post(
                    `${baseUrl}/api/posts/${postId}/reactions`,
                    {},
                    {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    }
                );
                
                if (response.data) {
                    // تحديث عداد الإعجابات محلياً
                    const reactionsElement = button.closest('.post-footer').querySelector('.reactions-count');
                    if (reactionsElement) {
                        const currentCount = parseInt(reactionsElement.textContent);
                        reactionsElement.textContent = currentCount + 1;
                    }
                    
                    // تطبيق تأثير بصري للإعجاب
                    button.classList.add('text-primary');
                    gsap.from(button, {
                        scale: 1.5,
                        duration: 0.3,
                        ease: 'power2.out'
                    });
                }
            } catch (error) {
                console.error('خطأ في إضافة الإعجاب:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ!',
                    text: 'حدث خطأ أثناء إضافة الإعجاب. يرجى المحاولة مرة أخرى.',
                    confirmButtonText: 'حسناً'
                });
            }
        }

        /* دالة عرض تنبيه تسجيل الدخول */
        function showLoginAlert() {
            Swal.fire({
                icon: 'info',
                title: 'تسجيل الدخول مطلوب',
                text: 'يجب تسجيل الدخول للمشاركة في المنتدى.',
                showCancelButton: true,
                confirmButtonText: 'تسجيل الدخول',
                cancelButtonText: 'لاحقاً'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = 'login.html';
                }
            });
        }

        /* دالة إنشاء منشور جديد */
        async function createNewPost(formData) {
            if (!isLoggedIn || !currentUser) {
                showLoginAlert();
                return;
            }
            
            try {
                // عرض حالة التحميل
                const submitButton = document.getElementById('submitPost');
                const originalText = submitButton.innerHTML;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري النشر...';
                submitButton.disabled = true;
                
                const token = localStorage.getItem('token');
                
                // تجهيز بيانات المنشور
                const postTitle = document.getElementById('postTitle').value;
                const postContent = document.getElementById('postContent').value;
                const postImage = document.getElementById('postImage').files[0];
                
                if (!postContent) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'تنبيه!',
                        text: 'يجب إدخال محتوى المنشور.',
                        confirmButtonText: 'حسناً'
                    });
                    submitButton.innerHTML = originalText;
                    submitButton.disabled = false;
                    return;
                }
                
                // إنشاء كائن FormData لإرسال الملفات
                const postFormData = new FormData();
                if (postTitle) postFormData.append('title', postTitle);
                postFormData.append('content', postContent);
                if (postImage) postFormData.append('image', postImage);
                
                // إضافة بيانات المستخدم
                postFormData.append('user[username]', currentUser.username);
                postFormData.append('user[profileImage]', currentUser.profileImage || '');
                
                const response = await axios.post(
                    `${baseUrl}/api/posts`,
                    postFormData,
                    {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'multipart/form-data'
                        }
                    }
                );
                
                if (response.data) {
                    // إعادة تهيئة النموذج
                    document.getElementById('postForm').reset();
                    document.getElementById('fileName').textContent = 'لم يتم اختيار ملف';
                    document.getElementById('previewContainer').style.display = 'none';
                    
                    // عرض رسالة نجاح
                    Swal.fire({
                        icon: 'success',
                        title: 'تم!',
                        text: 'تم نشر المنشور بنجاح.',
                        confirmButtonText: 'حسناً'
                    });
                    
                    // إعادة تحميل المنشورات
                    await fetchPosts(1, 'newest');
                }
            } catch (error) {
                console.error('خطأ في إنشاء المنشور:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ!',
                    text: 'حدث خطأ أثناء نشر المنشور. يرجى المحاولة مرة أخرى.',
                    confirmButtonText: 'حسناً'
                });
            } finally {
                // استعادة حالة الزر
                const submitButton = document.getElementById('submitPost');
                submitButton.innerHTML = '<i class="fas fa-paper-plane ms-2"></i> نشر';
                submitButton.disabled = false;
            }
        }

        /* دالة التركيز على نموذج إنشاء المنشور */
        function focusOnPostForm() {
            const postContent = document.getElementById('postContent');
            if (postContent) {
                postContent.scrollIntoView({ behavior: 'smooth', block: 'start' });
                setTimeout(() => {
                    postContent.focus();
                }, 500);
            }
        }

        /* دالة تنفيذ تأثيرات ظهور المنشورات */
        function animatePostsAppearance() {
            gsap.from('.post-card', {
                y: 50,
                opacity: 0,
                stagger: 0.1,
                duration: 0.5,
                ease: 'power2.out'
            });
        }


        
        /* إعداد مستمعي الأحداث لنموذج المنشور */
        function setupPostForm() {
            // معاينة الصورة عند اختيارها
            const postImage = document.getElementById('postImage');
            const fileName = document.getElementById('fileName');
            const previewContainer = document.getElementById('previewContainer');
            const previewImage = document.getElementById('previewImage');
            
            postImage.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    const file = this.files[0];
                    fileName.textContent = file.name;
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        previewImage.src = e.target.result;
                        previewContainer.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                } else {
                    fileName.textContent = 'لم يتم اختيار ملف';
                    previewContainer.style.display = 'none';
                }
            });
            
            // حذف الصورة
            const removeImage = document.getElementById('removeImage');
            removeImage.addEventListener('click', function() {
                postImage.value = '';
                fileName.textContent = 'لم يتم اختيار ملف';
                previewContainer.style.display = 'none';
            });
            
            // إرسال النموذج
            const postForm = document.getElementById('postForm');
            postForm.addEventListener('submit', function(e) {
                e.preventDefault();
                createNewPost();
            });
        }

        /* إعداد مستمعي الأحداث للفلاتر والبحث */
        function setupFilters() {
            // مستمع لتغيير ترتيب المنشورات
            const sortSelect = document.getElementById('sortPosts');
            sortSelect.addEventListener('change', function() {
                fetchPosts(1, this.value, document.getElementById('searchPosts').value);
            });
            
            // مستمع للبحث
            const searchButton = document.getElementById('searchButton');
            searchButton.addEventListener('click', function() {
                const searchValue = document.getElementById('searchPosts').value;
                fetchPosts(1, document.getElementById('sortPosts').value, searchValue);
            });
            
            // البحث عند الضغط على Enter
            const searchInput = document.getElementById('searchPosts');
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    fetchPosts(1, document.getElementById('sortPosts').value, this.value);
                }
            });
        }

        /* دالة اكتشاف وضع الألوان المفضل */
        // function detectColorScheme() {
        //     // التحقق من التفضيل المحفوظ في localStorage
        //     if (localStorage.getItem('theme') === 'light') {
        //         document.body.classList.add('light-mode');
        //     } else if (localStorage.getItem('theme') === 'dark') {
        //         document.body.classList.remove('light-mode');
        //     } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        //         // التحقق من تفضيلات المتصفح إذا لم يكن هناك تفضيل محفوظ
        //         document.body.classList.add('dark-mode');
        //     }
            

            // الاستماع للتغييرات في تفضيلات النظام
        //     window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
        //         if (!localStorage.getItem('theme')) {
        //             if (event.matches) {
        //                 document.body.classList.add('dark-mode');
        //                 document.body.classList.remove('light-mode');
        //             } else {
        //                 document.body.classList.add('light-mode');
        //                 document.body.classList.remove('dark-mode');
        //             }
        //         }
        //     });
        // }
        

        /* تهيئة الصفحة عند التحميل */
        window.addEventListener('DOMContentLoaded', async function() {
            // اكتشاف وضع الألوان المفضل
            // detectColorScheme();
            
            // التحقق من حالة تسجيل الدخول
            await checkLoginStatus();
            
            // جلب المنشورات الأولية
            await fetchPosts();
            
            // إعداد نموذج إنشاء المنشور
            setupPostForm();
            
            // إعداد الفلاتر والبحث
            setupFilters();
        });



        // هذا الكود الخاص بتفعيل زر الرجوع للأعلى 
        // زر الذهاب إلى الأعلى
// زر الذهاب إلى الأعلى
const scrollToTopBtn = document.getElementById("scrollToTopBtn");

// إظهار الزر عند التمرير لأسفل
window.onscroll = function() {
    if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
        scrollToTopBtn.style.opacity = "1";
        scrollToTopBtn.style.visibility = "visible";
    } else {
        scrollToTopBtn.style.opacity = "0";
        scrollToTopBtn.style.visibility = "hidden";
    }
};

// الانتقال إلى نموذج إنشاء المنشور عند النقر
scrollToTopBtn.addEventListener('click', function() {
    const postForm = document.getElementById('postContent');
    if (postForm) {
        postForm.scrollIntoView({
            behavior: "smooth",
            block: "start"
        });
        postForm.focus(); // التركيز على حقل المحتوى
    }
});
    window.scrollTo({
        top: 0,
        behavior: "smooth"
    });

   
   
   </script>
</body>
</html>