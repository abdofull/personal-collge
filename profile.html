<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <!-- تعريف مجموعة الأحرف -->
    <meta charset="UTF-8">
    
    <!-- إعدادات العرض لتكون متجاوبة مع جميع أحجام الشاشات -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- عنوان الصفحة -->
    <title>الملف الشخصي - نظام المالية الشخصية</title>
    
    <!-- روابط لملفات CSS الخارجية -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- مكتبة SweetAlert2 لعرض التنبيهات -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- مكتبة Chart.js للرسوم البيانية -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- مكتبة Axios للاتصال بالخادم -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    
    <!-- ملف JavaScript الخاص بالتطبيق -->
    <script src="public/js/main.js"></script>
    <link rel="stylesheet" href="public/styles/profile.css">
    


</head>
<body>
    <!-- حاوية الإشعارات -->
    <div id="notificationContainer"></div>

    <!-- شريط التنقل العلوي -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <!-- عنوان التطبيق مع الأيقونة -->
            <a class="navbar-brand" href="dashboard.html">
                <i class="fas fa-user"></i>
             الملف الشخصي
            </a>

            <li class="nav-item" style="margin-right: 20px;">
                <a class="nav-link" id="themeToggle" href="#" style="font-size: 20px;">
                    <i class="fas fa-moon"></i>
                </a>
            </li>
            
            
            <!-- زر القائمة المنسدلة للشاشات الصغيرة -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation" style='background-color:rgb(216, 149, 149)'>
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <!-- عناصر القائمة -->
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <!-- رابط لوحة التحكم -->
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">
                            <i class="fas fa-chart-line"></i> لوحة التحكم
                        </a>
                    </li>
                    
                    <!-- رابط المعاملات -->
                    <li class="nav-item">
                        <a class="nav-link" href="Transctionshow.html">
                            <i class="fas fa-exchange-alt"></i> المعاملات
                        </a>
                    </li>
                    
                    <!-- رابط الميزانية (الصفحة الحالية) -->
                    <li class="nav-item">
                        <a class="nav-link" href="Budget.html">
                            <i class="fas fa-wallet"></i> الميزانية
                        </a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link" href="goals.html">
                            <i class="fas fa-bullseye"></i> الخطط والأهداف
                        </a>
                    </li>
                    
                    <!-- رابط التقارير -->
                    <li class="nav-item">
                        <a class="nav-link" href="report.html">
                            <i class="fas fa-chart-line"></i> التقارير
                        </a>
                    </li>
                    
                    <!-- رابط تسجيل الخروج -->
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="logout()" style="color: var(--danger-color);">
                            <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
                        </a>
                    </li>
                </ul>
                
                <!-- قسم معلومات المستخدم -->
                <div class="d-flex align-items-center">
                    <a class="nav-link" href="profile.html">
                        <div id="user-info" class="d-flex align-items-center">
                            <div class="user-avatar">م</div>
                            <div class="user-info">
                                <span class="user-name">محمد أحمد</span>
                                <span class="user-role">مدير النظام</span>
                            </div>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- المحتوى الرئيسي -->
    <div class="content">
        <div class="profile-header">
            <div class="profile-cover"></div>
            <div class="profile-avatar-container">
                <div class="profile-avatar" id="profileAvatar">
                    <img id="profileImage" src="default-image.png" alt="صورة المستخدم">
                </div>
                <div class="profile-avatar-edit" id="avatarEditBtn" title="تغيير الصورة الشخصية">
                    <i class="fas fa-camera"></i>
                    <input type="file" id="avatarUpload" accept="image/*" style="display: none;">
                </div>
            </div>
            <h1 class="profile-name" id="profileUsername">اسم المستخدم</h1>
            <p class="profile-email" id="profileEmail">user@example.com</p>
            <p class="profile-since" id="profileSince">عضو منذ <span id="profileDate">يناير 2023</span></p>
        </div>

        <!-- بطاقات الإحصائيات -->
        <div class="profile-stats">
            <div class="stat-card blue-card">
                <i class="fas fa-wallet icon"></i>
                <div>
                    <p class="subtitle">الرصيد الحالي</p>
                    <h3 id="currentBalance">0.00</h3>
                </div>
                <p>دينار</p>
            </div>
            
            <div class="stat-card purple-card">
                <i class="fas fa-chart-pie icon"></i>
                <div>
                    <p class="subtitle">إجمالي الإيرادات</p>
                    <h3 id="totalIncome">0.00</h3>
                </div>
                <p>دينار</p>
            </div>
            
            <div class="stat-card green-card">
                <i class="fas fa-shopping-cart icon"></i>
                <div>
                    <p class="subtitle">إجمالي المصروفات</p>
                    <h3 id="totalExpenses">0.00</h3>
                </div>
                <p>دينار</p>
            </div>
            
            <div class="stat-card orange-card">
                <i class="fas fa-clipboard-list icon"></i>
                <div>
                    <p class="subtitle">عدد المعاملات</p>
                    <h3 id="transactionsCount">0</h3>
                </div>
                <p>معاملة</p>
            </div>
        </div>

        <!-- تبويبات الإعدادات والمعلومات -->
        <div class="card">
            <div class="card-body">
                <div class="profile-tabs">
                    <button class="profile-tab active" data-tab="account-info">
                        <i class="fas fa-user me-2"></i> المعلومات الشخصية
                    </button>
                    <button class="profile-tab" data-tab="security">
                        <i class="fas fa-lock me-2"></i> الأمان
                    </button>
                    <button class="profile-tab" data-tab="activity">
                        <i class="fas fa-history me-2"></i> النشاط الأخير
                    </button>
                    <button class="profile-tab" data-tab="preferences">
                        <i class="fas fa-sliders-h me-2"></i> التفضيلات
                    </button>
                </div>

                <!-- معلومات الحساب -->
                <div class="tab-content active" id="account-info-tab">
                    <div class="profile-section">
                        <div class="profile-section-header">
                            <h3 class="profile-section-title">
                                <i class="fas fa-user-circle"></i>
                                معلومات الحساب
                            </h3>
                        </div>
                        <form id="accountInfoForm">
                            <div class="row mb-3">
                                <div class="col-md-6 mb-3">
                                    <label for="username" class="form-label">اسم المستخدم</label>
                                    <input type="text" class="form-control" id="username" placeholder="أدخل اسم المستخدم">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="email" class="form-label">البريد الإلكتروني</label>
                                    <input type="email" class="form-control" id="email" placeholder="أدخل البريد الإلكتروني">
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6 mb-3">
                                    <label for="initialBalance" class="form-label">الرصيد الأولي</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="initialBalance" placeholder="0.00" step="0.01" min="0">
                                        <span class="input-group-text">دينار</span>
                                    </div>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i> حفظ التغييرات
                            </button>
                        </form>
                    </div>
                </div>

                <!-- أمان الحساب -->
                <div class="tab-content" id="security-tab">
                    <div class="profile-section">
                        <div class="profile-section-header">
                            <h3 class="profile-section-title">
                                <i class="fas fa-lock"></i>
                                تغيير كلمة المرور
                            </h3>
                        </div>
                        <form id="passwordChangeForm">
                            <div class="mb-3">
                                <label for="currentPassword" class="form-label">كلمة المرور الحالية</label>
                                <input type="password" class="form-control" id="currentPassword" placeholder="أدخل كلمة المرور الحالية">
                            </div>
                            <div class="mb-3">
                                <label for="newPassword" class="form-label">كلمة المرور الجديدة</label>
                                <input type="password" class="form-control" id="newPassword" placeholder="أدخل كلمة المرور الجديدة">
                            </div>
                            <div class="mb-3">
                                <label for="confirmPassword" class="form-label">تأكيد كلمة المرور</label>
                                <input type="password" class="form-control" id="confirmPassword" placeholder="أعد إدخال كلمة المرور الجديدة">
                            </div>
                            <div class="mb-4 password-strength" id="passwordStrength">
                                <div class="progress" style="height: 5px;">
                                    <div class="progress-bar bg-danger" role="progressbar" style="width: 0%" id="passwordStrengthBar"></div>
                                </div>
                                <small class="text-muted mt-1" id="passwordStrengthText">قوة كلمة المرور</small>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-key me-2"></i> تغيير كلمة المرور
                            </button>
                        </form>

                        <div class="mt-4 pt-4 border-top">
                            <h3 class="profile-section-title mb-3">
                                <i class="fas fa-trash-alt"></i>
                                حذف الحساب
                            </h3>
                            <p class="text-muted mb-3">سيؤدي حذف حسابك إلى إزالة جميع بياناتك وسجلاتك بشكل نهائي. هذا الإجراء لا يمكن التراجع عنه.</p>
                            <button class="btn btn-outline-danger" id="deleteAccountBtn">
                                <i class="fas fa-trash-alt me-2"></i> حذف الحساب
                            </button>
                        </div>
                    </div>
                </div>

                <!-- النشاط الأخير -->
                <div class="tab-content" id="activity-tab">
                    <div class="profile-section">
                        <div class="profile-section-header">
                            <h3 class="profile-section-title">
                                <i class="fas fa-history"></i>
                                آخر المعاملات
                            </h3>
                        </div>
                        <div class="table-responsive">
                            <table class="recent-transactions">
                                <thead>
                                    <tr>
                                        <th>العنوان</th>
                                        <th>الفئة</th>
                                        <th>التاريخ</th>
                                        <th>المبلغ</th>
                                        <th>النوع</th>
                                    </tr>
                                </thead>
                                <tbody id="recentTransactionsTable">
                                    <!-- سيتم ملء هذا الجدول بالبيانات من الخادم -->
                                </tbody>
                            </table>
                        </div>
                        <div class="text-center mt-3">
                            <a href="Transctionshow.html" class="btn btn-outline-primary">
                                <i class="fas fa-list me-2"></i> عرض جميع المعاملات
                            </a>
                        </div>
                    </div>
                </div>

                <!-- التفضيلات -->
                <div class="tab-content" id="preferences-tab">
                    <div class="profile-section">
                        <div class="profile-section-header">
                            <h3 class="profile-section-title">
                                <i class="fas fa-palette"></i>
                                تخصيص الواجهة
                            </h3>
                        </div>
                        <div class="row mb-4">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">الوضع</label>
                                <div class="d-flex">
                                    <button class="btn btn-outline-primary me-2" id="lightModeBtn">
                                        <i class="fas fa-sun me-2"></i> نهاري
                                    </button>
                                    <button class="btn btn-outline-primary" id="darkModeBtn">
                                        <i class="fas fa-moon me-2"></i> ليلي
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">لون الخلفية</label>
                                <div class="input-group">
                                    <input type="color" class="form-control form-control-color" id="backgroundColor" value="#1c1f2b">
                                    <button class="btn btn-primary" id="applyBgColorBtn">
                                        تطبيق
                                    </button>
                                    <button class="btn btn-outline-secondary" id="resetBgColorBtn">
                                        إعادة ضبط
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="profile-section-header">
                            <h3 class="profile-section-title">
                                <i class="fas fa-bell"></i>
                                الإشعارات
                            </h3>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="emailNotifications" checked>
                                <label class="form-check-label" for="emailNotifications">إشعارات البريد الإلكتروني</label>
                            </div>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="budgetAlerts" checked>
                                <label class="form-check-label" for="budgetAlerts">تنبيهات تجاوز الميزانية</label>
                            </div>
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="monthlyReports" checked>
                                <label class="form-check-label" for="monthlyReports">تقارير شهرية</label>
                            </div>
                        </div>
                        <button class="btn btn-primary" id="savePreferencesBtn">
                            <i class="fas fa-save me-2"></i> حفظ التفضيلات
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- التذييل -->
    <footer class="footer text-center py-3 mt-5" style="background-color: var(--secondary-color); color: var(--light-color);">
        <div class="container">
            <p class="mb-0">© 2023 نظام إدارة المالية الشخصية. جميع الحقوق محفوظة.</p>
        </div>
    </footer>

    <!-- مكتبات JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        //const url = 'http://localhost:9050/';
        
        // تهيئة الصفحة عند التحميل
        window.onload = function() {
            // تحميل بيانات المستخدم
            fetchUserData();

            
            // تطبيق لون الخلفية المحفوظ
            applyBackgroundColor();
            
            // تهيئة تبويبات الملف الشخصي
            initializeTabs();
            
            // تهيئة نماذج الإدخال
            initializeForms();
            
            // تحميل البيانات الإحصائية
            loadUserStatistics();
            
            // تحميل آخر المعاملات
            loadRecentTransactions();
            
            // تهيئة تحميل الصورة الشخصية
            initializeImageUpload();
            
            // تهيئة أزرار وضع الألوان
            initializeThemeButtons();
        };

        // تبديل التبويبات
        function initializeTabs() {
            const tabs = document.querySelectorAll('.profile-tab');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // إزالة الفئة النشطة من جميع التبويبات
                    tabs.forEach(t => t.classList.remove('active'));
                    
                    // إضافة الفئة النشطة للتبويب المحدد
                    this.classList.add('active');
                    
                    // إخفاء جميع محتويات التبويبات
                    const tabContents = document.querySelectorAll('.tab-content');
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // إظهار محتوى التبويب المحدد
                    const tabId = this.getAttribute('data-tab') + '-tab';
                    document.getElementById(tabId).classList.add('active');
                });
            });
        }

        // تهيئة النماذج
        function initializeForms() {
            // نموذج معلومات الحساب
            document.getElementById('accountInfoForm').addEventListener('submit', function(e) {
                e.preventDefault();
                updateAccountInfo();
            });
            
            // نموذج تغيير كلمة المرور
            document.getElementById('passwordChangeForm').addEventListener('submit', function(e) {
                e.preventDefault();
                changePassword();
            });
            
            // زر حذف الحساب
            document.getElementById('deleteAccountBtn').addEventListener('click', function() {
                confirmDeleteAccount();
            });
            
            // تقييم قوة كلمة المرور
            document.getElementById('newPassword').addEventListener('input', function() {
                checkPasswordStrength(this.value);
            });
            
            // حفظ التفضيلات
            document.getElementById('savePreferencesBtn').addEventListener('click', function() {
                savePreferences();
            });
            
            // تطبيق لون الخلفية
            document.getElementById('applyBgColorBtn').addEventListener('click', function() {
                const color = document.getElementById('backgroundColor').value;
                localStorage.setItem('backgroundColor', color);
                applyBackgroundColor();
                showNotification('تم تغيير لون الخلفية بنجاح', 'success');
            });
            
            // إعادة ضبط لون الخلفية
            document.getElementById('resetBgColorBtn').addEventListener('click', function() {
                localStorage.removeItem('backgroundColor');
                document.body.style.backgroundColor = '';
                document.getElementById('backgroundColor').value = '#1c1f2b';
                showNotification('تم إعادة ضبط لون الخلفية', 'success');
            });
        }

        // تهيئة أزرار وضع الألوان
        function initializeThemeButtons() {
            document.getElementById('lightModeBtn').addEventListener('click', function() {
                document.body.classList.add('light-mode');
                localStorage.setItem('theme', 'light');
                updateThemeIcon(true);
                showNotification('تم تفعيل الوضع النهاري', 'success');
            });
            
            document.getElementById('darkModeBtn').addEventListener('click', function() {
                document.body.classList.remove('light-mode');
                localStorage.setItem('theme', 'dark');
                updateThemeIcon(false);
                showNotification('تم تفعيل الوضع الليلي', 'success');
            });
        }

        // تحديث معلومات الحساب
        async function updateAccountInfo() {
            try {
                const token = localStorage.getItem('token');
                const userId = localStorage.getItem('userId');
                
                if (!token || !userId) {
                    showNotification('يجب تسجيل الدخول أولاً', 'error');
                    return;
                }
                
                const username = document.getElementById('username').value;
                const email = document.getElementById('email').value;
                const initialBalance = parseFloat(document.getElementById('initialBalance').value);
                
                // التحقق من صحة البيانات
                if (!username || !email) {
                    showNotification('يرجى إدخال جميع البيانات المطلوبة', 'error');
                    return;
                }
                
                // تحديث اسم المستخدم والبريد الإلكتروني
                const userResponse = await axios.put(`${url}settings/${userId}`, 
                    { username, email },
                    { headers: { Authorization: `Bearer ${token}` } }
                );
                
                // تحديث الرصيد الأولي
                const balanceResponse = await axios.put(`${url}updateBalance`, 
                    { userId, initialBalance },
                    { headers: { Authorization: `Bearer ${token}` } }
                );
                
                showNotification('تم تحديث معلومات الحساب بنجاح', 'success');
                
                // تحديث واجهة المستخدم
                document.getElementById('profileUsername').textContent = username;
                document.getElementById('profileEmail').textContent = email;
                
                        // تحديث localStorage
                    const userData = JSON.parse(localStorage.getItem('userData'));
                    userData.username = username;
                    userData.email = email;
                    localStorage.setItem('userData', JSON.stringify(userData));

                // إعادة تحميل بيانات المستخدم لتحديث الناف بار
                fetchUserData();
                
                // تحديث الإحصائيات
                loadUserStatistics();
                
            } catch (error) {
                console.error('حدث خطأ أثناء تحديث معلومات الحساب:', error);
                
                let errorMessage = 'حدث خطأ أثناء تحديث معلومات الحساب';
                if (error.response && error.response.data && error.response.data.message) {
                    errorMessage = error.response.data.message;
                }
                
                showNotification(errorMessage, 'error');
            }
        }

        // تغيير كلمة المرور
        async function changePassword() {
            try {
                const token = localStorage.getItem('token');
                const userId = localStorage.getItem('userId');
                
                if (!token || !userId) {
                    showNotification('يجب تسجيل الدخول أولاً', 'error');
                    return;
                }
                
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                // التحقق من صحة البيانات
                if (!currentPassword || !newPassword || !confirmPassword) {
                    showNotification('يرجى إدخال جميع البيانات المطلوبة', 'error');
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    showNotification('كلمة المرور الجديدة غير متطابقة مع التأكيد', 'error');
                    return;
                }
                
                // التحقق من قوة كلمة المرور
                if (newPassword.length < 6) {
                    showNotification('كلمة المرور يجب أن تكون على الأقل 6 أحرف', 'error');
                    return;
                }
                
                // إرسال الطلب لتغيير كلمة المرور
                const response = await axios.put(`${url}changePassword/${userId}`, 
                    { currentPassword, newPassword },
                    { headers: { Authorization: `Bearer ${token}` } }
                );
                
                showNotification('تم تغيير كلمة المرور بنجاح', 'success');
                
                // إعادة تعيين النموذج
                document.getElementById('passwordChangeForm').reset();
                document.getElementById('passwordStrengthBar').style.width = '0%';
                document.getElementById('passwordStrengthBar').className = 'progress-bar bg-danger';
                document.getElementById('passwordStrengthText').textContent = 'قوة كلمة المرور';
                
            } catch (error) {
                console.error('حدث خطأ أثناء تغيير كلمة المرور:', error);
                
                let errorMessage = 'حدث خطأ أثناء تغيير كلمة المرور';
                if (error.response && error.response.data && error.response.data.message) {
                    errorMessage = error.response.data.message;
                }
                
                showNotification(errorMessage, 'error');
            }
        }

        // التحقق من قوة كلمة المرور
        function checkPasswordStrength(password) {
            const strengthBar = document.getElementById('passwordStrengthBar');
            const strengthText = document.getElementById('passwordStrengthText');
            
            let strength = 0;
            
            if (password.length === 0) {
                strengthBar.style.width = '0%';
                strengthBar.className = 'progress-bar bg-danger';
                strengthText.textContent = 'قوة كلمة المرور';
                return;
            }
            
            // إضافة نقاط بناءً على طول كلمة المرور
            if (password.length > 5) strength += 20;
            if (password.length > 8) strength += 10;
            
            // إضافة نقاط بناءً على تنوع الأحرف
            if (password.match(/[a-z]+/)) strength += 10;
            if (password.match(/[A-Z]+/)) strength += 15;
            if (password.match(/[0-9]+/)) strength += 15;
            if (password.match(/[^a-zA-Z0-9]+/)) strength += 15;
            
            // تعيين عرض شريط القوة
            strengthBar.style.width = `${strength}%`;
            
            // تعيين لون ونص شريط القوة
            if (strength < 40) {
                strengthBar.className = 'progress-bar bg-danger';
                strengthText.textContent = 'ضعيفة';
            } else if (strength < 70) {
                strengthBar.className = 'progress-bar bg-warning';
                strengthText.textContent = 'متوسطة';
            } else {
                strengthBar.className = 'progress-bar bg-success';
                strengthText.textContent = 'قوية';
            }
        }

        // تأكيد حذف الحساب
        function confirmDeleteAccount() {
            Swal.fire({
                title: 'هل أنت متأكد؟',
                text: 'سيتم حذف حسابك وجميع بياناتك بشكل نهائي! هذا الإجراء لا يمكن التراجع عنه.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'نعم، احذف الحساب',
                cancelButtonText: 'إلغاء',
                customClass: {
                    popup: 'rtl-popup'
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    deleteAccount();
                }
            });
        }

        // حذف الحساب
        async function deleteAccount() {
            try {
                const token = localStorage.getItem('token');
                const userId = localStorage.getItem('userId');
                
                if (!token || !userId) {
                    showNotification('يجب تسجيل الدخول أولاً', 'error');
                    return;
                }
                
                // إرسال الطلب لحذف الحساب
                const response = await axios.delete(`${url}logout/${userId}`, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                
                Swal.fire({
                    icon: 'success',
                    title: 'تم حذف الحساب',
                    text: 'تم حذف حسابك وجميع بياناتك بنجاح.',
                    confirmButtonText: 'حسناً',
                    customClass: {
                        popup: 'rtl-popup'
                    }
                }).then(() => {
                    // تسجيل الخروج وإعادة التوجيه إلى صفحة تسجيل الدخول
                    localStorage.clear();
                    window.location.href = 'index.html';
                });
                
            } catch (error) {
                console.error('حدث خطأ أثناء حذف الحساب:', error);
                
                let errorMessage = 'حدث خطأ أثناء حذف الحساب';
                if (error.response && error.response.data && error.response.data.message) {
                    errorMessage = error.response.data.message;
                }
                
                showNotification(errorMessage, 'error');
            }
        }

        // تحميل الإحصائيات
        async function loadUserStatistics() {
            try {
                const token = localStorage.getItem('token');
                const userId = localStorage.getItem('userId');
                
                if (!token || !userId) {
                    return;
                }
                
                // جلب الرصيد الأولي
                const initialBalanceResponse = await axios.get(`${url}getInitialBalance?userId=${userId}`, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                
                const initialBalance = initialBalanceResponse.data.initialBalance || 0;
                document.getElementById('initialBalance').value = initialBalance;
                
                // جلب إجمالي الدخل والمصروفات
                const totalsResponse = await axios.get(`${url}api/transactions/totals?userId=${userId}`, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                
                const totalIncome = totalsResponse.data.totalIncome || 0;
                const totalExpenses = totalsResponse.data.totalExpenses || 0;
                
                // حساب الرصيد الحالي
                const currentBalance = initialBalance + totalIncome - totalExpenses;
                
                // تحديث الإحصائيات في واجهة المستخدم
                document.getElementById('currentBalance').textContent = currentBalance.toFixed(2);
                document.getElementById('totalIncome').textContent = totalIncome.toFixed(2);
                document.getElementById('totalExpenses').textContent = totalExpenses.toFixed(2);
                
                // جلب عدد المعاملات
                const transactionsResponse = await axios.get(`${url}api/transactions?userId=${userId}`, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                
                const transactionsCount = transactionsResponse.data.length || 0;
                document.getElementById('transactionsCount').textContent = transactionsCount;
                
            } catch (error) {
                console.error('حدث خطأ أثناء تحميل الإحصائيات:', error);
            }
        }

        // تحميل آخر المعاملات
        async function loadRecentTransactions() {
            try {
                const token = localStorage.getItem('token');
                const userId = localStorage.getItem('userId');
                
                if (!token || !userId) {
                    return;
                }
                
                const response = await axios.get(`${url}api/transactions?userId=${userId}`, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                
                // أخذ آخر 5 معاملات فقط
                const recentTransactions = response.data.slice(0, 5);
                
                const tableBody = document.getElementById('recentTransactionsTable');
                tableBody.innerHTML = '';
                
                if (recentTransactions.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center">لا توجد معاملات حتى الآن</td>
                        </tr>
                    `;
                    return;
                }
                
                recentTransactions.forEach(transaction => {
                    const row = document.createElement('tr');
                    
                    // تنسيق التاريخ
                    const date = new Date(transaction.createdAt);
                    const formattedDate = `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
                    
                    // نوع المعاملة (دخل أو مصروف)
                    const typeClass = transaction.type === 'income' ? 'income' : 'expense';
                    const typeText = transaction.type === 'income' ? 'دخل' : 'مصروف';
                    
                    row.innerHTML = `
                        <td>${transaction.description || 'بدون عنوان'}</td>
                        <td>${transaction.category || 'بدون تصنيف'}</td>
                        <td>${formattedDate}</td>
                        <td>${transaction.amount.toFixed(2)} دينار</td>
                        <td><span class="transaction-badge ${typeClass}">${typeText}</span></td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
            } catch (error) {
                console.error('حدث خطأ أثناء تحميل المعاملات الأخيرة:', error);
                
                document.getElementById('recentTransactionsTable').innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center">حدث خطأ أثناء تحميل المعاملات</td>
                    </tr>
                `;
            }
        }

        // تهيئة تحميل الصورة الشخصية
        function initializeImageUpload() {
            const avatarEditBtn = document.getElementById('avatarEditBtn');
            const avatarUpload = document.getElementById('avatarUpload');
            
            avatarEditBtn.addEventListener('click', function() {
                avatarUpload.click();
            });
            
            avatarUpload.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    uploadProfileImage(e.target.files[0]);
                }
            });
        }

        // رفع الصورة الشخصية
        async function uploadProfileImage(file) {
            try {
                const token = localStorage.getItem('token');
                const userId = localStorage.getItem('userId');
                
                if (!token || !userId) {
                    showNotification('يجب تسجيل الدخول أولاً', 'error');
                    return;
                }
                
                // التحقق من نوع الملف
                if (!file.type.startsWith('image/')) {
                    showNotification('يرجى اختيار صورة صالحة', 'error');
                    return;
                }
                
                // التحقق من حجم الملف (الحد الأقصى 5 ميجابايت)
                if (file.size > 5 * 1024 * 1024) {
                    showNotification('حجم الصورة كبير جداً. يرجى اختيار صورة أقل من 5 ميجابايت', 'error');
                    return;
                }
                
                // عرض معاينة الصورة قبل الرفع
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('profileImage').src = e.target.result;
                };
                reader.readAsDataURL(file);
                
                // تحميل الصورة
                const formData = new FormData();
                formData.append('profileImage', file);
                
                showNotification('جارٍ رفع الصورة...', 'info');
                
                // إرسال الصورة إلى الخادم
                const response = await axios.put(`${url}updateProfileImage/${userId}`, formData, {
                    headers: {
                        Authorization: `Bearer ${token}`,
                        'Content-Type': 'multipart/form-data'
                    }
                });
                console.log(response.data.user.profileImage);
                showNotification('تم تحديث الصورة الشخصية بنجاح', 'success');
                
                // تحديث الصورة في localStorage
                const userData = JSON.parse(localStorage.getItem('userData'));
                userData.profileImage = response.data.user.profileImage;
                localStorage.setItem('userData', JSON.stringify(userData));
                // تحديث الصورة في الناف بار
                fetchUserData();
                
            } catch (error) {
                console.error('حدث خطأ أثناء رفع الصورة الشخصية:', error);
                
                let errorMessage = 'حدث خطأ أثناء رفع الصورة الشخصية';
                if (error.response && error.response.data && error.response.data.message) {
                    errorMessage = error.response.data.message;
                }
                
                showNotification(errorMessage, 'error');
                
                // إعادة الصورة الافتراضية في حالة الفشل
                document.getElementById('profileImage').src = 'default-image.png';
            }
        }

        // حفظ التفضيلات
        function savePreferences() {
            const emailNotifications = document.getElementById('emailNotifications').checked;
            const budgetAlerts = document.getElementById('budgetAlerts').checked;
            const monthlyReports = document.getElementById('monthlyReports').checked;
            
            // حفظ التفضيلات في localStorage
            const preferences = {
                emailNotifications,
                budgetAlerts,
                monthlyReports
            };
            
            localStorage.setItem('notificationPreferences', JSON.stringify(preferences));
             location.reload(true);       

            showNotification('تم حفظ التفضيلات بنجاح', 'success');
 }

        // تحميل بيانات المستخدم الكاملة
        async function loadUserProfile() {
            try {
                const token = localStorage.getItem('token');
                const userId = localStorage.getItem('userId');
                
                if (!token || !userId) {
                    window.location.href = 'index.html';
                    return;
                }
                
                const response = await axios.get(`${url}users/${userId}`, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                
                const userData = response.data.user;
                
                // تحديث واجهة المستخدم
                document.getElementById('profileUsername').textContent = userData.username;
                document.getElementById('profileEmail').textContent = userData.email;
                
                // تحديث حقول النموذج
                document.getElementById('username').value = userData.username;
                document.getElementById('email').value = userData.email;
                
                // تحديث صورة الملف الشخصي
                if (userData.profileImage) {
                    document.getElementById('profileImage').src = userData.profileImage;
                } else {
                    // استخدام أول حرف من اسم المستخدم إذا لم تكن هناك صورة
                    const avatar = document.getElementById('profileAvatar');
                    if (!userData.profileImage) {
                        avatar.innerHTML = `<div class="d-flex align-items-center justify-content-center h-100 w-100">${userData.username.charAt(0).toUpperCase()}</div>`;
                    }
                }
                
                // تحديث تاريخ الإنضمام
                const createdAt = new Date(userData.createdAt);
                const formattedDate = new Intl.DateTimeFormat('ar-SA', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                }).format(createdAt);
                
                document.getElementById('profileDate').textContent = formattedDate;
                
                // تحميل التفضيلات
                const savedPreferences = localStorage.getItem('notificationPreferences');
                if (savedPreferences) {
                    const preferences = JSON.parse(savedPreferences);
                    document.getElementById('emailNotifications').checked = preferences.emailNotifications;
                    document.getElementById('budgetAlerts').checked = preferences.budgetAlerts;
                    document.getElementById('monthlyReports').checked = preferences.monthlyReports;
                }
                
            } catch (error) {
                console.error('حدث خطأ أثناء تحميل بيانات المستخدم:', error);
                showNotification('حدث خطأ أثناء تحميل بيانات المستخدم', 'error');
            }
        }

        // استدعاء دالة تحميل بيانات المستخدم الكاملة عند تحميل الصفحة
        window.addEventListener('load', function() {
            loadUserProfile();
        });
    </script>
</body>
</html>