<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>المنتدى - نظام المالية الشخصية</title>
    
    <!-- روابط CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css">
    <link rel="stylesheet" href="./styles/main.css">
    <link rel="stylesheet" href="./styles/posts.css">
</head>
<body>
    <!-- شريط التنقل -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-chart-line"></i>
                نظام المالية الشخصية
            </a>
            <li class="nav-item">
                <a class="nav-link" id="themeToggle" href="#">
                    <i class="fas fa-moon" style="font-size: 1.3rem;"></i>
                </a>
            </li>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation" style='background-color:rgb(216, 149, 149)'>
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="fas fa-home"></i> الرئيسية
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="HelpSupport.html">
                            <i class="fas fa-question-circle"></i> الدعم
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- قسم الإشعارات -->
    <div class="notification-container" id="notificationContainer">
        <!-- الإشعارات ستظهر هنا ديناميكيًا -->
    </div>

    <!-- زر الرجوع للأعلى -->
    <button id="scrollToTopBtn" title="الذهاب إلى الأعلى">
        <i class="fas fa-plus"></i>
    </button>

    <!-- المحتوى الرئيسي للمنتدى -->
    <div class="content">
        <div class="forum-container">
            <h1 class="section-title animate__animated animate__fadeIn">
                <i class="fas fa-comments ms-2"></i> منتدى المحاسب الشخصي
            </h1>

            <!-- رسالة تسجيل الدخول للزوار -->
            <div class="login-message" id="loginMessage" style="display:none;">
                <p><i class="fas fa-info-circle ms-2"></i> يجب تسجيل الدخول للمشاركة في المنتدى، بإمكانك فقط قراءة المحتوى كزائر.</p>
                <a href="login.html" class="btn btn-primary btn-sm">تسجيل الدخول</a>
            </div>

            <!-- قسم إنشاء منشور جديد -->
            <div class="create-post-container" id="createPostContainer">
                <div class="create-post-form">
                    <h4 class="mb-4"><i class="fas fa-pen ms-2"></i> إنشاء منشور جديد</h4>
                    <form id="postForm">
                        <div class="form-group">
                            <label for="postTitle" class="form-label">عنوان المنشور (اختياري)</label>
                            <input type="text" id="postTitle" class="form-control" placeholder="أدخل عنوان المنشور">
                        </div>
                        <div class="form-group">
                            <label for="postContent" class="form-label">محتوى المنشور <span class="text-danger">*</span></label>
                            <textarea id="postContent" class="form-control" placeholder="شارك أفكارك وتجاربك المالية هنا..." required></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">صورة (اختياري)</label>
                            <div class="file-input-container">
                                <i class="fas fa-upload"></i>
                                <p>اسحب الصورة أو انقر هنا للتحميل</p>
                                <span class="file-name" id="fileName">لم يتم اختيار ملف</span>
                                <input type="file" class="file-input" id="postImage" accept="image/*">
                            </div>
                            <div class="preview-image-container" id="previewContainer" style="display: none;">
                                <img src="" alt="معاينة" class="preview-image" id="previewImage">
                                <button type="button" class="remove-image-btn" id="removeImage">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="text-center">
                            <button type="submit" class="btn btn-primary" id="submitPost">
                                <i class="fas fa-paper-plane ms-2"></i> نشر
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- فلاتر البحث وترتيب المنشورات -->
            <div class="forum-filters">
                <div class="filter-group">
                    <label for="sortPosts">ترتيب:</label>
                    <select id="sortPosts" class="form-select form-select-sm">
                        <option value="newest">الأحدث</option>
                        <option value="oldest">الأقدم</option>
                        <option value="popular">الأكثر تفاعلاً</option>
                    </select>
                </div>
                <div class="filter-group">
                    <input type="text" id="searchPosts" class="form-control form-control-sm" placeholder="بحث في المنشورات...">
                    <button class="btn btn-sm btn-primary" id="searchButton">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>

            <!-- قائمة المنشورات -->
            <div id="postsContainer">
                <div class="loading-spinner">
                    <div class="spinner"></div>
                </div>
            </div>

            <!-- التنقل بين الصفحات -->
            <div class="pagination-container" id="paginationContainer">
                <!-- ستتم إضافة التنقل بين الصفحات هنا ديناميكيا -->
            </div>
        </div>
    </div>

    <!-- التذييل -->
    <footer class="footer animate__animated animate__fadeIn">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <h6>عن النظام</h6>
                    <p class="text-muted">نظام إدارة المالية الشخصية يساعدك على تتبع دخلك ومصروفاتك بسهولة وكفاءة.</p>
                </div>
                <div class="col-md-4 text-center">
                    <h6>روابط سريعة</h6>
                    <ul class="list-unstyled">
                        <li><a href="#" class="text-muted">الأسئلة الشائعة</a></li>
                        <li><a href="#" class="text-muted">الدعم الفني</a></li>
                        <li><a href="#" class="text-muted">الشروط والأحكام</a></li>
                    </ul>
                </div>
                <div class="col-md-4 text-end">
                    <h6>اتصل بنا</h6>
                    <ul class="list-unstyled">
                        <li><i class="fas fa-envelope me-2"></i> info@example.com</li>
                        <li><i class="fas fa-phone me-2"></i> +962 7 0000 0000</li>
                    </ul>
                </div>
            </div>
            <hr class="mt-3 mb-3">
            <p class="mb-0">© 2023 نظام إدارة المالية الشخصية. جميع الحقوق محفوظة.</p>
        </div>
    </footer>

    <!-- روابط JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="./js/main.js"></script>

    <script>
        // متغيرات عامة
        let currentPage = 1;
        const postsPerPage = 10;
        let totalPosts = 0;
        let isLoggedIn = false;
        let currentUser = null;
        let posts = [];
        const url = 'http://localhost:9050'; // يجب تحديث هذا الرابط حسب احتياجاتك

        // دالة التحقق من حالة تسجيل الدخول
        async function checkLoginStatus() {
            const token = localStorage.getItem('token');
            const userId = localStorage.getItem('userId');

            if (token && userId) {
                isLoggedIn = true;
                currentUser = {
                    id: userId,
                    username: localStorage.getItem('username') || 'مستخدم',
                    profileImage: localStorage.getItem('profileImage') || null,
                    role: localStorage.getItem('role') || 'مستخدم'
                };
                updateUserInterface(true);
                return true;
            } else {
                isLoggedIn = false;
                currentUser = null;
                updateUserInterface(false);
                return false;
            }
        }

        // دالة تحديث واجهة المستخدم بناءً على حالة تسجيل الدخول
        function updateUserInterface(isLoggedIn) {
            const createPostContainer = document.getElementById('createPostContainer');
            const loginMessage = document.getElementById('loginMessage');
            
            if (isLoggedIn) {
                createPostContainer.style.display = 'block';
                loginMessage.style.display = 'none';
            } else {
                createPostContainer.style.display = 'none';
                loginMessage.style.display = 'flex';
            }
        }

        // دالة جلب المنشورات من الخادم
        async function fetchPosts(page = 1, sort = 'newest', search = '') {
            try {
                // عرض حالة التحميل
                document.getElementById('postsContainer').innerHTML = `
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                    </div>
                `;
                
                // بناء رابط API
                let apiUrl = `${url}/api/posts?page=${page}&limit=${postsPerPage}`;
                
                // إضافة معلمات الترتيب
                if (sort === 'oldest') {
                    apiUrl += '&sort=createdAt';
                } else if (sort === 'newest') {
                    apiUrl += '&sort=-createdAt';
                } else if (sort === 'popular') {
                    apiUrl += '&sort=-reactions';
                }
                
                // إضافة معلمات البحث
                if (search) {
                    apiUrl += `&search=${encodeURIComponent(search)}`;
                }

                const response = await axios.get(apiUrl);
                
                if (response.data) {
                    posts = response.data.data || [];
                    totalPosts = response.data.total || 0;
                    currentPage = page;
                    
                    displayPosts(posts);
                    updatePagination(currentPage, totalPosts, postsPerPage);
                }
            } catch (error) {
                console.error('خطأ في جلب المنشورات:', error);
                document.getElementById('postsContainer').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        حدث خطأ أثناء جلب المنشورات. يرجى المحاولة مرة أخرى لاحقاً.
                    </div>
                `;
            }
        }

        // دالة عرض المنشورات
        function displayPosts(posts) {
            const postsContainer = document.getElementById('postsContainer');
            
            if (!posts || posts.length === 0) {
                postsContainer.innerHTML = `
                    <div class="no-posts-message">
                        <i class="fas fa-comments"></i>
                        <h4>لا توجد منشورات حالياً</h4>
                        <p>كن أول من يشارك في المنتدى! شارك أفكارك وتجاربك المالية مع المجتمع.</p>
                        ${isLoggedIn ? '<button class="btn btn-primary mt-3" onclick="focusOnPostForm()"><i class="fas fa-pen ms-2"></i> إنشاء منشور جديد</button>' : ''}
                    </div>
                `;
                return;
            }
            
            let postsHTML = '';
            
            posts.forEach(post => {
                const postDate = new Date(post.createdAt);
                const formattedDate = postDate.toLocaleDateString('ar-EG', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                let imageHTML = '';
                if (post.image) {
                    const imagePath = post.image.startsWith('http') ? post.image : `${url}/${post.image}`;
                    imageHTML = `<img src="${imagePath}" alt="" class="post-image">`;
                }
                
                let avatarHTML = '';
                if (post.user && post.user.profileImage) {
                    const avatarPath = post.user.profileImage.startsWith('http') ? post.user.profileImage : `${url}/${post.user.profileImage}`;
                    avatarHTML = `<img src="${avatarPath}" alt="${post.user.username}">`;
                } else {
                    const firstLetter = post.user && post.user.username ? post.user.username.charAt(0) : 'م';
                    avatarHTML = firstLetter;
                }
                
                const commentsCount = post.comments ? post.comments.length : 0;
                
                let commentsHTML = '';
                if (post.comments && post.comments.length > 0) {
                    commentsHTML = '<div class="mt-3">';
                    post.comments.forEach(comment => {
                        const commentDate = new Date(comment.date);
                        const formattedCommentDate = commentDate.toLocaleDateString('ar-EG', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        
                        commentsHTML += `
                            <div class="comment">
                                <div class="comment-header">
                                    <span class="comment-user">${comment.user}</span>
                                    <span class="comment-date">${formattedCommentDate}</span>
                                </div>
                                <div class="comment-content">
                                    ${comment.content}
                                </div>
                            </div>
                        `;
                    });
                    commentsHTML += '</div>';
                }
                
                const addCommentForm = isLoggedIn ? `
                    <div class="add-comment-form">
                        <input type="text" placeholder="أضف تعليقك هنا..." class="comment-input" data-post-id="${post._id}">
                        <button type="button" class="btn btn-primary btn-sm add-comment-btn" data-post-id="${post._id}">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                ` : `
                    <div class="login-to-comment mt-3">
                        <small><a href="login.html">تسجيل الدخول</a> لإضافة تعليق</small>
                    </div>
                `;
                
                let postControlsHTML = '';
                if (isLoggedIn && currentUser && post.user && 
                    (post.user.username === currentUser.username || currentUser.id === post.userId)) {
                    postControlsHTML = `
                        <div class="post-controls">
                            <button class="post-control-btn edit-btn" data-post-id="${post._id}" title="تعديل المنشور">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="post-control-btn delete-btn" data-post-id="${post._id}" title="حذف المنشور">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                }
                
                postsHTML += `
                    <div class="post-card" id="post-${post._id}">
                        <div class="post-header">
                            <div class="post-avatar">
                                ${avatarHTML}
                            </div>
                            <div class="post-user-info">
                                <div class="post-username">${post.user ? post.user.username : 'مستخدم'}</div>
                                <div class="post-date">${formattedDate}</div>
                            </div>
                            ${postControlsHTML}
                        </div>
                        <div class="post-content">
                            ${post.title ? `<h2 class="post-title">${post.title}</h2>` : ''}
                            <div class="post-text">${post.content}</div>
                            ${imageHTML}
                        </div>
                        <div class="post-footer">
                            <div class="post-reactions">
                                <span class="reactions-count">${post.reactions || 0}</span> إعجاب
                            </div>
                            <div class="post-actions">
                                <button class="post-action-btn like-btn ${isLoggedIn ? '' : 'disabled'}" data-post-id="${post._id}" ${!isLoggedIn ? 'disabled' : ''}>
                                    <i class="fas fa-thumbs-up"></i> إعجاب
                                </button>
                                <button class="post-action-btn comment-btn" data-post-id="${post._id}">
                                    <i class="fas fa-comment"></i> التعليقات (${commentsCount})
                                </button>
                            </div>
                        </div>
                        <div class="comments-container" id="comments-${post._id}">
                            ${commentsHTML}
                            ${addCommentForm}
                        </div>
                    </div>
                `;
            });
            
            postsContainer.innerHTML = postsHTML;
            addEventListenersToPostActions();
            animatePostsAppearance();
        }

        // دالة تحديث التنقل بين الصفحات
        function updatePagination(currentPage, totalItems, itemsPerPage) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const paginationContainer = document.getElementById('paginationContainer');
            
            if (totalPages <= 1) {
                paginationContainer.style.display = 'none';
                return;
            }
            
            paginationContainer.style.display = 'flex';
            
            let paginationHTML = '<ul class="pagination">';
            
            // زر السابق
            paginationHTML += `
                <li class="pagination-item">
                    <a href="#" class="pagination-link ${currentPage === 1 ? 'disabled' : ''}" data-page="${currentPage - 1}" ${currentPage === 1 ? 'aria-disabled="true"' : ''}>
                        <i class="fas fa-chevron-right"></i> السابق
                    </a>
                </li>
            `;
            
            // أرقام الصفحات
            const maxPagesToShow = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
            let endPage = startPage + maxPagesToShow - 1;
            
            if (endPage > totalPages) {
                endPage = totalPages;
                startPage = Math.max(1, endPage - maxPagesToShow + 1);
            }
            
            if (startPage > 1) {
                paginationHTML += `
                    <li class="pagination-item">
                        <a href="#" class="pagination-link" data-page="1">1</a>
                    </li>
                    ${startPage > 2 ? '<li class="pagination-item"><span class="pagination-link disabled">...</span></li>' : ''}
                `;
            }
            
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <li class="pagination-item">
                        <a href="#" class="pagination-link ${i === currentPage ? 'active' : ''}" data-page="${i}">${i}</a>
                    </li>
                `;
            }
            
            if (endPage < totalPages) {
                paginationHTML += `
                    ${endPage < totalPages - 1 ? '<li class="pagination-item"><span class="pagination-link disabled">...</span></li>' : ''}
                    <li class="pagination-item">
                        <a href="#" class="pagination-link" data-page="${totalPages}">${totalPages}</a>
                    </li>
                `;
            }
            
            // زر التالي
            paginationHTML += `
                <li class="pagination-item">
                    <a href="#" class="pagination-link ${currentPage === totalPages ? 'disabled' : ''}" data-page="${currentPage + 1}" ${currentPage === totalPages ? 'aria-disabled="true"' : ''}>
                        التالي <i class="fas fa-chevron-left"></i>
                    </a>
                </li>
            `;
            
            paginationHTML += '</ul>';
            paginationContainer.innerHTML = paginationHTML;
            
            // إضافة مستمعي الأحداث لأزرار التنقل
            document.querySelectorAll('.pagination-link:not(.disabled)').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = parseInt(this.getAttribute('data-page'));
                    
                    if (page && page !== currentPage) {
                        const sortSelect = document.getElementById('sortPosts');
                        const searchInput = document.getElementById('searchPosts');
                        
                        fetchPosts(
                            page,
                            sortSelect ? sortSelect.value : 'newest',
                            searchInput ? searchInput.value : ''
                        );
                    }
                });
            });
        }

        // دالة إضافة مستمعي الأحداث لعناصر المنشور التفاعلية
        function addEventListenersToPostActions() {
            // أزرار الإعجاب
            document.querySelectorAll('.like-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const postId = this.getAttribute('data-post-id');
                    addReaction(postId, this);
                });
            });
            
            // أزرار التعليقات
            document.querySelectorAll('.comment-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const postId = this.getAttribute('data-post-id');
                    const commentsContainer = document.getElementById(`comments-${postId}`);
                    
                    if (commentsContainer) {
                        commentsContainer.classList.toggle('show');
                        
                        const isShowing = commentsContainer.classList.contains('show');
                        this.innerHTML = isShowing ? 
                            '<i class="fas fa-comment"></i> إخفاء التعليقات' : 
                            `<i class="fas fa-comment"></i> التعليقات (${commentsContainer.querySelectorAll('.comment').length})`;
                    }
                });
            });
            
            // أزرار إضافة التعليقات
            document.querySelectorAll('.add-comment-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const postId = this.getAttribute('data-post-id');
                    const input = document.querySelector(`.comment-input[data-post-id="${postId}"]`);
                    
                    if (input && input.value.trim()) {
                        addComment(postId, input.value.trim(), input);
                    }
                });
            });
            
            // مدخلات التعليقات (الضغط على Enter)
            document.querySelectorAll('.comment-input').forEach(input => {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const postId = this.getAttribute('data-post-id');
                        
                        if (this.value.trim()) {
                            addComment(postId, this.value.trim(), this);
                        }
                    }
                });
            });
            
            // أزرار التعديل
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const postId = this.getAttribute('data-post-id');
                    editPost(postId);
                });
            });
            
            // أزرار الحذف
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const postId = this.getAttribute('data-post-id');
                    deletePost(postId);
                });
            });
        }

        // دالة حذف منشور
        async function deletePost(postId) {
            if (!isLoggedIn || !currentUser) {
                showLoginAlert();
                return;
            }
            
            const result = await Swal.fire({
                icon: 'warning',
                title: 'تأكيد الحذف',
                text: 'هل أنت متأكد من حذف هذا المنشور؟ لا يمكن التراجع عن هذا الإجراء.',
                showCancelButton: true,
                confirmButtonText: 'نعم، احذف',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d'
            });
            
            if (!result.isConfirmed) {
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                
                const response = await axios.delete(
                    `${url}/api/posts/${postId}`,
                    {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    }
                );
                
                if (response.status === 200) {
                    const postElement = document.getElementById(`post-${postId}`);
                    if (postElement) {
                        gsap.to(postElement, {
                            opacity: 0,
                            scale: 0.8,
                            duration: 0.5,
                            ease: 'power2.in',
                            onComplete: () => {
                                postElement.remove();
                                
                                const remainingPosts = document.querySelectorAll('.post-card');
                                if (remainingPosts.length === 0) {
                                    fetchPosts(currentPage);
                                }
                            }
                        });
                    }
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'تم الحذف!',
                        text: 'تم حذف المنشور بنجاح.',
                        timer: 2000,
                        showConfirmButton: false
                    });
                }
            } catch (error) {
                console.error('خطأ في حذف المنشور:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ!',
                    text: 'حدث خطأ أثناء حذف المنشور. يرجى المحاولة مرة أخرى.',
                    confirmButtonText: 'حسناً'
                });
            }
        }

        // دالة تعديل منشور
        async function editPost(postId) {
            if (!isLoggedIn || !currentUser) {
                showLoginAlert();
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                const response = await axios.get(`${url}/api/posts/${postId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const post = response.data;
                
                const { value: formValues } = await Swal.fire({
                    title: 'تعديل المنشور',
                    html: `
                        <div class="edit-post-form">
                            <div class="form-group mb-3">
                                <label for="edit-title" class="form-label text-start d-block">عنوان المنشور (اختياري)</label>
                                <input type="text" id="edit-title" class="form-control" value="${post.title || ''}" placeholder="أدخل عنوان المنشور">
                            </div>
                            <div class="form-group mb-3">
                                <label for="edit-content" class="form-label text-start d-block">محتوى المنشور <span class="text-danger">*</span></label>
                                <textarea id="edit-content" class="form-control" rows="5" placeholder="شارك أفكارك وتجاربك المالية هنا..." required>${post.content}</textarea>
                            </div>
                            <div class="form-group mb-3">
                                <label for="edit-image" class="form-label text-start d-block">صورة جديدة (اختياري)</label>
                                <input type="file" id="edit-image" class="form-control" accept="image/*">
                                <small class="text-muted">اترك فارغاً للاحتفاظ بالصورة الحالية</small>
                            </div>
                        </div>
                    `,
                    focusConfirm: false,
                    showCancelButton: true,
                    confirmButtonText: 'حفظ التعديلات',
                    cancelButtonText: 'إلغاء',
                    confirmButtonColor: '#28a745',
                    cancelButtonColor: '#6c757d',
                    width: '600px',
                    preConfirm: () => {
                        const title = document.getElementById('edit-title').value;
                        const content = document.getElementById('edit-content').value;
                        const imageFile = document.getElementById('edit-image').files[0];
                        
                        if (!content.trim()) {
                            Swal.showValidationMessage('محتوى المنشور مطلوب');
                            return false;
                        }
                        
                        return {
                            title: title.trim(),
                            content: content.trim(),
                            image: imageFile
                        };
                    }
                });
                
                if (formValues) {
                    const formData = new FormData();
                    formData.append('title', formValues.title);
                    formData.append('content', formValues.content);
                    
                    if (formValues.image) {
                        formData.append('image', formValues.image);
                    }
                    
                    const updateResponse = await axios.put(
                        `${url}/api/posts/${postId}`,
                        formData,
                        {
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'multipart/form-data'
                            }
                        }
                    );
                    
                    if (updateResponse.status === 200) {
                        Swal.fire({
                            icon: 'success',
                            title: 'تم التحديث!',
                            text: 'تم تحديث المنشور بنجاح.',
                            timer: 2000,
                            showConfirmButton: false
                        });
                        
                        const sortSelect = document.getElementById('sortPosts');
                        const searchInput = document.getElementById('searchPosts');
                        await fetchPosts(
                            currentPage,
                            sortSelect ? sortSelect.value : 'newest',
                            searchInput ? searchInput.value : ''
                        );
                    }
                }
            } catch (error) {
                console.error('خطأ في تعديل المنشور:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ!',
                    text: 'حدث خطأ أثناء تعديل المنشور. يرجى المحاولة مرة أخرى.',
                    confirmButtonText: 'حسناً'
                });
            }
        }

        // دالة إضافة تعليق
        async function addComment(postId, content, inputElement) {
            if (!isLoggedIn || !currentUser) {
                showLoginAlert();
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                
                const response = await axios.post(
                    `${url}/api/posts/${postId}/comments`,
                    { user: currentUser.username, content },
                    {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    }
                );
                
                if (response.data) {
                    inputElement.value = '';
                    
                    const sortSelect = document.getElementById('sortPosts');
                    const searchInput = document.getElementById('searchPosts');
                    await fetchPosts(
                        currentPage,
                        sortSelect ? sortSelect.value : 'newest',
                        searchInput ? searchInput.value : ''
                    );
                    
                    setTimeout(() => {
                        const commentsContainer = document.getElementById(`comments-${postId}`);
                        if (commentsContainer) {
                            commentsContainer.classList.add('show');
                        }
                    }, 300);
                }
            } catch (error) {
                console.error('خطأ في إضافة التعليق:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ!',
                    text: 'حدث خطأ أثناء إضافة التعليق. يرجى المحاولة مرة أخرى.',
                    confirmButtonText: 'حسناً'
                });
            }
        }

        // دالة إضافة رد فعل (إعجاب)
        async function addReaction(postId, button) {
            if (!isLoggedIn) {
                showLoginAlert();
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                
                const response = await axios.post(
                    `${url}/api/posts/${postId}/reactions`,
                    {},
                    {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    }
                );
                
                if (response.data) {
                    const reactionsElement = button.closest('.post-footer').querySelector('.reactions-count');
                    if (reactionsElement) {
                        const currentCount = parseInt(reactionsElement.textContent);
                        reactionsElement.textContent = currentCount + 1;
                    }
                    
                    button.classList.add('text-primary');
                    gsap.from(button, {
                        scale: 1.5,
                        duration: 0.3,
                        ease: 'power2.out'
                    });
                }
            } catch (error) {
                console.error('خطأ في إضافة الإعجاب:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ!',
                    text: 'حدث خطأ أثناء إضافة الإعجاب. يرجى المحاولة مرة أخرى.',
                    confirmButtonText: 'حسناً'
                });
            }
        }

        // دالة عرض تنبيه تسجيل الدخول
        function showLoginAlert() {
            Swal.fire({
                icon: 'info',
                title: 'تسجيل الدخول مطلوب',
                text: 'يجب تسجيل الدخول للمشاركة في المنتدى.',
                showCancelButton: true,
                confirmButtonText: 'تسجيل الدخول',
                cancelButtonText: 'لاحقاً'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = 'login.html';
                }
            });
        }

        // دالة إنشاء منشور جديد
        async function createNewPost() {
            if (!isLoggedIn || !currentUser) {
                showLoginAlert();
                return;
            }
            
            try {
                const submitButton = document.getElementById('submitPost');
                const originalText = submitButton.innerHTML;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري النشر...';
                submitButton.disabled = true;
                
                const token = localStorage.getItem('token');
                
                const postTitle = document.getElementById('postTitle').value;
                const postContent = document.getElementById('postContent').value;
                const postImage = document.getElementById('postImage').files[0];
                
                if (!postContent) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'تنبيه!',
                        text: 'يجب إدخال محتوى المنشور.',
                        confirmButtonText: 'حسناً'
                    });
                    submitButton.innerHTML = originalText;
                    submitButton.disabled = false;
                    return;
                }
                
                const postFormData = new FormData();
                if (postTitle) postFormData.append('title', postTitle);
                postFormData.append('content', postContent);
                if (postImage) postFormData.append('image', postImage);
                
                postFormData.append('user[username]', currentUser.username);
                postFormData.append('user[profileImage]', currentUser.profileImage || '');
                
                const response = await axios.post(
                    `${url}/api/posts`,
                    postFormData,
                    {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'multipart/form-data'
                        }
                    }
                );
                
                if (response.data) {
                    document.getElementById('postForm').reset();
                    document.getElementById('fileName').textContent = 'لم يتم اختيار ملف';
                    document.getElementById('previewContainer').style.display = 'none';
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'تم!',
                        text: 'تم نشر المنشور بنجاح.',
                        confirmButtonText: 'حسناً'
                    });
                    
                    await fetchPosts(1, 'newest');
                }
            } catch (error) {
                console.error('خطأ في إنشاء المنشور:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ!',
                    text: 'حدث خطأ أثناء نشر المنشور. يرجى المحاولة مرة أخرى.',
                    confirmButtonText: 'حسناً'
                });
            } finally {
                const submitButton = document.getElementById('submitPost');
                submitButton.innerHTML = '<i class="fas fa-paper-plane ms-2"></i> نشر';
                submitButton.disabled = false;
            }
        }

        // دالة التركيز على نموذج إنشاء المنشور
        function focusOnPostForm() {
            const postContent = document.getElementById('postContent');
            if (postContent) {
                postContent.scrollIntoView({ behavior: 'smooth', block: 'start' });
                setTimeout(() => {
                    postContent.focus();
                }, 500);
            }
        }

        // دالة تنفيذ تأثيرات ظهور المنشورات
        function animatePostsAppearance() {
            gsap.from('.post-card', {
                y: 50,
                opacity: 0,
                stagger: 0.1,
                duration: 0.5,
                ease: 'power2.out'
            });
        }

        // إعداد مستمعي الأحداث لنموذج المنشور
        function setupPostForm() {
            const postImage = document.getElementById('postImage');
            const fileName = document.getElementById('fileName');
            const previewContainer = document.getElementById('previewContainer');
            const previewImage = document.getElementById('previewImage');
            
            postImage.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    const file = this.files[0];
                    fileName.textContent = file.name;
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        previewImage.src = e.target.result;
                        previewContainer.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                } else {
                    fileName.textContent = 'لم يتم اختيار ملف';
                    previewContainer.style.display = 'none';
                }
            });
            
            const removeImage = document.getElementById('removeImage');
            removeImage.addEventListener('click', function() {
                postImage.value = '';
                fileName.textContent = 'لم يتم اختيار ملف';
                previewContainer.style.display = 'none';
            });
            
            const postForm = document.getElementById('postForm');
            postForm.addEventListener('submit', function(e) {
                e.preventDefault();
                createNewPost();
            });
        }

        // إعداد مستمعي الأحداث للفلاتر والبحث
        function setupFilters() {
            const sortSelect = document.getElementById('sortPosts');
            sortSelect.addEventListener('change', function() {
                fetchPosts(1, this.value, document.getElementById('searchPosts').value);
            });
            
            const searchButton = document.getElementById('searchButton');
            searchButton.addEventListener('click', function() {
                const searchValue = document.getElementById('searchPosts').value;
                fetchPosts(1, document.getElementById('sortPosts').value, searchValue);
            });
            
            const searchInput = document.getElementById('searchPosts');
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    fetchPosts(1, document.getElementById('sortPosts').value, this.value);
                }
            });
        }

        // تهيئة الصفحة عند التحميل
        window.addEventListener('DOMContentLoaded', async function() {
            await checkLoginStatus();
            await fetchPosts();
            setupPostForm();
            setupFilters();
        });

        // زر الذهاب إلى الأعلى
        const scrollToTopBtn = document.getElementById("scrollToTopBtn");

        window.onscroll = function() {
            if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                scrollToTopBtn.style.opacity = "1";
                scrollToTopBtn.style.visibility = "visible";
            } else {
                scrollToTopBtn.style.opacity = "0";
                scrollToTopBtn.style.visibility = "hidden";
            }
        };

        scrollToTopBtn.addEventListener('click', function() {
            const postForm = document.getElementById('postContent');
            if (postForm) {
                postForm.scrollIntoView({
                    behavior: "smooth",
                    block: "start"
                });
                postForm.focus();
            }
            window.scrollTo({
                top: 0,
                behavior: "smooth"
            });
        });
    </script>
</body>
</html>